{% extends "base.html" %}

{% block content %}
<div class="flex h-screen bg-gray-50 overflow-hidden font-inter">
    <!-- 侧边栏 -->
    <aside
        class="w-60 bg-white border-r border-gray-200 flex flex-col flex-shrink-0 z-20 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
        <!-- Logo -->
        <div class="h-14 flex items-center px-5 border-b border-gray-100 flex-shrink-0">
            <div
                class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center shadow-indigo-100 shadow-lg mr-3">
                <i data-lucide="database" class="w-4 h-4 text-white"></i>
            </div>
            <span class="text-sm font-bold text-gray-800 tracking-tight">DataMap</span>
        </div>

        <!-- 导航 -->
        <nav class="flex-1 overflow-y-auto py-4 px-3 custom-scrollbar">
            <div class="mb-6">
                <div class="px-3 mb-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider">资源</div>
                <ul class="space-y-0.5" id="module-nav">
                    {% for item in [
                    {'id': 'overview', 'icon': 'layout-dashboard', 'label': '概览'},
                    {'id': 'databases', 'icon': 'database', 'label': '数据库'},
                    {'id': 'tables', 'icon': 'table-2', 'label': '数据表'},
                    {'id': 'fields', 'icon': 'columns', 'label': '字段字典'},
                    {'id': 'metrics', 'icon': 'function-square', 'label': '指标库'},
                    {'id': 'datasources', 'icon': 'layers', 'label': '数据源'},
                    {'id': 'workbooks', 'icon': 'book-open', 'label': '工作簿'}
                    ] %}
                    <li class="nav-item group" onclick="switchModule('{{ item.id }}')">
                        <div
                            class="flex items-center px-3 py-2 rounded-md text-[13px] font-medium text-gray-600 cursor-pointer transition-all hover:bg-gray-50 group-[.active]:bg-indigo-50 group-[.active]:text-indigo-600">
                            <i data-lucide="{{ item.icon }}"
                                class="w-4 h-4 mr-3 opacity-70 group-[.active]:opacity-100"></i>
                            <span class="flex-1">{{ item.label }}</span>
                            {% if item.id != 'overview' %}
                            <span
                                class="text-[10px] font-normal text-gray-400 group-[.active]:text-indigo-400 bg-gray-100 group-[.active]:bg-white px-1.5 py-0.5 rounded-full min-w-[20px] text-center transition-colors"
                                id="count-{{ item.id }}">0</span>
                            {% endif %}
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- 动态筛选 -->
            <div id="filter-section" class="display-none">
                <div class="px-3 mb-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider">筛选</div>
                <div id="dynamic-filters" class="px-3 space-y-4"></div>
            </div>
        </nav>

        <!-- 用户 -->
        <div class="p-4 border-t border-gray-100 flex items-center gap-3">
            <div
                class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold border border-indigo-200">
                W</div>
            <div class="flex-1 min-w-0">
                <div class="text-[12px] font-medium text-gray-700 truncate">Admin User</div>
                <div class="text-[10px] text-gray-400 truncate">admin@company.com</div>
            </div>
        </div>
    </aside>

    <!-- 主区域 -->
    <div class="flex-1 flex flex-col min-w-0 bg-white">
        <!-- 顶栏 -->
        <header
            class="h-14 border-b border-gray-200 flex items-center justify-between px-6 bg-white flex-shrink-0 z-10">
            <!-- 搜索 -->
            <div class="relative w-96">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                <input type="text" id="global-search"
                    class="w-full pl-9 pr-4 py-1.5 text-[13px] bg-gray-50 border-0 rounded-md focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:shadow-sm transition-all placeholder:text-gray-400"
                    placeholder="全站搜索 (Cmd+K)" onkeyup="handleSearch(event)">
            </div>
            <div class="flex items-center gap-3">
                <button class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-50 rounded-md transition-colors"><i
                        data-lucide="bell" class="w-4 h-4"></i></button>
                <button class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-50 rounded-md transition-colors"><i
                        data-lucide="help-circle" class="w-4 h-4"></i></button>
            </div>
        </header>

        <!-- 内容滚动区 -->
        <main class="flex-1 overflow-auto p-6 scroll-smooth" id="main-content">
            <!-- 内容由 JS 渲染 -->
        </main>
    </div>
</div>

<!-- 详情抽屉 (Overlay) -->
<div id="overlay"
    class="fixed inset-0 bg-gray-900/10 backdrop-blur-[1px] z-40 opacity-0 pointer-events-none transition-opacity duration-200"
    onclick="closeDrawer()"></div>
<div id="detail-drawer"
    class="fixed inset-y-0 right-0 w-[600px] bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-out border-l border-gray-100 flex flex-col">
    <div class="flex items-center justify-between px-6 h-14 border-b border-gray-100 flex-shrink-0 bg-white">
        <h2 id="drawer-title" class="text-base font-semibold text-gray-800 truncate pr-4">详情</h2>
        <button onclick="closeDrawer()"
            class="p-1.5 rounded-md hover:bg-gray-50 text-gray-400 hover:text-gray-600 transition-colors">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
    </div>
    <div id="drawer-content" class="flex-1 overflow-y-auto p-6 bg-gray-50/50"></div>
</div>

<style>
    /* === 基础设置 === */
    body {
        font-family: 'Inter', system-ui, sans-serif;
        -webkit-font-smoothing: antialiased;
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #e2e8f0;
        border-radius: 4px;
    }

    .custom-scrollbar:hover::-webkit-scrollbar-thumb {
        background: #cbd5e1;
    }

    /* === 页面头部 === */
    .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .page-header h1 {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        letter-spacing: -0.02em;
    }

    .page-header .count {
        margin-left: 8px;
        font-size: 12px;
        color: #94a3b8;
        background: #f1f5f9;
        padding: 2px 8px;
        border-radius: 12px;
    }

    /* === 排序按钮 === */
    .sort-bar {
        display: flex;
        gap: 6px;
    }

    .sort-btn {
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
        color: #64748b;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
        font-weight: 500;
    }

    .sort-btn:hover {
        border-color: #cbd5e1;
        color: #334155;
    }

    .sort-btn.active {
        background: #eef2ff;
        color: #4f46e5;
        border-color: #c7d2fe;
    }

    /* === 密集数据表格 === */
    .data-table {
        width: 100%;
        border-spacing: 0;
        border-collapse: collapse;
        font-size: 13px;
        table-layout: fixed;
    }

    .data-table th {
        text-align: left;
        padding: 10px 12px;
        font-weight: 500;
        color: #64748b;
        font-size: 11px;
        text-transform: uppercase;
        border-bottom: 1px solid #e2e8f0;
        background: #ffffff;
        position: sticky;
        top: 0;
        z-index: 10;
        letter-spacing: 0.02em;
    }

    .data-table td {
        padding: 8px 12px;
        border-bottom: 1px solid #f1f5f9;
        color: #334155;
        vertical-align: middle;
        height: 40px;
    }

    .data-table tr:hover td {
        background: #f8fafc;
        cursor: pointer;
    }

    .data-table tr:last-child td {
        border-bottom: none;
    }

    /* 表格列宽控制 */
    .data-table td .cell-main {
        display: flex;
        align-items: center;
        gap: 10px;
        overflow: hidden;
    }

    .data-table .name {
        font-weight: 500;
        color: #1e293b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .data-table .icon {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
    }

    .data-table .muted {
        color: #94a3b8;
        font-size: 12px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .data-table .num {
        font-family: 'JetBrains Mono', 'Menlo', monospace;
        font-size: 12px;
        color: #64748b;
    }

    .data-table .formula code {
        background: #f1f5f9;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 11px;
        color: #475569;
        display: inline-block;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* === 图标颜色 === */
    .icon.db {
        color: #2563eb;
    }

    .icon.tbl {
        color: #7c3aed;
    }

    .icon.metric {
        color: #d97706;
    }

    .icon.ds {
        color: #059669;
    }

    .icon.wb {
        color: #e11d48;
    }

    /* === 标签样式 === */
    .tag {
        display: inline-flex;
        align-items: center;
        padding: 0 6px;
        height: 20px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
        white-space: nowrap;
        border: 1px solid transparent;
    }

    .tag.measure {
        background: #ecfdf5;
        color: #047857;
    }

    .tag.dim {
        background: #eff6ff;
        color: #1d4ed8;
    }

    .tag.warn {
        background: #fffbeb;
        color: #b45309;
        border-color: #fcd34d;
    }

    .tag.error {
        background: #fef2f2;
        color: #b91c1c;
        border-color: #fecaca;
    }

    .tag.calc {
        background: #f5f3ff;
        color: #6d28d9;
        border-color: #ddd6fe;
    }

    .tag.live {
        background: #f0f9ff;
        color: #0369a1;
        border-color: #bae6fd;
    }

    .tag.extract {
        background: #fff7ed;
        color: #c2410c;
        border-color: #ffedd5;
    }

    .tag.schema {
        background: #f1f5f9;
        color: #475569;
        border: 1px solid #e2e8f0;
    }

    /* === 状态点 === */
    .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .dot.measure {
        background: #10b981;
    }

    .dot.dim {
        background: #3b82f6;
    }

    .status {
        font-size: 10px;
    }

    .status.ok {
        color: #22c55e;
    }

    .status.warn {
        color: #f59e0b;
    }

    /* === 概览 Bento Grid === */
    .overview-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-top: 16px;
    }

    .card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        display: flex;
        flex-direction: column;
    }

    .card .label {
        font-size: 11px;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 8px;
        letter-spacing: 0.03em;
    }

    .card.score {
        grid-column: span 1;
    }

    .card.score .value {
        font-size: 42px;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 8px;
        letter-spacing: -0.02em;
    }

    .card.score.good .value {
        color: #16a34a;
    }

    .card.score.warn .value {
        color: #d97706;
    }

    .card.score.bad .value {
        color: #dc2626;
    }

    .card.score .bar {
        height: 6px;
        background: #f1f5f9;
        border-radius: 3px;
        overflow: hidden;
    }

    .card.score .bar div {
        height: 100%;
        border-radius: 3px;
        background: currentColor;
    }

    /* 继承 value 颜色 */

    .card.issues {
        grid-column: span 1;
    }

    .issue-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid #f8fafc;
        font-size: 12px;
        color: #475569;
    }

    .issue-row:last-child {
        border-bottom: none;
    }

    .issue-row span.bad {
        color: #dc2626;
        font-weight: 600;
        background: #fef2f2;
        padding: 1px 6px;
        border-radius: 4px;
    }

    .issue-row span.warn {
        color: #d97706;
        font-weight: 600;
        background: #fffbeb;
        padding: 1px 6px;
        border-radius: 4px;
    }

    .issue-row span.info {
        color: #2563eb;
        font-weight: 600;
        background: #eff6ff;
        padding: 1px 6px;
        border-radius: 4px;
    }

    .card.stats {
        grid-column: span 2;
    }

    .stat-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin-top: auto;
    }

    .stat-grid div {
        text-align: center;
        border: 1px solid #f1f5f9;
        padding: 10px;
        border-radius: 6px;
        background: #f8fafc;
    }

    .stat-grid div .num {
        display: block;
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 2px;
    }

    .stat-grid div span:last-child {
        font-size: 10px;
        color: #64748b;
    }

    .stat-grid .total {
        background: #eef2ff;
        border-color: #e0e7ff;
    }

    .stat-grid .total .num {
        color: #4f46e5;
    }

    .card.hotlist {
        grid-column: span 4;
        overflow: hidden;
    }

    .mini-table {
        width: 100%;
        font-size: 12px;
        border-collapse: collapse;
    }

    .mini-table th {
        text-align: left;
        padding: 8px 12px;
        color: #94a3b8;
        font-weight: 500;
        font-size: 11px;
        border-bottom: 1px solid #f1f5f9;
    }

    .mini-table td {
        padding: 8px 12px;
        border-bottom: 1px solid #f8fafc;
        color: #334155;
    }

    .mini-table tr:hover td {
        background: #f8fafc;
    }

    /* === Facet筛选 === */
    .facet-group {
        margin-bottom: 20px;
    }

    .facet-title {
        font-size: 11px;
        font-weight: 600;
        color: #94a3b8;
        margin-bottom: 8px;
        text-transform: uppercase;
    }

    .facet-item {
        display: flex;
        align-items: center;
        font-size: 12px;
        color: #475569;
        padding: 3px 0;
        cursor: pointer;
        transition: color 0.15s;
    }

    .facet-item:hover {
        color: #1e293b;
    }

    .facet-item input {
        margin-right: 8px;
        border-color: #cbd5e1;
        color: #4f46e5;
        border-radius: 3px;
        width: 14px;
        height: 14px;
    }

    .facet-item .cnt {
        margin-left: auto;
        font-size: 10px;
        color: #cbd5e1;
    }

    .facet-item:hover .cnt {
        color: #94a3b8;
    }

    /* === 抽屉样式 === */
    #detail-drawer.open {
        transform: translateX(0);
    }

    #overlay.active {
        opacity: 1;
        pointer-events: auto;
    }

    .detail-section {
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 11px;
        font-weight: 600;
        color: #94a3b8;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .props {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1px;
        background: #e2e8f0;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        overflow: hidden;
    }

    .prop {
        display: flex;
        background: white;
        padding: 10px 12px;
        font-size: 13px;
    }

    .prop .key {
        width: 100px;
        color: #64748b;
        font-weight: 500;
        flex-shrink: 0;
    }

    .prop .val {
        color: #1e293b;
        flex-grow: 1;
        word-break: break-all;
    }

    .detail-section.warn .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .detail-section.error .dup-list div {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 4px;
        margin-bottom: 4px;
        font-size: 12px;
        color: #991b1b;
    }
</style>
{% endblock %}