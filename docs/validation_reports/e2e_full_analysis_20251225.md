# E2E 全链路验证分析报告 (2025-12-25)

## 1. 验证摘要

| 验证类别         |  状态  | 通过率 | 核心发现                                                 |
| :--------------- | :----: | :----: | :------------------------------------------------------- |
| **核心指标对齐** | ✅ 通过 |  100%  | API `stats` 与物理数据库完全一致 (20,231 字段)           |
| **四表架构迁移** | ✅ 通过 |  100%  | 成功区分原始实例与去重标准项 (15,296 实例 -> 5,987 标准) |
| **血缘质量检测** | ⚠️ 警告 |  92%   | 存在少量孤儿视图 (64) 和断链指标 (3)，属于环境残留       |
| **前后端对齐**   | ⚠️ 警告 |  85%   | 列表页指标对齐良好；详情页部分 Tab 映射逻辑需优化        |

---

## 2. 深度问题分析

### 2.1 API 响应延迟/缓存问题 (已修复)
- **发现情况**: 初始验证发现 API 返回的字段数 (5k) 远低于数据库物理数 (20k)。
- **根因分析**: Flask 进程在数据库重建后未重启，一直持有旧文件的 Inode，导致读取的是已“删除”的旧版数据。
- **解决方案**: 手动杀进程并重启后端服务。重启后 API `stats` 恢复正常。

### 2.2 字段去重逻辑修正 (已修复)
- **发现情况**: 之前同步阶段过早进行了去重，导致大量字段未入库。
- **重构内容**: 彻底去除了同步阶段的去重逻辑，所有 Tableau 字段均入 `fields` 表；去重剥离到专用的 `regular_fields` 和 `calculated_fields` 迁移步骤中。
- **效果**: 字段覆盖量从 7,918 提升至 20,231。

### 2.3 验证 JSON 架构错误 (已修复)
- **问题**: `published_datasources.json` 引用了不存在的 `type` 列；`workbooks.json` 引用了旧的 `project_id` 而非 `project_name`。
- **修复**: 更新了相关 SQL 语句，确保与当前 SQLite 架构适配。

### 2.4 详情页 (L2) 映射不一致 (待优化)
- **发现情况**: `e2e_data_runner.py` 在执行详情页测试时，部分 Tab (如“所属数据库”) 出现 `DIFF`。
- **原因**:
    1. API 返回的键名与验证 JSON 中定义的期望键名不匹配。
    2. 部分详情 API 仍采用旧的扁平化 `fields` 表查询，尚未完全切换到 `regular_fields` 关联。
- **建议**: 在后续迭代中，将详情页 API 统一切换至四表架构。

---

## 3. 核心数据指标 (Final)

| 指标                          | 数据库 (SQL) | API (JSON) | 状态  |
| :---------------------------- | :----------- | :--------- | :---: |
| 总字段数 (Fields)             | 20,231       | 20,231     |   ✅   |
| 标准核心字段 (Unique Fields)  | 5,987        | 5,987      |   ✅   |
| 计算字段实例 (Metrics)        | 4,935        | 4,935      |   ✅   |
| 标准核心指标 (Unique Metrics) | 1,703        | 1,703      |   ✅   |
| 字段-视图关系数               | 17,757       | 17,757     |   ✅   |

---

## 4. 下一步行动计划

1. **API 升级**: 将 `get_field_detail` 和 `get_metric_detail` API 内部逻辑完全重构，直接查 `unique_regular_fields` 和相关血缘表。
2. **热度统计**: 定期运行 `calculate_stats` 确保卡片上的 `usage_count` 保持最新。
3. **监控系统**: 建立长期 E2E 自动运行机制，防止未来改动破坏核心指标闭环。

---
**执行人**: Antigravity (AI Assistant)
**时间**: 2025-12-25 14:15
