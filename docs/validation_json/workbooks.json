{
    "工作簿": {
        "任务描述": "验证工作簿模块的核心指标、血缘关联及数据质量",
        "显示名称": "工作簿",
        "模块定义": {
            "数据库表": "workbooks",
            "主键": "id"
        },
        "核心属性验证": {
            "任务描述": "验证工作簿的基础属性统计",
            "资产总数": {
                "任务描述": "统计工作簿总记录数",
                "API路径": "/api/stats",
                "API取值键": "workbooks",
                "API实际结果": "",
                "SQL查询": "SELECT COUNT(*) FROM workbooks",
                "SQL实际结果": ""
            },
            "项目分布 (枚举)": {
                "任务描述": "验证工作簿按项目的分布情况",
                "字段名": "project_name",
                "SQL查询": "SELECT project_name || ':' || COUNT(*) FROM workbooks GROUP BY project_name",
                "SQL实际分布": ""
            }
        },
        "血缘质量检测": {
            "任务描述": "检测字段空值率及血缘未匹配情况",
            "关键字段空值检测": [
                {
                    "字段名": "project_name",
                    "任务描述": "检测没有所属项目的工作簿数量",
                    "SQL查询": "SELECT COUNT(*) FROM workbooks WHERE project_name IS NULL",
                    "SQL实际结果": ""
                }
            ],
            "未匹配血缘检测": [
                {
                    "关联方向": "工作簿->数据源",
                    "任务描述": "检测没有关联任何数据源的工作簿（孤儿簿）",
                    "SQL查询": "SELECT COUNT(*) FROM workbooks w WHERE NOT EXISTS (SELECT 1 FROM datasource_to_workbook dw WHERE dw.workbook_id = w.id)",
                    "SQL实际结果": ""
                },
                {
                    "关联方向": "工作簿->视图",
                    "任务描述": "检测没有任何视图的工作簿（空工作簿）",
                    "SQL查询": "SELECT COUNT(*) FROM workbooks w WHERE NOT EXISTS (SELECT 1 FROM views v WHERE v.workbook_id = w.id)",
                    "SQL实际结果": ""
                }
            ]
        },
        "关联元素": [
            {
                "目标模块": "数据库",
                "任务描述": "验证工作簿穿透到数据库的 M:N 关系",
                "关联方式": "工作簿 > 数据源 > 物理表 > 数据库 (穿透关联)",
                "关联验证": {
                    "正向SQL (工作簿>数据库)": "SELECT COUNT(DISTINCT w.id) || ':' || COUNT(DISTINCT t.database_id) FROM workbooks w JOIN datasource_to_workbook dw ON w.id = dw.workbook_id JOIN table_to_datasource td ON dw.datasource_id = td.datasource_id JOIN tables t ON td.table_id = t.id WHERE t.is_embedded = 0",
                    "正向SQL结果": "",
                    "反向SQL (数据库>工作簿)": "SELECT COUNT(DISTINCT t.database_id) || ':' || COUNT(DISTINCT w.id) FROM databases d JOIN tables t ON d.id = t.database_id JOIN table_to_datasource td ON t.id = td.table_id JOIN datasource_to_workbook dw ON td.datasource_id = dw.datasource_id JOIN workbooks w ON dw.workbook_id = w.id WHERE t.is_embedded = 0",
                    "反向SQL结果": "",
                    "API路径": "无 (穿透关系)",
                    "API实际结果": "N/A"
                }
            },
            {
                "目标模块": "数据源",
                "任务描述": "验证工作簿与数据源的 M:N 引用关系",
                "关联方式": "工作簿 > 中间表(datasource_to_workbook) > 数据源",
                "关联验证": {
                    "正向SQL (工作簿>数据源)": "SELECT COUNT(DISTINCT w.id) || ':' || COUNT(DISTINCT dw.datasource_id) FROM workbooks w JOIN datasource_to_workbook dw ON w.id = dw.workbook_id",
                    "正向SQL结果": "",
                    "反向SQL (数据源>工作簿)": "SELECT COUNT(DISTINCT ds.id) || ':' || COUNT(DISTINCT dw.workbook_id) FROM datasources ds JOIN datasource_to_workbook dw ON ds.id = dw.datasource_id",
                    "反向SQL结果": "",
                    "API路径": "/api/workbooks/{id}",
                    "API取值键": "datasources",
                    "API实际结果": ""
                }
            },
            {
                "目标模块": "视图",
                "任务描述": "验证工作簿与视图的 1:N 包含关系",
                "关联方式": "工作簿 > 视图 (包含的视图)",
                "关联验证": {
                    "正向SQL (工作簿>视图)": "SELECT COUNT(DISTINCT w.id) || ':' || COUNT(DISTINCT v.id) FROM workbooks w JOIN views v ON w.id = v.workbook_id",
                    "正向SQL结果": "",
                    "反向SQL (视图>工作簿)": "SELECT COUNT(DISTINCT v.id) || ':' || COUNT(DISTINCT v.workbook_id) FROM views v",
                    "反向SQL结果": "",
                    "API路径": "/api/workbooks/{id}",
                    "API取值键": "views",
                    "API实际结果": ""
                }
            },
            {
                "目标模块": "字段",
                "任务描述": "验证工作簿使用的字段 M:N 关系",
                "关联方式": "工作簿 > 字段 (使用的字段)",
                "关联验证": {
                    "正向SQL (工作簿>字段)": "SELECT COUNT(DISTINCT f.workbook_id) || ':' || COUNT(DISTINCT f.id) FROM fields f WHERE f.workbook_id IS NOT NULL",
                    "正向SQL结果": "",
                    "反向SQL (字段>工作簿)": "SELECT COUNT(DISTINCT f.id) || ':' || COUNT(DISTINCT f.workbook_id) FROM fields f WHERE f.workbook_id IS NOT NULL",
                    "反向SQL结果": "",
                    "API路径": "/api/workbooks/{id}",
                    "API取值键": "used_fields",
                    "API实际结果": ""
                }
            },
            {
                "目标模块": "指标",
                "任务描述": "验证工作簿使用的指标 M:N 关系",
                "关联方式": "工作簿 > 指标 (使用的指标)",
                "关联验证": {
                    "正向SQL (工作簿>指标)": "SELECT COUNT(DISTINCT f.workbook_id) || ':' || COUNT(DISTINCT f.id) FROM fields f WHERE f.workbook_id IS NOT NULL AND f.is_calculated = 1",
                    "正向SQL结果": "",
                    "反向SQL (指标>工作簿)": "SELECT COUNT(DISTINCT f.id) || ':' || COUNT(DISTINCT f.workbook_id) FROM fields f WHERE f.workbook_id IS NOT NULL AND f.is_calculated = 1",
                    "反向SQL结果": "",
                    "API路径": "/api/workbooks/{id}",
                    "API取值键": "used_metrics",
                    "API实际结果": ""
                }
            },
            {
                "目标模块": "物理表",
                "任务描述": "验证工作簿穿透到物理表的 M:N 关系",
                "关联方式": "工作簿 > 数据源 > 物理表 (穿透关联)",
                "关联验证": {
                    "正向SQL (工作簿>物理表)": "SELECT COUNT(DISTINCT w.id) || ':' || COUNT(DISTINCT td.table_id) FROM workbooks w JOIN datasource_to_workbook dw ON w.id = dw.workbook_id JOIN table_to_datasource td ON dw.datasource_id = td.datasource_id JOIN tables t ON td.table_id = t.id WHERE t.is_embedded = 0",
                    "正向SQL结果": "",
                    "反向SQL (物理表>工作簿)": "SELECT COUNT(DISTINCT t.id) || ':' || COUNT(DISTINCT w.id) FROM tables t JOIN table_to_datasource td ON t.id = td.table_id JOIN datasource_to_workbook dw ON td.datasource_id = dw.datasource_id JOIN workbooks w ON dw.workbook_id = w.id WHERE t.is_embedded = 0",
                    "反向SQL结果": "",
                    "API路径": "/api/workbooks/{id}",
                    "API取值键": "tables",
                    "API实际结果": ""
                }
            }
        ],
        "前端元素对齐": {
            "任务描述": "验证前端卡片和详情页数据与后端逻辑的一致性 (参考 frontend_element_spec.md)",
            "列表卡片 (WorkbookCard.tsx)": {
                "任务描述": "验证列表页关键指标显示",
                "字段:view_count": {
                    "任务描述": "验证工作簿卡片上的视图计数汇总",
                    "API键": "view_count / viewCount",
                    "SQL查询": "SELECT SUM(view_count) FROM (SELECT COUNT(*) as view_count FROM views GROUP BY workbook_id)",
                    "API汇总结果": "",
                    "SQL汇总结果": ""
                },
                "字段:datasource_count": {
                    "任务描述": "验证工作簿卡片上的数据源计数汇总",
                    "API键": "datasource_count / datasourceCount",
                    "SQL查询": "SELECT SUM(ds_count) FROM (SELECT COUNT(DISTINCT datasource_id) as ds_count FROM datasource_to_workbook GROUP BY workbook_id)",
                    "API汇总结果": "",
                    "SQL汇总结果": ""
                },
                "字段:field_count": {
                    "任务描述": "验证工作簿卡片上的使用字段计数汇总",
                    "API键": "field_count / fieldCount",
                    "SQL查询": "SELECT SUM(field_count) FROM (SELECT COUNT(*) as field_count FROM fields WHERE workbook_id IS NOT NULL GROUP BY workbook_id)",
                    "API汇总结果": "",
                    "SQL汇总结果": ""
                },
                "字段:metric_count": {
                    "任务描述": "验证工作簿卡片上的使用指标计数汇总",
                    "API键": "metric_count / metricCount",
                    "SQL查询": "SELECT SUM(metric_count) FROM (SELECT COUNT(*) as metric_count FROM fields WHERE workbook_id IS NOT NULL AND is_calculated = 1 GROUP BY workbook_id)",
                    "API汇总结果": "",
                    "SQL汇总结果": ""
                }
            },
            "详情页 (DetailDrawer L302-L325)": {
                "任务描述": "验证详情页各 Tab 页签的数据准确性",
                "Tab:视图/看板 (N)": {
                    "任务描述": "验证工作簿详情页的'视图/看板' Tab",
                    "API路径": "/api/workbooks/{id}/views",
                    "API取值键": "views",
                    "显示条件": "views.length > 0",
                    "API实际记录数": "",
                    "SQL查询": "SELECT COUNT(*) FROM views WHERE workbook_id = ?",
                    "SQL实际记录数": ""
                },
                "Tab:使用数据源 (N)": {
                    "任务描述": "验证工作簿详情页的'使用数据源' Tab",
                    "API路径": "/api/workbooks/{id}/datasources",
                    "API取值键": "datasources",
                    "显示条件": "datasources.length > 0",
                    "API实际记录数": "",
                    "SQL查询": "SELECT COUNT(DISTINCT datasource_id) FROM datasource_to_workbook WHERE workbook_id = ?",
                    "SQL实际记录数": ""
                },
                "Tab:关联数据表 (N)": {
                    "任务描述": "验证工作簿详情页的'关联数据表' Tab",
                    "API路径": "/api/workbooks/{id}/tables",
                    "API取值键": "tables",
                    "显示条件": "tables.length > 0",
                    "API实际记录数": "",
                    "SQL查询": "SELECT COUNT(DISTINCT td.table_id) FROM datasource_to_workbook dw JOIN table_to_datasource td ON dw.datasource_id = td.datasource_id WHERE dw.workbook_id = ?",
                    "SQL实际记录数": ""
                },
                "Tab:使用字段 (N)": {
                    "任务描述": "验证工作簿详情页的'使用字段' Tab",
                    "API路径": "/api/workbooks/{id}/fields",
                    "API取值键": "used_fields",
                    "显示条件": "used_fields.length > 0",
                    "API实际记录数": "",
                    "SQL查询": "SELECT COUNT(*) FROM fields WHERE workbook_id = ?",
                    "SQL实际记录数": ""
                },
                "Tab:使用指标 (N)": {
                    "任务描述": "验证工作簿详情页的'使用指标' Tab",
                    "API路径": "/api/workbooks/{id}/metrics",
                    "API取值键": "used_metrics",
                    "显示条件": "used_metrics.length > 0",
                    "API实际记录数": "",
                    "SQL查询": "SELECT COUNT(*) FROM fields WHERE workbook_id = ? AND is_calculated = 1",
                    "SQL实际记录数": ""
                },
                "Tab:访问统计": {
                    "任务描述": "验证工作簿详情页的'访问统计' Tab",
                    "API路径": "/api/views/{view_id}/usage (聚合所有视图)",
                    "显示条件": "始终显示"
                }
            }
        },
        "逻辑闭环验证": {
            "任务描述": "跨层级比对：验证'前端展示值'与'底层血缘统计值'是否严丝合缝",
            "比对项列表": [
                {
                    "比对名称": "视图数量闭环",
                    "前端数据源": "前端元素对齐.列表卡片.字段:view_count.API汇总结果",
                    "血缘数据源": "关联元素[目标模块='视图'].关联验证.正向SQL结果(提取目标数)",
                    "比对逻辑": "数值相等",
                    "差异容忍度": 0
                },
                {
                    "比对名称": "数据源数量闭环",
                    "前端数据源": "前端元素对齐.列表卡片.字段:datasource_count.API汇总结果",
                    "血缘数据源": "关联元素[目标模块='数据源'].关联验证.正向SQL结果(提取目标数)",
                    "比对逻辑": "数值相等",
                    "差异容忍度": 0
                },
                {
                    "比对名称": "字段数量闭环",
                    "前端数据源": "前端元素对齐.列表卡片.字段:field_count.API汇总结果",
                    "血缘数据源": "关联元素[目标模块='字段'].关联验证.正向SQL结果(提取目标数)",
                    "比对逻辑": "数值相等",
                    "差异容忍度": 0
                }
            ]
        },
        "卡片详情一致性验证": {
            "任务描述": "检测列表卡片显示值与详情页 Tab 显示值是否来自同一数据源",
            "验证项列表": [
                {
                    "一致性检测项": "视图数量 (view_count)",
                    "卡片数据源": {
                        "SQL (模拟卡片逻辑)": "SELECT view_count FROM workbooks WHERE id = :id"
                    },
                    "详情数据源": {
                        "SQL (模拟详情逻辑)": "SELECT COUNT(*) FROM views WHERE workbook_id = :id"
                    },
                    "预期规则": "卡片数据源.SQL结果 = 详情数据源.SQL结果"
                },
                {
                    "一致性检测项": "数据源数量 (datasource_count)",
                    "卡片数据源": {
                        "SQL (模拟卡片逻辑)": "SELECT datasource_count FROM workbooks WHERE id = :id"
                    },
                    "详情数据源": {
                        "SQL (模拟详情逻辑)": "SELECT COUNT(DISTINCT datasource_id) FROM datasource_to_workbook WHERE workbook_id = :id"
                    },
                    "预期规则": "卡片数据源.SQL结果 = 详情数据源.SQL结果"
                }
            ]
        }
    }
}