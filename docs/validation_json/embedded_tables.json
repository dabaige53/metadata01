{
    "嵌入表": {
        "任务描述": "验证嵌入表模块的核心指标、血缘关联及数据质量",
        "显示名称": "嵌入表",
        "模块定义": {
            "数据库表": "tables",
            "过滤条件": "is_embedded = 1",
            "主键": "id",
            "说明": "Excel/CSV/CustomSQL 等嵌入式数据表"
        },
        "核心属性验证": {
            "任务描述": "验证嵌入表的基础属性统计",
            "资产总数": {
                "任务描述": "统计嵌入表总记录数",
                "API路径": "SELECT COUNT(*) FROM tables WHERE is_embedded = 1",
                "API实际结果": "",
                "SQL查询": "SELECT COUNT(*) FROM tables WHERE is_embedded = 1",
                "SQL实际结果": ""
            }
        },
        "血缘质量检测": {
            "任务描述": "根据血缘交叉表4.3(项7-10)检测嵌入表的血缘完整性",
            "血缘交叉表对应项": [
                "7.嵌入表→物理表",
                "8.嵌入表→数据列",
                "9.嵌入表→嵌入源(独立)",
                "10.嵌入表→字段"
            ],
            "关键字段空值检测": [
                {
                    "字段名": "database_id",
                    "任务描述": "检测嵌入表是否有 database_id (通常应为 NULL)",
                    "SQL查询": "SELECT COUNT(*) FROM tables WHERE is_embedded = 1 AND database_id IS NOT NULL",
                    "SQL实际结果": "",
                    "预期说明": "嵌入表通常无 database_id"
                }
            ],
            "血缘覆盖检测": [
                {
                    "检测项": "7.嵌入表→物理表(穿透)",
                    "主口径SQL": "SELECT COUNT(DISTINCT id) FROM tables WHERE is_embedded = 1",
                    "交叉验证SQL": "SELECT COUNT(DISTINCT embed.id) FROM tables embed WHERE embed.is_embedded = 1 AND EXISTS (SELECT 1 FROM tables phys WHERE phys.is_embedded = 0)",
                    "主口径结果": "",
                    "交叉结果": "",
                    "预期规则": "设计说明：嵌入表通过 upstreamTables 穿透到物理表"
                },
                {
                    "检测项": "8.嵌入表→数据列",
                    "主口径SQL": "SELECT COUNT(DISTINCT t.id) FROM tables t WHERE t.is_embedded = 1",
                    "交叉验证SQL": "SELECT COUNT(DISTINCT t.id) FROM tables t WHERE t.is_embedded = 1 AND EXISTS (SELECT 1 FROM db_columns c WHERE c.table_id = t.id)",
                    "主口径结果": "",
                    "交叉结果": "",
                    "预期规则": "cross >= main"
                },
                {
                    "检测项": "9.嵌入表→嵌入源(独立)",
                    "主口径SQL": "SELECT COUNT(DISTINCT t.id) FROM tables t WHERE t.is_embedded = 1",
                    "交叉验证SQL": "SELECT COUNT(DISTINCT td.table_id) FROM table_to_datasource td JOIN tables t ON td.table_id = t.id JOIN datasources ds ON td.datasource_id = ds.id WHERE t.is_embedded = 1 AND ds.is_embedded = 1 AND ds.source_published_datasource_id IS NULL",
                    "主口径结果": "",
                    "交叉结果": "",
                    "预期规则": "cross >= main (嵌入表被独立嵌入源引用)"
                },
                {
                    "检测项": "10.嵌入表→字段",
                    "主口径SQL": "SELECT COUNT(DISTINCT t.id) FROM tables t WHERE t.is_embedded = 1",
                    "交叉验证SQL": "SELECT COUNT(DISTINCT t.id) FROM tables t WHERE t.is_embedded = 1 AND EXISTS (SELECT 1 FROM fields f WHERE f.table_id = t.id)",
                    "主口径结果": "",
                    "交叉结果": "",
                    "预期规则": "cross >= main"
                }
            ],
            "未匹配血缘检测": [
                {
                    "关联方向": "嵌入表->数据源",
                    "任务描述": "检测未被任何数据源引用的嵌入表数量",
                    "SQL查询": "SELECT COUNT(*) FROM tables t WHERE t.is_embedded = 1 AND NOT EXISTS (SELECT 1 FROM table_to_datasource td WHERE td.table_id = t.id)",
                    "SQL实际结果": ""
                },
                {
                    "关联方向": "嵌入表->字段",
                    "任务描述": "检测没有任何字段的嵌入表数量",
                    "SQL查询": "SELECT COUNT(*) FROM tables t WHERE t.is_embedded = 1 AND NOT EXISTS (SELECT 1 FROM fields f WHERE f.table_id = t.id)",
                    "SQL实际结果": ""
                }
            ]
        },
        "关联元素": [
            {
                "目标模块": "物理表",
                "任务描述": "验证嵌入表穿透到物理表的关系",
                "关联方式": "嵌入表 > upstreamTables > 物理表 (穿透)",
                "血缘交叉表项": "项7",
                "关联验证": {
                    "正向SQL (嵌入表>物理表)": "SELECT COUNT(DISTINCT embed.id) || ':' || COUNT(DISTINCT phys.id) FROM tables embed, tables phys WHERE embed.is_embedded = 1 AND phys.is_embedded = 0",
                    "正向SQL结果": "",
                    "说明": "穿透关系需通过 upstream 元数据追溯，此处为估算"
                }
            },
            {
                "目标模块": "数据列",
                "任务描述": "验证嵌入表与数据列的 1:N 包含关系",
                "关联方式": "嵌入表 > 数据列 (包含的列)",
                "血缘交叉表项": "项8",
                "关联验证": {
                    "正向SQL (嵌入表>列)": "SELECT COUNT(DISTINCT t.id) || ':' || COUNT(DISTINCT c.id) FROM tables t JOIN db_columns c ON t.id = c.table_id WHERE t.is_embedded = 1",
                    "正向SQL结果": "",
                    "反向SQL (列>嵌入表)": "SELECT COUNT(DISTINCT c.id) || ':' || COUNT(DISTINCT c.table_id) FROM db_columns c JOIN tables t ON c.table_id = t.id WHERE t.is_embedded = 1",
                    "反向SQL结果": ""
                }
            },
            {
                "目标模块": "嵌入式数据源(独立)",
                "任务描述": "验证嵌入表被独立嵌入式数据源引用的 M:N 关系",
                "关联方式": "嵌入表 > 中间表(table_to_datasource) > 嵌入式数据源(独立)",
                "血缘交叉表项": "项9",
                "关联验证": {
                    "正向SQL (嵌入表>独立嵌入源)": "SELECT COUNT(DISTINCT td.table_id) || ':' || COUNT(DISTINCT td.datasource_id) FROM table_to_datasource td JOIN tables t ON td.table_id = t.id JOIN datasources ds ON td.datasource_id = ds.id WHERE t.is_embedded = 1 AND ds.is_embedded = 1 AND ds.source_published_datasource_id IS NULL",
                    "正向SQL结果": "",
                    "反向SQL (独立嵌入源>嵌入表)": "SELECT COUNT(DISTINCT ds.id) || ':' || COUNT(DISTINCT td.table_id) FROM datasources ds JOIN table_to_datasource td ON ds.id = td.datasource_id JOIN tables t ON td.table_id = t.id WHERE ds.is_embedded = 1 AND ds.source_published_datasource_id IS NULL AND t.is_embedded = 1",
                    "反向SQL结果": ""
                }
            },
            {
                "目标模块": "字段",
                "任务描述": "验证嵌入表与字段的 1:N 关联关系",
                "关联方式": "嵌入表 > 字段 (派生的字段)",
                "血缘交叉表项": "项10",
                "关联验证": {
                    "正向SQL (嵌入表>字段)": "SELECT COUNT(DISTINCT t.id) || ':' || COUNT(DISTINCT f.id) FROM tables t JOIN fields f ON t.id = f.table_id WHERE t.is_embedded = 1",
                    "正向SQL结果": "",
                    "反向SQL (字段>嵌入表)": "SELECT COUNT(DISTINCT f.id) || ':' || COUNT(DISTINCT f.table_id) FROM fields f JOIN tables t ON f.table_id = t.id WHERE t.is_embedded = 1",
                    "反向SQL结果": ""
                }
            }
        ],
        "前端元素对齐": {
            "任务描述": "嵌入表使用 TableCard.tsx 组件，需验证 isEmbedded 标识",
            "列表卡片 (TableCard.tsx)": {
                "字段:is_embedded": {
                    "任务描述": "验证嵌入表卡片上显示'嵌入式'徽章",
                    "API键": "is_embedded / isEmbedded",
                    "验证逻辑": "嵌入表记录 is_embedded = 1"
                }
            }
        },
        "逻辑闭环验证": {
            "任务描述": "验证血缘交叉表项7-10的一致性",
            "比对项列表": [
                {
                    "比对名称": "数据列覆盖闭环",
                    "前端数据源": "血缘质量检测.血缘覆盖检测[项8].主口径结果",
                    "血缘数据源": "血缘质量检测.血缘覆盖检测[项8].交叉结果",
                    "比对逻辑": "cross >= main",
                    "差异容忍度": 0
                }
            ]
        },
        "卡片详情一致性验证": {
            "任务描述": "检测列表卡片显示值与详情页 Tab 显示值是否来自同一数据源",
            "修复历史": [
                {
                    "修复日期": "2025-12-25",
                    "修复描述": "修复嵌入式表的字段统计不一致问题，增加间接关联字段（通过 upstream_column_id）的统计",
                    "涉及文件": [
                        "backend/routes/tables.py:172-196 (列表API字段统计SQL)",
                        "backend/routes/tables.py:248-292 (详情API字段查询逻辑)"
                    ],
                    "根本原因": "嵌入式表的字段通过 upstream_column_id 间接关联到物理表，原代码只查询了直接关联的字段"
                }
            ],
            "验证项列表": [
                {
                    "一致性检测项": "列数量 (column_count)",
                    "卡片数据源": {
                        "SQL (模拟卡片逻辑)": "SELECT column_count FROM tables WHERE id = :id AND is_embedded = 1"
                    },
                    "详情数据源": {
                        "SQL (模拟详情逻辑)": "SELECT COUNT(*) FROM db_columns WHERE table_id = :id"
                    },
                    "预期规则": "卡片数据源.SQL结果 = 详情数据源.SQL结果"
                },
                {
                    "一致性检测项": "字段数量 (field_count)",
                    "问题描述": "嵌入式表的字段关联方式复杂，需要合并多种关联路径",
                    "卡片数据源": {
                        "说明": "列表API使用预计算的字段统计（合并直接关联和间接关联）",
                        "SQL (模拟卡片逻辑)": "SELECT COUNT(DISTINCT t.field_id) FROM (SELECT td.table_id, f.id as field_id FROM table_to_datasource td JOIN fields f ON td.datasource_id = f.datasource_id WHERE td.table_id = :id UNION SELECT c.table_id, f.id as field_id FROM db_columns c JOIN fields f ON c.id = f.upstream_column_id WHERE c.table_id = :id AND f.table_id IS NULL) t",
                        "关联路径": [
                            "方式1: table_to_datasource -> fields (通过数据源)",
                            "方式2: db_columns -> fields.upstream_column_id (间接关联)"
                        ]
                    },
                    "详情数据源": {
                        "说明": "详情API需要合并所有来源的字段（直接、间接、数据源）",
                        "SQL (模拟详情逻辑)": "SELECT COUNT(DISTINCT f.id) FROM (SELECT id FROM fields WHERE table_id = :id UNION SELECT f.id FROM fields f JOIN db_columns c ON f.upstream_column_id = c.id WHERE c.table_id = :id AND f.table_id IS NULL UNION SELECT f.id FROM fields f JOIN table_to_datasource td ON f.datasource_id = td.datasource_id WHERE td.table_id = :id) f",
                        "关联路径": [
                            "方式1: fields.table_id (直接关联)",
                            "方式2: db_columns -> fields.upstream_column_id (间接关联)",
                            "方式3: table_to_datasource -> fields.datasource_id (数据源字段)"
                        ]
                    },
                    "预期规则": "卡片数据源.SQL结果 = 详情数据源.SQL结果",
                    "实际验证结果": {
                        "测试表ID": "014a8d36-f685-72ce-e48f-5d54b69c418f",
                        "测试表名": "机场三字代码表",
                        "卡片字段数": 218,
                        "详情字段数": 218,
                        "验证状态": "✅ 一致"
                    }
                },
                {
                    "一致性检测项": "度量字段数 (measure_count)",
                    "说明": "仅用于卡片预览显示，不在详情页单独展示",
                    "卡片数据源": {
                        "SQL (模拟卡片逻辑)": "SELECT COUNT(DISTINCT CASE WHEN f.role = 'measure' THEN t.field_id END) FROM (SELECT td.table_id, f.id as field_id FROM table_to_datasource td JOIN fields f ON td.datasource_id = f.datasource_id WHERE td.table_id = :id UNION SELECT c.table_id, f.id as field_id FROM db_columns c JOIN fields f ON c.id = f.upstream_column_id WHERE c.table_id = :id AND f.table_id IS NULL) t JOIN fields f ON t.field_id = f.id"
                    },
                    "预期规则": "用于卡片预览文案：'度量字段 (N个)'"
                },
                {
                    "一致性检测项": "维度字段数 (dimension_count)",
                    "说明": "仅用于卡片预览显示，不在详情页单独展示",
                    "卡片数据源": {
                        "SQL (模拟卡片逻辑)": "SELECT COUNT(DISTINCT CASE WHEN f.role != 'measure' THEN t.field_id END) FROM (SELECT td.table_id, f.id as field_id FROM table_to_datasource td JOIN fields f ON td.datasource_id = f.datasource_id WHERE td.table_id = :id UNION SELECT c.table_id, f.id as field_id FROM db_columns c JOIN fields f ON c.id = f.upstream_column_id WHERE c.table_id = :id AND f.table_id IS NULL) t JOIN fields f ON t.field_id = f.id"
                    },
                    "预期规则": "用于卡片预览文案：'维度字段 (N个)'"
                }
            ]
        }
    }
}