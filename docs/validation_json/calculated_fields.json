{
    "计算字段": {
        "任务描述": "验证计算字段模块的核心指标、血缘关联及数据质量",
        "显示名称": "计算字段",
        "模块定义": {
            "数据库表": "fields",
            "过滤条件": "is_calculated = 1",
            "主键": "id",
            "辅助表": "calculated_fields (公式详情), field_dependencies (依赖关系)"
        },
        "核心属性验证": {
            "任务描述": "验证计算字段的基础属性统计",
            "资产总数": {
                "任务描述": "统计计算字段总记录数",
                "API路径": "/api/stats",
                "API取值键": "metrics",
                "API实际结果": "",
                "SQL查询": "SELECT COUNT(*) FROM fields WHERE is_calculated = 1",
                "SQL实际结果": ""
            },
            "公式详情数": {
                "任务描述": "统计 calculated_fields 表记录数",
                "SQL查询": "SELECT COUNT(*) FROM calculated_fields",
                "SQL实际结果": ""
            },
            "依赖关系数": {
                "任务描述": "统计 field_dependencies 表记录数",
                "SQL查询": "SELECT COUNT(*) FROM field_dependencies",
                "SQL实际结果": ""
            }
        },
        "血缘质量检测": {
            "任务描述": "根据血缘交叉表4.11(项46-51)检测计算字段的血缘完整性",
            "血缘交叉表对应项": [
                "46.计算字段→物理表",
                "47.计算字段→字段(依赖)",
                "48.计算字段→发布源",
                "49.计算字段→嵌入源(独立)",
                "50.计算字段→工作簿",
                "51.计算字段→视图"
            ],
            "关键字段空值检测": [
                {
                    "字段名": "table_id",
                    "任务描述": "检测计算字段的 table_id 关联情况（计算字段可能无直接表关联）",
                    "SQL查询": "SELECT COUNT(*) FROM fields WHERE is_calculated = 1 AND table_id IS NULL",
                    "SQL实际结果": "",
                    "预期说明": "计算字段可能无直接 table_id"
                },
                {
                    "字段名": "datasource_id",
                    "任务描述": "检测没有关联数据源的计算字段数量",
                    "SQL查询": "SELECT COUNT(*) FROM fields WHERE is_calculated = 1 AND datasource_id IS NULL",
                    "SQL实际结果": ""
                }
            ],
            "血缘覆盖检测": [
                {
                    "检测项": "46.计算字段→物理表(深度交叉)",
                    "主口径SQL": "SELECT COUNT(DISTINCT f.id) FROM fields f WHERE f.is_calculated = 1 AND f.table_id IS NOT NULL",
                    "交叉验证SQL": "SELECT COUNT(DISTINCT fl.field_id) FROM field_full_lineage fl JOIN fields f ON fl.field_id = f.id WHERE f.is_calculated = 1 AND fl.table_id IS NOT NULL",
                    "深度验证SQL": "SELECT field_id, COUNT(DISTINCT table_id) as table_count FROM field_full_lineage WHERE field_id IN (SELECT id FROM fields WHERE is_calculated = 1) GROUP BY field_id",
                    "主口径结果": "",
                    "交叉结果": "",
                    "预期规则": "验证 LFL 推导逻辑与主口径一致；M:N 多表关联完整"
                },
                {
                    "检测项": "47.计算字段→字段(依赖)",
                    "主口径SQL": "SELECT COUNT(DISTINCT source_field_id) FROM field_dependencies",
                    "交叉验证SQL": "SELECT COUNT(DISTINCT fd.source_field_id) FROM field_dependencies fd WHERE EXISTS (SELECT 1 FROM fields f WHERE f.id = fd.dependency_field_id)",
                    "主口径结果": "",
                    "交叉结果": "",
                    "预期规则": "cross = main"
                },
                {
                    "检测项": "48.计算字段→发布源",
                    "主口径SQL": "SELECT COUNT(DISTINCT f.id) FROM fields f JOIN datasources ds ON f.datasource_id = ds.id WHERE f.is_calculated = 1 AND ds.is_embedded = 0",
                    "交叉验证SQL": "SELECT COUNT(DISTINCT f.datasource_id) FROM fields f JOIN datasources ds ON f.datasource_id = ds.id WHERE f.is_calculated = 1 AND ds.is_embedded = 0",
                    "主口径结果": "",
                    "交叉结果": "",
                    "预期规则": "cross = main"
                },
                {
                    "检测项": "49.计算字段→嵌入源(独立)",
                    "主口径SQL": "SELECT COUNT(DISTINCT f.id) FROM fields f JOIN datasources ds ON f.datasource_id = ds.id WHERE f.is_calculated = 1 AND ds.is_embedded = 1 AND ds.source_published_datasource_id IS NULL",
                    "交叉验证SQL": "SELECT COUNT(DISTINCT f.datasource_id) FROM fields f JOIN datasources ds ON f.datasource_id = ds.id WHERE f.is_calculated = 1 AND ds.is_embedded = 1 AND ds.source_published_datasource_id IS NULL",
                    "主口径结果": "",
                    "交叉结果": "",
                    "预期规则": "cross = main"
                },
                {
                    "检测项": "50.计算字段→工作簿(多路径验证)",
                    "主口径SQL": "SELECT COUNT(DISTINCT f.id) FROM fields f WHERE f.is_calculated = 1 AND f.workbook_id IS NOT NULL",
                    "交叉验证SQL": "SELECT COUNT(DISTINCT fl.field_id) FROM field_full_lineage fl JOIN fields f ON fl.field_id = f.id WHERE f.is_calculated = 1 AND fl.workbook_id IS NOT NULL",
                    "深度验证SQL": "SELECT f.id, f.name, COUNT(DISTINCT f.workbook_id) as wb_direct, COUNT(DISTINCT fl.workbook_id) as wb_lfl FROM fields f LEFT JOIN field_full_lineage fl ON f.id = fl.field_id WHERE f.is_calculated = 1 GROUP BY f.id",
                    "主口径结果": "",
                    "交叉结果": "",
                    "预期规则": "验证同一字段在不同工作簿中的多路径保留"
                },
                {
                    "检测项": "51.计算字段→视图",
                    "主口径SQL": "SELECT COUNT(DISTINCT fv.field_id) FROM field_to_view fv JOIN fields f ON fv.field_id = f.id WHERE f.is_calculated = 1",
                    "交叉验证SQL": "SELECT COUNT(DISTINCT f.id) FROM fields f WHERE f.is_calculated = 1 AND EXISTS (SELECT 1 FROM field_to_view fv WHERE fv.field_id = f.id)",
                    "主口径结果": "",
                    "交叉结果": "",
                    "预期规则": "cross = main"
                }
            ],
            "依赖完整性检测": [
                {
                    "检测项": "依赖字段存在性",
                    "任务描述": "检测 field_dependencies 中的 dependency_field_id 是否在 fields 表中存在",
                    "SQL查询": "SELECT COUNT(*) FROM field_dependencies fd WHERE fd.dependency_field_id IS NOT NULL AND NOT EXISTS (SELECT 1 FROM fields f WHERE f.id = fd.dependency_field_id)",
                    "SQL实际结果": "",
                    "预期说明": "应为 0（无悬空依赖）"
                }
            ],
            "未匹配血缘检测": [
                {
                    "关联方向": "计算字段->视图",
                    "任务描述": "检测没有被任何视图引用的计算字段数量（未使用指标）",
                    "SQL查询": "SELECT COUNT(*) FROM fields f WHERE f.is_calculated = 1 AND NOT EXISTS (SELECT 1 FROM field_to_view fv WHERE fv.field_id = f.id)",
                    "SQL实际结果": ""
                },
                {
                    "关联方向": "计算字段->依赖",
                    "任务描述": "检测没有任何依赖字段的计算字段（可能为独立公式或简单引用）",
                    "SQL查询": "SELECT COUNT(*) FROM fields f WHERE f.is_calculated = 1 AND NOT EXISTS (SELECT 1 FROM field_dependencies fd WHERE fd.source_field_id = f.id)",
                    "SQL实际结果": ""
                }
            ]
        },
        "关联元素": [
            {
                "目标模块": "物理表",
                "任务描述": "验证计算字段穿透到物理表的关系（通过依赖字段递归）",
                "关联方式": "计算字段 > 依赖字段 > 数据列 > 物理表 (递归穿透)",
                "血缘交叉表项": "项46",
                "关联验证": {
                    "正向SQL (计算字段>物理表)": "SELECT COUNT(DISTINCT f.id) || ':' || COUNT(DISTINCT fl.table_id) FROM fields f JOIN field_full_lineage fl ON f.id = fl.field_id JOIN tables t ON fl.table_id = t.id WHERE f.is_calculated = 1 AND t.is_embedded = 0",
                    "正向SQL结果": "",
                    "反向SQL (物理表>计算字段)": "SELECT COUNT(DISTINCT t.id) || ':' || COUNT(DISTINCT f.id) FROM tables t JOIN field_full_lineage fl ON t.id = fl.table_id JOIN fields f ON fl.field_id = f.id WHERE t.is_embedded = 0 AND f.is_calculated = 1",
                    "反向SQL结果": ""
                }
            },
            {
                "目标模块": "字段(依赖)",
                "任务描述": "验证计算字段与依赖字段的 M:N 关系",
                "关联方式": "计算字段 > 中间表(field_dependencies) > 依赖字段",
                "血缘交叉表项": "项47",
                "关联验证": {
                    "正向SQL (计算字段>依赖字段)": "SELECT COUNT(DISTINCT fd.source_field_id) || ':' || COUNT(DISTINCT fd.dependency_field_id) FROM field_dependencies fd",
                    "正向SQL结果": "",
                    "反向SQL (依赖字段>计算字段)": "SELECT COUNT(DISTINCT fd.dependency_field_id) || ':' || COUNT(DISTINCT fd.source_field_id) FROM field_dependencies fd",
                    "反向SQL结果": "",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "dependencyFields / formula_references",
                    "API实际结果": ""
                }
            },
            {
                "目标模块": "发布式数据源",
                "任务描述": "验证计算字段与发布式数据源的 N:1 所属关系",
                "关联方式": "计算字段 > 发布式数据源",
                "血缘交叉表项": "项48",
                "关联验证": {
                    "正向SQL (计算字段>发布源)": "SELECT COUNT(DISTINCT f.id) || ':' || COUNT(DISTINCT f.datasource_id) FROM fields f JOIN datasources ds ON f.datasource_id = ds.id WHERE f.is_calculated = 1 AND ds.is_embedded = 0",
                    "正向SQL结果": "",
                    "反向SQL (发布源>计算字段)": "SELECT COUNT(DISTINCT ds.id) || ':' || COUNT(DISTINCT f.id) FROM datasources ds JOIN fields f ON ds.id = f.datasource_id WHERE ds.is_embedded = 0 AND f.is_calculated = 1",
                    "反向SQL结果": ""
                }
            },
            {
                "目标模块": "嵌入式数据源(独立)",
                "任务描述": "验证计算字段与独立嵌入式数据源的 N:1 所属关系",
                "关联方式": "计算字段 > 嵌入式数据源(独立)",
                "血缘交叉表项": "项49",
                "关联验证": {
                    "正向SQL (计算字段>独立嵌入源)": "SELECT COUNT(DISTINCT f.id) || ':' || COUNT(DISTINCT f.datasource_id) FROM fields f JOIN datasources ds ON f.datasource_id = ds.id WHERE f.is_calculated = 1 AND ds.is_embedded = 1 AND ds.source_published_datasource_id IS NULL",
                    "正向SQL结果": "",
                    "反向SQL (独立嵌入源>计算字段)": "SELECT COUNT(DISTINCT ds.id) || ':' || COUNT(DISTINCT f.id) FROM datasources ds JOIN fields f ON ds.id = f.datasource_id WHERE ds.is_embedded = 1 AND ds.source_published_datasource_id IS NULL AND f.is_calculated = 1",
                    "反向SQL结果": ""
                }
            },
            {
                "目标模块": "工作簿",
                "任务描述": "验证计算字段与工作簿的关联关系",
                "关联方式": "计算字段 > 工作簿 (workbook_id / 穿透)",
                "血缘交叉表项": "项50",
                "关联验证": {
                    "正向SQL (计算字段>工作簿)": "SELECT COUNT(DISTINCT f.id) || ':' || COUNT(DISTINCT f.workbook_id) FROM fields f WHERE f.is_calculated = 1 AND f.workbook_id IS NOT NULL",
                    "正向SQL结果": "",
                    "反向SQL (工作簿>计算字段)": "SELECT COUNT(DISTINCT w.id) || ':' || COUNT(DISTINCT f.id) FROM workbooks w JOIN fields f ON w.id = f.workbook_id WHERE f.is_calculated = 1",
                    "反向SQL结果": "",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "all_workbooks",
                    "API实际结果": ""
                }
            },
            {
                "目标模块": "视图",
                "任务描述": "验证计算字段被视图引用的 M:N 关系",
                "关联方式": "计算字段 > 中间表(field_to_view) > 视图",
                "血缘交叉表项": "项51",
                "关联验证": {
                    "正向SQL (计算字段>视图)": "SELECT COUNT(DISTINCT f.id) || ':' || COUNT(DISTINCT fv.view_id) FROM fields f JOIN field_to_view fv ON f.id = fv.field_id WHERE f.is_calculated = 1",
                    "正向SQL结果": "",
                    "反向SQL (视图>计算字段)": "SELECT COUNT(DISTINCT v.id) || ':' || COUNT(DISTINCT fv.field_id) FROM views v JOIN field_to_view fv ON v.id = fv.view_id JOIN fields f ON fv.field_id = f.id WHERE f.is_calculated = 1",
                    "反向SQL结果": "",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "used_in_views",
                    "API实际结果": ""
                }
            }
        ],
        "前端元素对齐": {
            "任务描述": "验证前端卡片和详情页数据与后端逻辑的一致性 (参考 frontend_element_spec.md)",
            "列表卡片 (MetricCard.tsx)": {
                "任务描述": "验证计算字段/指标卡片显示",
                "字段:complexity": {
                    "任务描述": "验证复杂度显示",
                    "API键": "complexity",
                    "说明": "来自依赖字段数量"
                },
                "字段:dependency_count": {
                    "任务描述": "验证依赖字段数汇总",
                    "API键": "dependency_count",
                    "SQL查询": "SELECT SUM(dep_cnt) FROM (SELECT COUNT(*) as dep_cnt FROM field_dependencies GROUP BY source_field_id)",
                    "API汇总结果": "",
                    "SQL汇总结果": ""
                }
            },
            "详情页 (DetailDrawer L245-L277)": {
                "任务描述": "计算字段使用与原始字段相同的详情页逻辑",
                "Tab:依赖字段 (N)": {
                    "任务描述": "验证计算字段详情页的'依赖字段' Tab",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "dependencyFields / formula_references",
                    "显示条件": "isCalculated = true",
                    "API实际记录数": "",
                    "SQL查询": "SELECT COUNT(*) FROM field_dependencies WHERE source_field_id = ?",
                    "SQL实际记录数": ""
                },
                "Tab:同名定义 (N)": {
                    "任务描述": "验证同名指标的重复定义",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "similarMetrics",
                    "显示条件": "similarMetrics.length > 0"
                }
            }
        },
        "逻辑闭环验证": {
            "任务描述": "验证血缘交叉表项46-51的一致性",
            "比对项列表": [
                {
                    "比对名称": "依赖字段完整性闭环",
                    "前端数据源": "关联元素[目标模块='字段(依赖)'].关联验证.正向SQL结果",
                    "血缘数据源": "血缘质量检测.血缘覆盖检测[项47].主口径结果",
                    "比对逻辑": "数值相等",
                    "差异容忍度": 0
                },
                {
                    "比对名称": "视图关联闭环",
                    "前端数据源": "关联元素[目标模块='视图'].关联验证.正向SQL结果",
                    "血缘数据源": "血缘质量检测.血缘覆盖检测[项51].交叉结果",
                    "比对逻辑": "数值相等",
                    "差异容忍度": 0
                }
            ]
        }
    }
}