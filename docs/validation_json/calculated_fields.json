{
    "计算字段/指标(实例)": {
        "任务描述": "验证计算字段实例表的核心指标、血缘关联及数据质量",
        "显示名称": "计算字段/指标(实例)",
        "模块定义": {
            "数据库表": "calculated_fields",
            "说明": "计算字段实例表，每条记录代表一个计算字段在特定数据源/工作簿中的定义",
            "主键": "id",
            "唯一标识表": "unique_calculated_fields"
        },
        "核心属性验证": {
            "任务描述": "验证计算字段实例的基础属性统计",
            "实例总数": {
                "任务描述": "统计计算字段实例总记录数",
                "API路径": "/api/stats",
                "API取值键": "metrics",
                "API实际结果": "",
                "SQL查询": "SELECT COUNT(*) FROM calculated_fields",
                "SQL实际结果": ""
            },
            "去重后标准指标数": {
                "任务描述": "统计去重后的标准指标数",
                "API路径": "/api/stats",
                "API取值键": "uniqueMetrics",
                "API实际结果": "",
                "SQL查询": "SELECT COUNT(*) FROM unique_calculated_fields",
                "SQL实际结果": ""
            },
            "角色分布 (枚举)": {
                "任务描述": "验证计算字段按角色的分布 (业务指标measure/技术计算dimension)",
                "字段名": "role",
                "SQL查询": "SELECT role || ':' || COUNT(*) FROM calculated_fields GROUP BY role",
                "SQL实际分布": ""
            },
            "数据类型分布 (枚举)": {
                "任务描述": "验证计算字段按数据类型的分布",
                "字段名": "data_type",
                "SQL查询": "SELECT COALESCE(data_type, 'unknown') || ':' || COUNT(*) FROM calculated_fields GROUP BY data_type",
                "SQL实际分布": ""
            },
            "复杂度分布": {
                "任务描述": "验证计算字段复杂度分布",
                "SQL查询": "SELECT CASE WHEN complexity_score < 1 THEN '简单(<1)' WHEN complexity_score < 3 THEN '中等(1-3)' ELSE '复杂(>=3)' END || ':' || COUNT(*) FROM calculated_fields GROUP BY 1",
                "SQL实际分布": ""
            },
            "有描述比例": {
                "任务描述": "统计有描述的计算字段比例",
                "SQL查询": "SELECT ROUND(100.0 * SUM(CASE WHEN description IS NOT NULL AND description != '' THEN 1 ELSE 0 END) / COUNT(*), 2) || '%' FROM calculated_fields",
                "SQL实际结果": ""
            }
        },
        "血缘质量检测": {
            "任务描述": "检测计算字段空值率及血缘未匹配情况",
            "关键字段空值检测": [
                {
                    "字段名": "formula",
                    "任务描述": "检测没有公式的计算字段数量",
                    "SQL查询": "SELECT COUNT(*) FROM calculated_fields WHERE formula IS NULL OR formula = ''",
                    "SQL实际结果": ""
                },
                {
                    "字段名": "formula_hash",
                    "任务描述": "检测公式哈希为空的记录（用于去重）",
                    "SQL查询": "SELECT COUNT(*) FROM calculated_fields WHERE formula_hash IS NULL OR formula_hash = ''",
                    "期望值": "0",
                    "SQL实际结果": ""
                },
                {
                    "字段名": "datasource_id",
                    "任务描述": "检测没有关联数据源的计算字段数量",
                    "SQL查询": "SELECT COUNT(*) FROM calculated_fields WHERE datasource_id IS NULL",
                    "SQL实际结果": ""
                },
                {
                    "字段名": "unique_id",
                    "任务描述": "检测与标准指标的关联完整性（必须全覆盖）",
                    "SQL查询": "SELECT COUNT(*) FROM calculated_fields WHERE unique_id IS NULL",
                    "期望值": "0",
                    "SQL实际结果": ""
                }
            ],
            "未匹配血缘检测": [
                {
                    "关联方向": "指标->视图",
                    "任务描述": "检测没有被任何视图引用的计算字段数量",
                    "SQL查询": "SELECT COUNT(*) FROM calculated_fields cf WHERE NOT EXISTS (SELECT 1 FROM calc_field_to_view cfv WHERE cfv.field_id = cf.id)",
                    "SQL实际结果": ""
                },
                {
                    "关联方向": "指标->血缘表",
                    "任务描述": "检测没有血缘记录的计算字段数量",
                    "SQL查询": "SELECT COUNT(*) FROM calculated_fields cf WHERE NOT EXISTS (SELECT 1 FROM calc_field_full_lineage cfl WHERE cfl.field_id = cf.id)",
                    "SQL实际结果": ""
                },
                {
                    "关联方向": "指标->依赖",
                    "任务描述": "检测没有依赖字段的计算字段数量（可能是常量公式）",
                    "SQL查询": "SELECT COUNT(*) FROM calculated_fields cf WHERE NOT EXISTS (SELECT 1 FROM calc_field_dependencies cfd WHERE cfd.source_field_id = cf.id)",
                    "SQL实际结果": ""
                }
            ],
            "依赖完整性检测": {
                "任务描述": "检测依赖链完整性",
                "依赖指向有效字段": {
                    "SQL查询": "SELECT COUNT(*) FROM calc_field_dependencies cfd WHERE cfd.dependency_regular_field_id IS NOT NULL AND NOT EXISTS (SELECT 1 FROM regular_fields rf WHERE rf.id = cfd.dependency_regular_field_id)",
                    "期望值": "0",
                    "SQL实际结果": ""
                }
            }
        },
        "关联元素": [
            {
                "目标模块": "标准指标(去重)",
                "任务描述": "验证实例指标与标准指标的 N:1 关系",
                "关联方式": "calculated_fields.unique_id > unique_calculated_fields.id",
                "关联验证": {
                    "正向SQL (实例>标准)": "SELECT COUNT(DISTINCT cf.id) || ':' || COUNT(DISTINCT cf.unique_id) FROM calculated_fields cf",
                    "正向SQL结果": "",
                    "反向SQL (标准>实例)": "SELECT COUNT(DISTINCT ucf.id) || ':' || COUNT(DISTINCT cf.id) FROM unique_calculated_fields ucf JOIN calculated_fields cf ON ucf.id = cf.unique_id",
                    "反向SQL结果": "",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "uniqueId",
                    "API实际结果": ""
                }
            },
            {
                "目标模块": "原始字段(依赖)",
                "任务描述": "验证计算字段对原始字段的依赖关系",
                "关联方式": "calculated_fields > calc_field_dependencies > regular_fields",
                "关联验证": {
                    "正向SQL (指标>原始字段)": "SELECT COUNT(DISTINCT cfd.source_field_id) || ':' || COUNT(DISTINCT cfd.dependency_regular_field_id) FROM calc_field_dependencies cfd WHERE cfd.dependency_regular_field_id IS NOT NULL",
                    "正向SQL结果": "",
                    "反向SQL (原始字段>指标)": "SELECT COUNT(DISTINCT cfd.dependency_regular_field_id) || ':' || COUNT(DISTINCT cfd.source_field_id) FROM calc_field_dependencies cfd WHERE cfd.dependency_regular_field_id IS NOT NULL",
                    "反向SQL结果": "",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "dependencyFields",
                    "API统计逻辑": "返回 dependencyFields 数组长度",
                    "API实际结果": ""
                }
            },
            {
                "目标模块": "物理表",
                "任务描述": "验证计算字段与上游物理表的关系（通过血缘表）",
                "关联方式": "calculated_fields > calc_field_full_lineage > tables (物理表)",
                "关联验证": {
                    "正向SQL (指标>物理表)": "SELECT COUNT(DISTINCT cfl.field_id) || ':' || COUNT(DISTINCT cfl.table_id) FROM calc_field_full_lineage cfl JOIN tables t ON cfl.table_id = t.id WHERE t.is_embedded = 0 AND cfl.table_id IS NOT NULL",
                    "正向SQL结果": "",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "derivedTables",
                    "API实际结果": ""
                }
            },
            {
                "目标模块": "数据源",
                "任务描述": "验证计算字段与数据源的 N:M 关系",
                "关联方式": "calculated_fields > calc_field_full_lineage > datasources",
                "关联验证": {
                    "正向SQL (指标>数据源)": "SELECT COUNT(DISTINCT cf.id) || ':' || COUNT(DISTINCT cf.datasource_id) FROM calculated_fields cf WHERE cf.datasource_id IS NOT NULL",
                    "正向SQL结果": "",
                    "反向SQL (数据源>指标)": "SELECT COUNT(DISTINCT ds.id) || ':' || COUNT(DISTINCT cf.id) FROM datasources ds JOIN calculated_fields cf ON ds.id = cf.datasource_id",
                    "反向SQL结果": "",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "all_datasources",
                    "API统计逻辑": "返回 all_datasources 数组长度",
                    "API实际结果": ""
                }
            },
            {
                "目标模块": "视图",
                "任务描述": "验证计算字段被视图引用的 M:N 关系",
                "关联方式": "calculated_fields > calc_field_to_view > views",
                "关联验证": {
                    "正向SQL (指标>视图)": "SELECT COUNT(DISTINCT cfv.field_id) || ':' || COUNT(DISTINCT cfv.view_id) FROM calc_field_to_view cfv",
                    "正向SQL结果": "",
                    "反向SQL (视图>指标)": "SELECT COUNT(DISTINCT v.id) || ':' || COUNT(DISTINCT cfv.field_id) FROM views v JOIN calc_field_to_view cfv ON v.id = cfv.view_id",
                    "反向SQL结果": "",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "usedInViews",
                    "API统计逻辑": "返回 usedInViews 数组长度",
                    "API实际结果": ""
                }
            },
            {
                "目标模块": "工作簿",
                "任务描述": "验证计算字段与工作簿的关联关系",
                "关联方式": "calculated_fields > calc_field_full_lineage > workbooks",
                "关联验证": {
                    "正向SQL (指标>工作簿)": "SELECT COUNT(DISTINCT cfl.field_id) || ':' || COUNT(DISTINCT cfl.workbook_id) FROM calc_field_full_lineage cfl WHERE cfl.workbook_id IS NOT NULL",
                    "正向SQL结果": "",
                    "反向SQL (工作簿>指标)": "SELECT COUNT(DISTINCT w.id) || ':' || COUNT(DISTINCT cfl.field_id) FROM workbooks w JOIN calc_field_full_lineage cfl ON w.id = cfl.workbook_id",
                    "反向SQL结果": "",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "all_workbooks",
                    "API统计逻辑": "返回 all_workbooks 数组长度",
                    "API实际结果": ""
                }
            },
            {
                "目标模块": "相似指标",
                "任务描述": "验证相同 formula_hash 的指标聚合",
                "关联方式": "calculated_fields.formula_hash = calculated_fields.formula_hash",
                "关联验证": {
                    "正向SQL (有重复的指标数)": "SELECT COUNT(*) FROM (SELECT formula_hash FROM calculated_fields GROUP BY formula_hash HAVING COUNT(*) > 1)",
                    "正向SQL结果": "",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "similarMetrics",
                    "API统计逻辑": "返回 similarMetrics 数组长度",
                    "API实际结果": ""
                }
            }
        ],
        "前端元素对齐": {
            "任务描述": "验证前端卡片和详情页数据与后端逻辑的一致性 (参考 frontend_element_spec.md)",
            "列表卡片 (FieldCard.tsx / MetricCard)": {
                "任务描述": "验证指标列表页关键指标显示",
                "字段:name": {
                    "任务描述": "指标名",
                    "API键": "name",
                    "验证类型": "存在性校验"
                },
                "字段:role": {
                    "任务描述": "验证角色分布 (measure=业务指标, dimension=技术计算)",
                    "API键": "role",
                    "SQL查询": "SELECT role || ':' || COUNT(*) FROM (SELECT MAX(role) as role FROM calculated_fields GROUP BY unique_id) sub GROUP BY role",
                    "API实际分布": "",
                    "SQL实际分布": ""
                },
                "字段:formula": {
                    "任务描述": "公式内容",
                    "API键": "formula",
                    "验证类型": "存在性校验"
                },
                "字段:complexity": {
                    "任务描述": "复杂度评分",
                    "API键": "complexity",
                    "SQL查询": "SELECT AVG(complexity_score) FROM calculated_fields",
                    "SQL实际结果": ""
                },
                "字段:datasource_name": {
                    "任务描述": "所属数据源名称",
                    "API键": "datasourceName",
                    "验证类型": "存在性校验"
                },
                "字段:usage_count": {
                    "任务描述": "使用次数",
                    "API键": "usageCount",
                    "SQL查询": "SELECT SUM(usage_count) FROM calculated_fields",
                    "SQL汇总结果": ""
                }
            },
            "详情页 (DetailDrawer L245-L277)": {
                "任务描述": "验证详情页各 Tab 页签的数据准确性",
                "Tab:概览": {
                    "任务描述": "验证指标详情页概览信息",
                    "API路径": "/api/metrics/{id}",
                    "显示条件": "始终显示",
                    "验证内容": "id, name, formula, role, complexity 非空"
                },
                "Tab:所属数据表 (N)": {
                    "任务描述": "验证指标详情页的'所属数据表'信息",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "derivedTables",
                    "显示条件": "始终显示",
                    "API实际记录数": "",
                    "SQL查询": "SELECT COUNT(DISTINCT cfl.table_id) FROM calc_field_full_lineage cfl WHERE cfl.field_id = ? AND cfl.table_id IS NOT NULL",
                    "SQL实际记录数": ""
                },
                "Tab:依赖字段 (N)": {
                    "任务描述": "验证指标详情页的'依赖字段' Tab",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "dependencyFields",
                    "显示条件": "计算字段专属",
                    "API实际记录数": "",
                    "SQL查询": "SELECT COUNT(*) FROM calc_field_dependencies WHERE source_field_id = ?",
                    "SQL实际记录数": ""
                },
                "Tab:所属数据源 (N)": {
                    "任务描述": "验证指标详情页的'所属数据源' Tab",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "all_datasources",
                    "显示条件": "始终显示",
                    "API实际记录数": "",
                    "SQL查询": "SELECT COUNT(DISTINCT cfl.datasource_id) FROM calc_field_full_lineage cfl WHERE cfl.field_id = ? AND cfl.datasource_id IS NOT NULL",
                    "SQL实际记录数": ""
                },
                "Tab:关联视图 (N)": {
                    "任务描述": "验证指标详情页的'关联视图' Tab",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "usedInViews",
                    "显示条件": "始终显示",
                    "API实际记录数": "",
                    "SQL查询": "SELECT COUNT(*) FROM calc_field_to_view WHERE field_id = ?",
                    "SQL实际记录数": ""
                },
                "Tab:引用工作簿 (N)": {
                    "任务描述": "验证指标详情页的'引用工作簿' Tab",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "all_workbooks",
                    "显示条件": "始终显示",
                    "API实际记录数": "",
                    "SQL查询": "SELECT COUNT(DISTINCT cfl.workbook_id) FROM calc_field_full_lineage cfl WHERE cfl.field_id = ? AND cfl.workbook_id IS NOT NULL",
                    "SQL实际记录数": ""
                },
                "Tab:同名定义 (N)": {
                    "任务描述": "验证指标详情页的'同名定义/相似指标' Tab",
                    "API路径": "/api/metrics/{id}",
                    "API取值键": "similarMetrics",
                    "显示条件": "similarMetrics.length > 0",
                    "API实际记录数": "",
                    "SQL查询": "SELECT COUNT(*) - 1 FROM calculated_fields WHERE formula_hash = (SELECT formula_hash FROM calculated_fields WHERE id = ?)",
                    "SQL实际记录数": ""
                },
                "Tab:血缘图": {
                    "任务描述": "验证指标血缘图可用性",
                    "API路径": "/api/lineage/graph/field/{id}",
                    "显示条件": "始终显示",
                    "验证内容": "返回有效的血缘节点"
                }
            }
        },
        "逻辑闭环验证": {
            "任务描述": "跨层级比对：验证'前端展示值'与'底层血缘统计值'是否严丝合缝",
            "比对项列表": [
                {
                    "比对名称": "视图关联数闭环",
                    "前端数据源": "前端元素对齐.详情页.Tab:关联视图.API实际记录数 (聚合)",
                    "血缘数据源": "关联元素[目标模块='视图'].关联验证.正向SQL结果(提取目标数)",
                    "比对逻辑": "数值相等",
                    "差异容忍度": 0
                },
                {
                    "比对名称": "工作簿关联数闭环",
                    "前端数据源": "前端元素对齐.详情页.Tab:引用工作簿.API实际记录数 (聚合)",
                    "血缘数据源": "关联元素[目标模块='工作簿'].关联验证.正向SQL结果(提取目标数)",
                    "比对逻辑": "数值相等",
                    "差异容忍度": 0
                },
                {
                    "比对名称": "依赖字段数闭环",
                    "前端数据源": "前端元素对齐.详情页.Tab:依赖字段.API实际记录数 (聚合)",
                    "血缘数据源": "关联元素[目标模块='原始字段(依赖)'].关联验证.正向SQL结果(提取依赖数)",
                    "比对逻辑": "数值相等",
                    "差异容忍度": 0
                },
                {
                    "比对名称": "数据源关联数闭环",
                    "前端数据源": "前端元素对齐.详情页.Tab:所属数据源.API实际记录数 (聚合)",
                    "血缘数据源": "关联元素[目标模块='数据源'].关联验证.正向SQL结果(提取目标数)",
                    "比对逻辑": "数值相等",
                    "差异容忍度": 0
                },
                {
                    "比对名称": "实例与标准指标对应闭环",
                    "前端数据源": "核心属性验证.实例总数.SQL实际结果",
                    "血缘数据源": "关联元素[目标模块='标准指标(去重)'].关联验证.正向SQL结果(提取实例数)",
                    "比对逻辑": "数值相等",
                    "差异容忍度": 0
                }
            ]
        },
        "卡片详情一致性验证": {
            "任务描述": "检测列表卡片显示值与详情页 Tab 显示值是否来自同一数据源，防止'两张皮'问题",
            "验证项列表": [
                {
                    "一致性检测项": "工作簿数量 (workbook_count)",
                    "问题模式": "实例字段 vs 血缘表",
                    "卡片数据源": {
                        "描述": "列表 API 的 workbook_count 来自 calc_field_full_lineage 聚合 (Group by Name + Hash)",
                        "SQL (模拟卡片逻辑)": "SELECT COUNT(DISTINCT cfl.workbook_id) FROM calculated_fields cf JOIN calc_field_full_lineage cfl ON cf.id = cfl.field_id WHERE TRIM(cf.name) = :name AND cf.formula_hash = :hash",
                        "SQL实际结果": ""
                    },
                    "详情数据源": {
                        "描述": "详情 API 的 all_workbooks 来自 calc_field_full_lineage 聚合 (Filter by Hash & Name)",
                        "SQL (模拟详情逻辑)": "SELECT COUNT(DISTINCT cfl.workbook_id) FROM calculated_fields cf JOIN calc_field_full_lineage cfl ON cf.id = cfl.field_id WHERE TRIM(cf.name) = :name AND cf.formula_hash = :hash",
                        "SQL实际结果": ""
                    },
                    "预期规则": "卡片数据源.SQL结果 = 详情数据源.SQL结果",
                    "修复建议": "统一使用 calc_field_full_lineage 血缘表，且聚合口径（Name+Hash）保持一致"
                },
                {
                    "一致性检测项": "数据源数量 (datasource_count)",
                    "问题模式": "实例字段 vs 血缘表",
                    "卡片数据源": {
                        "描述": "列表 API 的 datasource_count 来自 calc_field_full_lineage 聚合 (Group by Name + Hash)",
                        "SQL (模拟卡片逻辑)": "SELECT COUNT(DISTINCT cfl.datasource_id) FROM calculated_fields cf JOIN calc_field_full_lineage cfl ON cf.id = cfl.field_id WHERE TRIM(cf.name) = :name AND cf.formula_hash = :hash",
                        "SQL实际结果": ""
                    },
                    "详情数据源": {
                        "描述": "详情 API 的 all_datasources 来自 calc_field_full_lineage 聚合 (Filter by Hash & Name)",
                        "SQL (模拟详情逻辑)": "SELECT COUNT(DISTINCT cfl.datasource_id) FROM calculated_fields cf JOIN calc_field_full_lineage cfl ON cf.id = cfl.field_id WHERE TRIM(cf.name) = :name AND cf.formula_hash = :hash",
                        "SQL实际结果": ""
                    },
                    "预期规则": "卡片数据源.SQL结果 = 详情数据源.SQL结果",
                    "修复建议": "统一使用 calc_field_full_lineage 血缘表，且聚合口径（Name+Hash）保持一致"
                }
            ]
        }
    }
}