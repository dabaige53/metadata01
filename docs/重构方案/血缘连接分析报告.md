# 血缘连接完整性分析报告

> 生成时间: 2025-12-24 16:40:24
> 数据库: `metadata.db`

---

## 1. 数据库 → 物理表

**关系字段**: `tables.database_id`

| 数据库 | 物理表数量 |
|--------|-----------|
| ho | 1 |
| data_sandbox | 23 |
| ho | 3 |
| ho | 2 |
| 10.12.15.14:8123 | 4 |
| data_sandbox | 3 |

**无物理表的数据库**: 0 个

---

## 2. 物理表 → 数据库

**关系字段**: `tables.database_id`

- 物理表总数: **36**
- 有数据库关联: **36** (100%)
- 无数据库关联: **0**

---

## 3. 物理表 → 数据列

**关系字段**: `db_columns.table_id`

- 物理表总数: **36**
- 有列关联: **197**
- 无列关联: **19**

**未连接原因分析**: API 未返回该表的列信息，可能是 CustomSQL 表或权限问题

示例:
- `vm_flight_history` (schema: )
- `ads_ord_transfer_od_break` (schema: )
- `dim_loc_agent_info` (schema: )
- `ods_mkt_dds_sales_monitoring_2025` (schema: )
- `ods_mkt_oag_od_report` (schema: )

---

## 4. 数据表 → 数据源

**关系字段**: `table_to_datasource` 关联表

- 表总数: **516**
- 有数据源关联: **173**
- 无数据源关联: **343**
- 关联记录总数: **357**

**未连接原因分析**: 表未被任何数据源引用，或同步时未建立关联

| 表名 | 是否嵌入 |
|------|----------|
| 20250712_dih.csv | 是 |
| 20250522_dih.csv | 是 |
| 20250825_dih.csv | 是 |
| Orders_Central.csv | 是 |
| 20251022_dih.csv | 是 |
| 20251212_dih.csv | 是 |
| 20251102_dih.csv | 是 |
| 20250808_dih.csv | 是 |
| 20250926_dih.csv | 是 |
| 20250722_dih.csv | 是 |

---

## 5. 嵌入表 → 物理表 (穿透)

**关系字段**: 嵌入表通过 `database_id` 穿透到物理库

- 嵌入表总数: **480**
- 已穿透(有database_id): **446** (92%)
- 未穿透: **34**

**未连接原因分析**: 嵌入表无上游物理表信息（如纯 Excel/CSV 文件）

示例:
- `Unknown Table`
- `Unknown Table`
- `Unknown Table`
- `Unknown Table`
- `Unknown Table`

---

## 6. 发布数据源 ↔ 嵌入数据源 (穿透关系)

**关系字段**: `datasources.source_published_datasource_id`

- 嵌入数据源总数: **115**
- 穿透型(引用发布源): **68** (59%)
- 独立型(无发布源): **47**

**穿透型**: 工作簿引用已发布的数据源时，会自动创建嵌入副本
**独立型**: 工作簿直接连接外部数据（Excel/数据库），无发布源

---

## 7. 数据源 → 工作簿

**关系字段**: `datasource_to_workbook` 关联表

- 数据源总数: **172**
- 有工作簿关联: **142**
- 无工作簿关联: **30**
- 关联记录总数: **186**

**未连接原因分析**:
- 发布式: 30 个

发布式数据源无工作簿关联是正常的（未被工作簿引用）

---

## 8. 工作簿 → 视图

**关系字段**: `views.workbook_id`

- 工作簿总数: **80**
- 有视图的工作簿: **80**
- 无视图的工作簿: **0**
- 视图总数: **1594**

---

## 9. 视图 → 字段

**关系字段**: `field_to_view` 关联表

- 视图总数: **1594**
- 有字段关联: **1383**
- 无字段关联: **213**
- 关联记录总数: **12936**

**未连接原因分析**: Dashboard 类型的视图可能不直接包含字段，或字段同步未完成

- dashboard: 199 个
- sheet: 14 个

---

## 10. 字段 → 数据表

**关系字段**: `fields.table_id`

- 字段总数: **10567**
- 有表关联: **5838** (55%)
- 普通字段无表关联: **922**
- 计算字段无表关联: **3807**

**分析**:
- 普通字段无表: 上游列信息缺失或嵌入表未穿透
- 计算字段无表: **正常现象**，需通过递归依赖追溯物理表

---

## 11. 字段 → 数据列

**关系字段**: `fields.upstream_column_id`

- 普通字段总数: **5638**
- 有列关联: **4658** (82%)
- 无列关联: **980**

**未连接原因分析**:
- API 未返回 upstreamColumns 信息
- 嵌入式数据源字段无物理列映射
- 列已被删除但字段记录保留

---

## 12. 字段 → 数据源

**关系字段**: `fields.datasource_id`

- 字段总数: **10567**
- 有数据源关联: **10567** (100%)
- 无数据源关联: **0**

---

## 13. 字段 → 工作簿

**关系字段**: `fields.workbook_id`（直接）或 穿透（via 数据源）

- 字段总数: **10567**
- 直接关联工作簿: **6849**
- 穿透可达工作簿: **8890**
- 无法追溯工作簿: **1677**

**未连接原因**: 字段所属数据源为发布式，且未被任何工作簿引用

---

## 14. 计算字段 → 依赖字段

**关系字段**: `field_dependencies` 表

- 计算字段总数: **4929**
- 有依赖记录: **4851**
- 依赖关系总数: **9809**
- 已解析(找到字段): **9092**
- 未解析: **717**

**未解析原因分析**:
- 依赖的字段名称在同数据源中不存在
- 引用的是参数、集合或其他非字段对象
- 公式解析未能正确提取依赖名称

| 未解析依赖名 | 出现次数 |
|-------------|---------|
| 分摊票价_人民币 | 81 |
| A-Z | 45 |
| 0-9 | 42 |
| 分摊燃油_人民币 | 37 |
| 航季1 | 30 |
| 本期年份 | 20 |
| 旅客证件所属城市 | 20 |
| 参数 产品 | 17 |
| Parameters | 17 |
| 票价-展示参数 | 16 |

---

## 15. 计算字段 → 物理表 (递归穿透)

**关系方式**: 递归追溯依赖字段的 `table_id`

- 计算字段总数: **4929**
- 有直接表关联: **1122** (22%)
- 无直接表关联: **3807**

**说明**: 计算字段通常无直接 `table_id`，需通过依赖字段递归追溯
**重构后**: 将预计算并填充 `lineage_table_id` 冗余列

---

## 汇总

| 模块 | 数量 |
|------|------|
| 数据库 | 6 |
| 物理表 | 36 |
| 嵌入表 | 480 |
| 发布数据源 | 57 |
| 嵌入源(穿透) | 68 |
| 嵌入源(独立) | 47 |
| 工作簿 | 80 |
| 视图 | 1594 |
| 普通字段 | 5638 |
| 计算字段 | 4929 |

### 主要问题点

1. **字段→列 关联率偏低** (82.6%): 部分字段无物理列映射
2. **计算字段无直接表关联** (77.2%): 需通过依赖递归追溯
3. **依赖解析未完成** (717条): 部分公式引用无法解析

---

## 附录: SQL 验证脚本

### 数据库→物理表 统计

```sql
SELECT 
                db.id, db.name,
                COUNT(t.id) as table_count
            FROM databases db
            LEFT JOIN tables t ON db.id = t.database_id AND t.is_embedded = 0
            GROUP BY db.id
```

### 物理表→数据库 统计

```sql
SELECT 
                COUNT(*) as total,
                SUM(CASE WHEN database_id IS NOT NULL THEN 1 ELSE 0 END) as with_db,
                SUM(CASE WHEN database_id IS NULL THEN 1 ELSE 0 END) as without_db
            FROM tables
            WHERE is_embedded = 0
```

### 物理表→数据列 统计

```sql
SELECT 
                (SELECT COUNT(*) FROM tables WHERE is_embedded = 0) as total_tables,
                (SELECT COUNT(DISTINCT table_id) FROM db_columns) as tables_with_columns,
                (SELECT COUNT(*) FROM tables t WHERE t.is_embedded = 0 
                 AND NOT EXISTS (SELECT 1 FROM db_columns c WHERE c.table_id = t.id)) as tables_without_columns
```

### 无列的物理表

```sql
SELECT t.id, t.name, t.schema FROM tables t
                WHERE t.is_embedded = 0
                AND NOT EXISTS (SELECT 1 FROM db_columns c WHERE c.table_id = t.id)
                LIMIT 10
```

### 表→数据源 统计

```sql
SELECT 
                (SELECT COUNT(*) FROM tables) as total_tables,
                (SELECT COUNT(DISTINCT table_id) FROM table_to_datasource) as tables_with_ds,
                (SELECT COUNT(*) FROM tables t 
                 WHERE NOT EXISTS (SELECT 1 FROM table_to_datasource td2 WHERE td2.table_id = t.id)) as tables_without_ds,
                (SELECT COUNT(*) FROM table_to_datasource) as total_relations
```

### 无数据源的表

```sql
SELECT t.id, t.name, t.is_embedded FROM tables t
                WHERE NOT EXISTS (SELECT 1 FROM table_to_datasource td WHERE td.table_id = t.id)
                LIMIT 10
```

### 嵌入表穿透 统计

```sql
SELECT 
                COUNT(*) as total_embedded,
                SUM(CASE WHEN database_id IS NOT NULL THEN 1 ELSE 0 END) as with_db,
                SUM(CASE WHEN database_id IS NULL THEN 1 ELSE 0 END) as without_db
            FROM tables
            WHERE is_embedded = 1
```

### 未穿透的嵌入表

```sql
SELECT t.id, t.name FROM tables t
                WHERE t.is_embedded = 1 AND t.database_id IS NULL
                LIMIT 10
```

### 嵌入源穿透 统计

```sql
SELECT 
                COUNT(*) as total_embedded,
                SUM(CASE WHEN source_published_datasource_id IS NOT NULL THEN 1 ELSE 0 END) as penetrating,
                SUM(CASE WHEN source_published_datasource_id IS NULL THEN 1 ELSE 0 END) as standalone
            FROM datasources
            WHERE is_embedded = 1
```

### 断链的穿透关系

```sql
SELECT eds.id, eds.name, eds.source_published_datasource_id
            FROM datasources eds
            WHERE eds.source_published_datasource_id IS NOT NULL
            AND NOT EXISTS (SELECT 1 FROM datasources pds WHERE pds.id = eds.source_published_datasource_id)
```

### 数据源→工作簿 统计

```sql
SELECT 
                (SELECT COUNT(*) FROM datasources) as total_ds,
                (SELECT COUNT(DISTINCT datasource_id) FROM datasource_to_workbook) as ds_with_wb,
                (SELECT COUNT(*) FROM datasources ds 
                 WHERE NOT EXISTS (SELECT 1 FROM datasource_to_workbook dw2 WHERE dw2.datasource_id = ds.id)) as ds_without_wb,
                (SELECT COUNT(*) FROM datasource_to_workbook) as total_relations
```

### 无工作簿数据源分类

```sql
SELECT 
                    is_embedded,
                    COUNT(*) as count
                FROM datasources ds
                WHERE NOT EXISTS (SELECT 1 FROM datasource_to_workbook dw WHERE dw.datasource_id = ds.id)
                GROUP BY is_embedded
```

### 工作簿→视图 统计

```sql
SELECT 
                (SELECT COUNT(*) FROM workbooks) as total_wb,
                (SELECT COUNT(DISTINCT workbook_id) FROM views) as wb_with_views,
                (SELECT COUNT(*) FROM workbooks wb 
                 WHERE NOT EXISTS (SELECT 1 FROM views v2 WHERE v2.workbook_id = wb.id)) as wb_without_views,
                (SELECT COUNT(*) FROM views) as total_views
```

### 视图→字段 统计

```sql
SELECT 
                (SELECT COUNT(*) FROM views) as total_views,
                (SELECT COUNT(DISTINCT view_id) FROM field_to_view) as views_with_fields,
                (SELECT COUNT(*) FROM views v 
                 WHERE NOT EXISTS (SELECT 1 FROM field_to_view fv2 WHERE fv2.view_id = v.id)) as views_without_fields,
                (SELECT COUNT(*) FROM field_to_view) as total_relations
```

### 无字段视图分类

```sql
SELECT 
                    view_type,
                    COUNT(*) as count
                FROM views v
                WHERE NOT EXISTS (SELECT 1 FROM field_to_view fv WHERE fv.view_id = v.id)
                GROUP BY view_type
```

### 字段→表 统计

```sql
SELECT 
                COUNT(*) as total,
                SUM(CASE WHEN table_id IS NOT NULL THEN 1 ELSE 0 END) as with_table,
                SUM(CASE WHEN table_id IS NULL AND is_calculated = 0 THEN 1 ELSE 0 END) as regular_without_table,
                SUM(CASE WHEN table_id IS NULL AND is_calculated = 1 THEN 1 ELSE 0 END) as calc_without_table
            FROM fields
```

### 字段→列 统计

```sql
SELECT 
                COUNT(*) as total_regular,
                SUM(CASE WHEN upstream_column_id IS NOT NULL THEN 1 ELSE 0 END) as with_column,
                SUM(CASE WHEN upstream_column_id IS NULL THEN 1 ELSE 0 END) as without_column
            FROM fields
            WHERE is_calculated = 0
```

### 字段→数据源 统计

```sql
SELECT 
                COUNT(*) as total,
                SUM(CASE WHEN datasource_id IS NOT NULL THEN 1 ELSE 0 END) as with_ds,
                SUM(CASE WHEN datasource_id IS NULL THEN 1 ELSE 0 END) as without_ds
            FROM fields
```

### 字段→工作簿 统计

```sql
SELECT 
                COUNT(*) as total,
                SUM(CASE WHEN workbook_id IS NOT NULL THEN 1 ELSE 0 END) as direct,
                (SELECT COUNT(DISTINCT f.id) FROM fields f 
                 JOIN datasource_to_workbook dw ON f.datasource_id = dw.datasource_id) as via_datasource
            FROM fields
```

### 无法追溯工作簿的字段

```sql
SELECT COUNT(*) as count FROM fields f
            WHERE f.workbook_id IS NULL
            AND NOT EXISTS (
                SELECT 1 FROM datasource_to_workbook dw 
                WHERE dw.datasource_id = f.datasource_id
            )
```

### 计算字段依赖 统计

```sql
SELECT 
                (SELECT COUNT(*) FROM fields WHERE is_calculated = 1) as total_calc,
                COUNT(DISTINCT source_field_id) as calc_with_deps,
                (SELECT COUNT(*) FROM field_dependencies) as total_deps,
                SUM(CASE WHEN dependency_field_id IS NOT NULL THEN 1 ELSE 0 END) as resolved,
                SUM(CASE WHEN dependency_field_id IS NULL THEN 1 ELSE 0 END) as unresolved
            FROM field_dependencies
```

### 未解析依赖示例

```sql
SELECT fd.dependency_name, COUNT(*) as count
                FROM field_dependencies fd
                WHERE fd.dependency_field_id IS NULL
                GROUP BY fd.dependency_name
                ORDER BY count DESC
                LIMIT 10
```

### 计算字段表关联 统计

```sql
SELECT 
                COUNT(*) as total_calc,
                SUM(CASE WHEN table_id IS NOT NULL THEN 1 ELSE 0 END) as with_table,
                SUM(CASE WHEN table_id IS NULL THEN 1 ELSE 0 END) as without_table
            FROM fields
            WHERE is_calculated = 1
```

### 汇总统计

```sql
SELECT 
                (SELECT COUNT(*) FROM databases) as databases,
                (SELECT COUNT(*) FROM tables WHERE is_embedded = 0) as physical_tables,
                (SELECT COUNT(*) FROM tables WHERE is_embedded = 1) as embedded_tables,
                (SELECT COUNT(*) FROM datasources WHERE is_embedded = 0) as published_ds,
                (SELECT COUNT(*) FROM datasources WHERE is_embedded = 1 AND source_published_datasource_id IS NOT NULL) as penetrating_ds,
                (SELECT COUNT(*) FROM datasources WHERE is_embedded = 1 AND source_published_datasource_id IS NULL) as standalone_ds,
                (SELECT COUNT(*) FROM workbooks) as workbooks,
                (SELECT COUNT(*) FROM views) as views,
                (SELECT COUNT(*) FROM fields WHERE is_calculated = 0) as regular_fields,
                (SELECT COUNT(*) FROM fields WHERE is_calculated = 1) as calc_fields
```
