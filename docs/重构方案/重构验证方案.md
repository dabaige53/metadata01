# 重构验证方案

> **版本**: v1.0  
> **日期**: 2025-12-24  
> **状态**: 执行中

---

## 一、元数据血缘关系交叉表

> ✅ = 已建立直接/穿透关系  
> 行 = 源模块, 列 = 目标模块

| 源 \→ 目标       | 数据库 | 物理表 | 嵌入表 | 数据列 | 发布源 | 嵌入源(穿透) | 嵌入源(独立) | 工作簿 | 视图 | 字段 | 计算字段 |
| ---------------- | ------ | ------ | ------ | ------ | ------ | ------------ | ------------ | ------ | ---- | ---- | -------- |
| **数据库**       | —      | ✅      |        |        |        |              |              |        |      |      |          |
| **物理表**       | ✅      | —      |        | ✅      | ✅      |              | ✅            |        |      | ✅    |          |
| **嵌入表**       |        | ✅      | —      | ✅      |        |              | ✅            |        |      | ✅    |          |
| **数据列**       |        | ✅      | ✅      | —      |        |              |              |        |      | ✅    |          |
| **发布源**       |        | ✅      |        |        | —      | ✅            |              | ✅      |      | ✅    |          |
| **嵌入源(穿透)** |        |        |        |        | ✅      | —            |              | ✅      |      |      |          |
| **嵌入源(独立)** |        | ✅      | ✅      |        |        |              | —            | ✅      |      | ✅    |          |
| **工作簿**       | ✅      | ✅      | ✅      |        | ✅      | ✅            | ✅            | —      | ✅    | ✅    |          |
| **视图**         | ✅      | ✅      |        |        |        |              |              | ✅      | —    | ✅    |          |
| **字段**         | ✅      | ✅      | ✅      | ✅      | ✅      | ✅            | ✅            | ✅      | ✅    | —    | ✅        |
| **计算字段**     |        | ✅      |        |        | ✅      |              | ✅            | ✅      | ✅    | ✅    | —        |

### 模块定义

| 模块         | 数据库条件                                                                         |
| ------------ | ---------------------------------------------------------------------------------- |
| 物理表       | `tables WHERE is_embedded = 0`                                                     |
| 嵌入表       | `tables WHERE is_embedded = 1`（Excel/CSV/CustomSQL）                              |
| 发布源       | `datasources WHERE is_embedded = 0`                                                |
| 嵌入源(穿透) | `datasources WHERE is_embedded = 1 AND source_published_datasource_id IS NOT NULL` |
| 嵌入源(独立) | `datasources WHERE is_embedded = 1 AND source_published_datasource_id IS NULL`     |

### 关系类型说明

| 源           | 目标          | 关系字段/方式                    |
| ------------ | ------------- | -------------------------------- |
| 数据库       | 物理表        | `database_id`                    |
| 物理表       | 数据库        | `database_id`                    |
| 物理表       | 数据列        | `table_id`                       |
| 物理表       | 发布源        | `table_to_datasource`            |
| 物理表       | 嵌入源(独立)  | `table_to_datasource`            |
| 物理表       | 字段          | `table_id`                       |
| 嵌入表       | 物理表        | `upstreamTables` **穿透**        |
| 嵌入表       | 数据列        | `table_id`                       |
| 嵌入表       | 嵌入源(独立)  | `table_to_datasource`            |
| 嵌入表       | 字段          | `table_id`                       |
| 数据列       | 物理表/嵌入表 | `table_id`                       |
| 数据列       | 字段          | `upstream_column_id`             |
| 发布源       | 物理表        | `table_to_datasource`            |
| 发布源       | 嵌入源(穿透)  | `source_published_datasource_id` |
| 发布源       | 工作簿        | `datasource_to_workbook`         |
| 发布源       | 字段          | `datasource_id`                  |
| 嵌入源(穿透) | 发布源        | `source_published_datasource_id` |
| 嵌入源(穿透) | 工作簿        | `datasource_to_workbook`         |
| 嵌入源(独立) | 物理表/嵌入表 | `table_to_datasource`            |
| 嵌入源(独立) | 工作簿        | `datasource_to_workbook`         |
| 嵌入源(独立) | 字段          | `datasource_id`                  |
| 工作簿       | 发布源/嵌入源 | `datasource_to_workbook`         |
| 工作簿       | 视图          | `workbook_id`                    |
| 工作簿       | 物理表/嵌入表 | **穿透**(via 数据源)             |
| 工作簿       | 数据库        | **穿透**(via 数据源→表)          |
| 视图         | 工作簿        | `workbook_id`                    |
| 视图         | 字段          | `field_to_view`                  |
| 视图         | 物理表        | **穿透**(via 字段)               |
| 视图         | 数据库        | **穿透**(via 字段→表)            |
| 字段         | 物理表/嵌入表 | `table_id`                       |
| 字段         | 数据列        | `upstream_column_id`             |
| 字段         | 发布源/嵌入源 | `datasource_id`                  |
| 字段         | 工作簿        | `workbook_id` / **穿透**         |
| 字段         | 视图          | `field_to_view`                  |
| 字段         | 数据库        | **穿透**(via 表)                 |
| 字段         | 计算字段      | `field_dependencies`             |
| 计算字段     | 字段          | `field_dependencies`             |
| 计算字段     | 物理表        | **递归穿透**                     |

---

## 二、验证目标

确保重构后的架构（采集与处理分离）不会导致数据丢失或血缘关系断裂。

**核心验证原则**：
- 重构后的业务数据应与重构前**完全一致**
- 允许的变化：新增列（`is_duplicate`、`lineage_*` 等）
- 不允许的变化：关联关系的数量减少

---

## 二、基准快照（重构前）

**生成时间**: 2025-12-24 16:17

**表级数据统计**：

| 表名                 | 记录数 | 说明         |
| -------------------- | ------ | ------------ |
| `databases`          | 6      | 数据库连接   |
| `tables`             | 516    | 数据表       |
| `db_columns`         | 5893   | 数据库原生列 |
| `datasources`        | 172    | 数据源       |
| `workbooks`          | 80     | 工作簿       |
| `views`              | 1594   | 视图/仪表板  |
| `fields`             | 10567  | 字段         |
| `calculated_fields`  | 4926   | 计算字段详情 |
| `metrics`            | 3242   | 指标         |
| `field_dependencies` | 9809   | 字段依赖关系 |
| `field_full_lineage` | 202484 | 预计算血缘   |

---

## 三、验证项清单

### 3.1 模块一：数据库 → 其他模块

| 验证项      | 说明             | 验证 SQL                                                                                                | 预期 |
| ----------- | ---------------- | ------------------------------------------------------------------------------------------------------- | ---- |
| 数据库总数  | 不应减少         | `SELECT COUNT(*) FROM databases`                                                                        | = 6  |
| 数据库 → 表 | 每个库关联的表数 | `SELECT d.id, COUNT(t.id) FROM databases d LEFT JOIN tables t ON d.id = t.database_id GROUP BY d.id`    | 不变 |
| 无表数据库  | 孤立数据库数量   | `SELECT COUNT(*) FROM databases d WHERE NOT EXISTS (SELECT 1 FROM tables t WHERE t.database_id = d.id)` | 不变 |

---

### 3.2 模块二：数据表 → 其他模块

| 验证项       | 说明                         | 验证 SQL                                                                                                                                            | 预期   |
| ------------ | ---------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------- | ------ |
| 表总数       | 不应减少                     | `SELECT COUNT(*) FROM tables`                                                                                                                       | = 516  |
| 嵌入式表数量 | 按类型分布                   | `SELECT SUM(CASE WHEN is_embedded=1 THEN 1 ELSE 0 END) FROM tables`                                                                                 | 不变   |
| 物理表数量   | 按类型分布                   | `SELECT SUM(CASE WHEN is_embedded=0 THEN 1 ELSE 0 END) FROM tables`                                                                                 | 不变   |
| 表 → 数据源  | 关联数量                     | `SELECT COUNT(*) FROM table_to_datasource`                                                                                                          | 不减少 |
| 表 → 字段    | 每表关联的字段数（仅非重复） | `SELECT t.id, COUNT(f.id) FROM tables t LEFT JOIN fields f ON t.id = f.table_id WHERE (f.is_duplicate IS NULL OR f.is_duplicate = 0) GROUP BY t.id` | 不变   |
| 无数据源的表 | 孤立表数量                   | `SELECT COUNT(*) FROM tables t WHERE NOT EXISTS (SELECT 1 FROM table_to_datasource td WHERE td.table_id = t.id)`                                    | 不变   |

---

### 3.3 模块三：数据源 → 其他模块

| 验证项          | 说明                   | 验证 SQL                                                                                                                                 | 预期  |
| --------------- | ---------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- | ----- |
| 数据源总数      | 不应减少               | `SELECT COUNT(*) FROM datasources`                                                                                                       | = 172 |
| 嵌入式数据源    | 按类型分布             | `SELECT COUNT(*) FROM datasources WHERE is_embedded = 1`                                                                                 | 不变  |
| 发布式数据源    | 按类型分布             | `SELECT COUNT(*) FROM datasources WHERE is_embedded = 0`                                                                                 | 不变  |
| 穿透型嵌入源    | 有上游发布源的嵌入源   | `SELECT COUNT(*) FROM datasources WHERE is_embedded=1 AND source_published_datasource_id IS NOT NULL`                                    | 不变  |
| 数据源 → 表     | 每数据源关联的表数     | `SELECT ds.id, COUNT(td.table_id) FROM datasources ds LEFT JOIN table_to_datasource td ON ds.id = td.datasource_id GROUP BY ds.id`       | 不变  |
| 数据源 → 工作簿 | 每数据源关联的工作簿数 | `SELECT ds.id, COUNT(dw.workbook_id) FROM datasources ds LEFT JOIN datasource_to_workbook dw ON ds.id = dw.datasource_id GROUP BY ds.id` | 不变  |
| 数据源 → 字段   | 每数据源的字段数       | `SELECT ds.id, COUNT(f.id) FROM datasources ds LEFT JOIN fields f ON ds.id = f.datasource_id GROUP BY ds.id`                             | 不变  |

---

### 3.4 模块四：工作簿 → 其他模块

| 验证项          | 说明             | 验证 SQL                                                                                                                    | 预期   |
| --------------- | ---------------- | --------------------------------------------------------------------------------------------------------------------------- | ------ |
| 工作簿总数      | 不应减少         | `SELECT COUNT(*) FROM workbooks`                                                                                            | = 80   |
| 工作簿 → 数据源 | 关联数量         | `SELECT COUNT(*) FROM datasource_to_workbook`                                                                               | 不减少 |
| 工作簿 → 视图   | 每工作簿的视图数 | `SELECT wb.id, COUNT(v.id) FROM workbooks wb LEFT JOIN views v ON wb.id = v.workbook_id GROUP BY wb.id`                     | 不变   |
| 无数据源工作簿  | 孤立工作簿数量   | `SELECT COUNT(*) FROM workbooks wb WHERE NOT EXISTS (SELECT 1 FROM datasource_to_workbook dw WHERE dw.workbook_id = wb.id)` | 不变   |

---

### 3.5 模块五：视图 → 其他模块

| 验证项         | 说明         | 验证 SQL                                                                                                 | 预期   |
| -------------- | ------------ | -------------------------------------------------------------------------------------------------------- | ------ |
| 视图总数       | 不应减少     | `SELECT COUNT(*) FROM views`                                                                             | = 1594 |
| Sheet 数量     | 按类型分布   | `SELECT COUNT(*) FROM views WHERE view_type = 'sheet'`                                                   | 不变   |
| Dashboard 数量 | 按类型分布   | `SELECT COUNT(*) FROM views WHERE view_type = 'dashboard'`                                               | 不变   |
| 视图 → 字段    | 关联数量     | `SELECT COUNT(*) FROM field_to_view`                                                                     | 不减少 |
| 无字段视图     | 孤立视图数量 | `SELECT COUNT(*) FROM views v WHERE NOT EXISTS (SELECT 1 FROM field_to_view fv WHERE fv.view_id = v.id)` | 不变   |

---

### 3.6 模块六：字段 → 其他模块

| 验证项        | 说明                     | 验证 SQL                                                                     | 预期    |
| ------------- | ------------------------ | ---------------------------------------------------------------------------- | ------- |
| 字段总数      | 可能增加（因为保留副本） | `SELECT COUNT(*) FROM fields`                                                | ≥ 10567 |
| 非重复字段数  | 去重后的有效字段         | `SELECT COUNT(*) FROM fields WHERE is_duplicate = 0 OR is_duplicate IS NULL` | = 10567 |
| 计算字段数    | 按类型分布               | `SELECT COUNT(*) FROM fields WHERE is_calculated = 1`                        | 不变    |
| 普通字段数    | 按类型分布               | `SELECT COUNT(*) FROM fields WHERE is_calculated = 0`                        | 不变    |
| 字段 → 表     | 有表关联的字段数         | `SELECT COUNT(*) FROM fields WHERE table_id IS NOT NULL`                     | 不变    |
| 字段 → 数据源 | 有数据源关联的字段数     | `SELECT COUNT(*) FROM fields WHERE datasource_id IS NOT NULL`                | 不变    |
| 字段 → 工作簿 | 有工作簿关联的字段数     | `SELECT COUNT(*) FROM fields WHERE workbook_id IS NOT NULL`                  | 不变    |
| 字段 → 上游列 | 有上游列关联的字段数     | `SELECT COUNT(*) FROM fields WHERE upstream_column_id IS NOT NULL`           | 不变    |
| 字段 → 视图   | field_to_view 记录数     | `SELECT COUNT(*) FROM field_to_view`                                         | 不减少  |

---

### 3.7 模块七：计算字段 → 其他模块

| 验证项         | 说明                   | 验证 SQL                                                                                                                                                          | 预期   |
| -------------- | ---------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------ |
| 计算字段详情数 | calculated_fields 表   | `SELECT COUNT(*) FROM calculated_fields`                                                                                                                          | = 4926 |
| 字段依赖数     | field_dependencies 表  | `SELECT COUNT(*) FROM field_dependencies`                                                                                                                         | 不减少 |
| 依赖完整性     | 依赖字段能找到对应记录 | `SELECT COUNT(*) FROM field_dependencies fd WHERE fd.dependency_field_id IS NOT NULL AND NOT EXISTS (SELECT 1 FROM fields f WHERE f.id = fd.dependency_field_id)` | = 0    |

---

### 3.8 模块八：血缘完整性

| 验证项         | 说明                  | 验证 SQL                                                                                                                                              | 预期     |
| -------------- | --------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| 预计算血缘数   | field_full_lineage 表 | `SELECT COUNT(*) FROM field_full_lineage`                                                                                                             | ≥ 202484 |
| 字段→表→库链路 | 完整链路数            | `SELECT COUNT(*) FROM fields f JOIN tables t ON f.table_id = t.id JOIN databases db ON t.database_id = db.id`                                         | 不变     |
| 字段→源→簿链路 | 完整链路数            | `SELECT COUNT(DISTINCT f.id) FROM fields f JOIN datasources ds ON f.datasource_id = ds.id JOIN datasource_to_workbook dw ON ds.id = dw.datasource_id` | 不变     |
| 断链普通字段   | 无表关联的非计算字段  | `SELECT COUNT(*) FROM fields WHERE table_id IS NULL AND is_calculated = 0`                                                                            | 不变     |

---

### 3.9 关联表完整性

| 验证项                 | 说明              | 验证 SQL                                      | 预期   |
| ---------------------- | ----------------- | --------------------------------------------- | ------ |
| table_to_datasource    | 表→数据源关联     | `SELECT COUNT(*) FROM table_to_datasource`    | 不减少 |
| datasource_to_workbook | 数据源→工作簿关联 | `SELECT COUNT(*) FROM datasource_to_workbook` | 不减少 |
| field_to_view          | 字段→视图关联     | `SELECT COUNT(*) FROM field_to_view`          | 不减少 |
| dashboard_to_sheet     | 仪表板→图表关联   | `SELECT COUNT(*) FROM dashboard_to_sheet`     | 不减少 |

---

## 四、血缘覆盖交叉验证（51项对照增强）

> 目标：每个覆盖率项除了“是否关联上”外，再用交叉口径验证（预计算血缘、反向关联、多路径、一致性），避免单条关联导致的漏统/误统。原则：`cross_count >= main_count` 且 `mismatch = 0`（或设计预期值）；多对多项验证“无缺失”。主口径沿用 `analyze_lineage.py`。

通用变量：`@total_src`/`@total_tgt` 为主口径源/目标总数；`LFL`= `field_full_lineage`。

### 4.1 数据库/物理表
1. 数据库→物理表  
   - 主：`COUNT(DISTINCT database_id) FROM tables WHERE is_embedded=0`  
   - 交叉：`SELECT COUNT(*) FROM databases d WHERE EXISTS (SELECT 1 FROM tables t WHERE t.database_id=d.id AND t.is_embedded=0)`；期望 `cross=total_db`

### 4.2 物理表（5项）
2. 物理表→数据库：反查数据库存在表；`cross=total_phys`  
3. 物理表→数据列：`COUNT(DISTINCT t.id WHERE EXISTS db_columns)`；`cross >= main`  
4. 物理表→发布源：
   - **M:N 交叉验证**: 验证 `Avg(Datasources_per_Table)`，确保多对多关联不丢失。
   - SQL: `SELECT table_id, COUNT(datasource_id) FROM table_to_datasource GROUP BY table_id`
5. 物理表→嵌入源(独立)：同上，验证独立嵌入源的关联完整性。
6. 物理表→字段：验证表关联字段的 `table_id` 是否匹配。

### 4.3 嵌入表（4项）
7. 嵌入表→物理表：同口径核对 `database_id NOT NULL`；`cross=main`  
8. 嵌入表→数据列：反查 `EXISTS db_columns`；`cross >= main`  
9. 嵌入表→嵌入源(独立)：反查 `table_to_datasource` with embed independent；`cross >= main`  
10. 嵌入表→字段：反查 `EXISTS fields.table_id`；`cross >= main`

### 4.4 数据列（3项）
11. 数据列→物理表：同口径；`cross=main`  
12. 数据列→嵌入表：同口径；`cross=main`  
13. 数据列→字段：反向 `db_columns` 被引用；`cross=main`

### 4.5 发布源（4项）
14. 发布源→物理表：反查 publish ds 有表；`cross >= main`  
15. 发布源→嵌入源(穿透)：反查 publish ds 被 embed 引用；`cross >= main`  
16. 发布源→工作簿：反查 publish ds 存在 dw；`cross >= main`  
17. 发布源→字段：反查 publish ds 存在字段；`cross >= main`

### 4.6 嵌入源(穿透)（2项）
18. 嵌入源(穿透)→发布源：`embed with source_published` 存在上游；`cross=total`  
19. 嵌入源(穿透)→工作簿：反查 dw；`cross >= main`

### 4.7 嵌入源(独立)（4项）
20. 独立嵌入源→物理表：反查 td+phys；`cross >= main`  
21. 独立嵌入源→嵌入表：反查 td+embed；`cross >= main`  
22. 独立嵌入源→工作簿：反查 dw；`cross >= main`  
23. 独立嵌入源→字段：反查 fields.datasource_id；`cross >= main`

### 4.8 工作簿（8项）
24. 工作簿→数据库：穿透 `dw->td->tables.database_id`；`cross=main`  
25. 工作簿→物理表：穿透 `dw->td->phys`；`cross=main`  
26. 工作簿→嵌入表：穿透 `dw->td->embed`；`cross=main`  
27. 工作簿→发布源：反查 `dw` with publish；`cross=main`  
28. 工作簿→嵌入源(穿透)：同口径；`cross=main`  
29. 工作簿→嵌入源(独立)：同口径；`cross=main`  
30. 工作簿→视图：反查 `EXISTS views`；`cross=total_workbooks`  
31. 工作簿→字段：交叉1 `fields.workbook_id`，交叉2 `COUNT(DISTINCT fl.workbook_id)` from LFL；`cross >= main`

### 4.9 视图（4项）
32. 视图→数据库：主口径 vs LFL(`database_id`)；`cross >= main`  
33. 视图→物理表：主口径 vs LFL(`table_id IN phys`)；`cross >= main`  
34. 视图→工作簿：`views.workbook_id` 非空；`cross=total_views`  
35. 视图→字段：反查 `EXISTS field_to_view`；`cross=main`

### 4.10 字段（10项）
36. 字段→数据库：主口径 vs LFL(`database_id`)；`cross >= main`  
37. 字段→物理表：主口径 vs LFL(`table_id IN phys`)；`cross >= main`  
38. 字段→嵌入表：主口径 vs LFL(`table_id IN embed`)；`cross >= main`  
39. 字段→数据列：反查 `db_columns`；`cross=main`  
40. 字段→发布源：反查 publish ds；`cross=main`  
41. 字段→嵌入源(穿透)：设计为 0；`cross=0`  
42. 字段→嵌入源(独立)：反查独立嵌入 ds；`cross=main`  
43. 字段→工作簿：主口径 vs LFL(`workbook_id`)；`cross >= main`  
44. 字段→视图：反查 `field_to_view`；`cross=main`  
45. 字段→计算字段：反查 `field_dependencies`；`cross=main`

### 4.11 计算字段（6项）
46. 计算字段→物理表：
   - **深度交叉验证**: 对比主口径与 `field_full_lineage` (LFL) 的差值，验证推导逻辑一致性。
   - **M:N 完整性**: 验证一个计算字段由多个物理表组合时，在 LFL 中是否存在多个 `table_id` 条目。
   - SQL: `SELECT field_id, COUNT(DISTINCT table_id) FROM field_full_lineage GROUP BY field_id`
47. 计算字段→字段(依赖)：反查 `field_dependencies.source_field_id`；`cross=main`  
48. 计算字段→发布源：反查 publish ds；`cross=main`  
49. 计算字段→嵌入源(独立)：反查独立嵌入 ds；`cross=main`  
50. 计算字段→工作簿：
   - **多路径验证**: 验证同一字段在不同工作簿中作为嵌入字段时，是否正确保留了多个 `workbook_id`。
51. 计算字段→视图：反查 `field_to_view` 计算字段；`cross=main`

**落地要求**
- 在 `verify_refactor.py` 增加 51 项交叉验证输出：`main_count`、`cross_count`、`mismatch`/`gap`。  
- 生成新报告 `docs/测试验证/refactor_cross_validation.md`：逐项列出主/交叉值与 Pass/Fail。  
- 对应断言：`cross_count >= main_count`；若设计为 0（项41），则 `cross=0`；多对多项检查缺失率=0。

---

## 四、验证执行方法

### 4.1 重构前（已完成）

```bash
# 1. 备份数据库
cp metadata.db metadata_backup_20241224_before_refactor.db

# 2. 生成基准快照
python3 verify_refactor.py --snapshot before
```

**输出文件**：
- `docs/测试验证/refactor_snapshot_before.json`

### 4.2 重构后

```bash
# 1. 执行重构同步
python3 run_backend.py --task sync

# 2. 生成对比快照
python3 verify_refactor.py --snapshot after

# 3. 对比分析
python3 verify_refactor.py --compare
```

**输出文件**：
- `docs/测试验证/refactor_snapshot_after.json`
- `docs/测试验证/refactor_comparison_report.md`

---

## 五、验证通过标准

### 5.1 必须通过

- [ ] 所有记录数验证通过（非重复字段数不变）
- [ ] 所有关联表记录数不减少
- [ ] 血缘完整性不下降

### 5.2 允许的变化

- [ ] `fields` 表总数可能增加（因保留副本）
- [ ] 新增 `is_duplicate` 列标记重复项
- [ ] 新增 `lineage_*` 列存储冗余血缘信息

### 5.3 重点关注

- [ ] 计算字段的物理表关联是否正确
- [ ] 穿透型嵌入源的字段归属是否正确
- [ ] 去重映射关系是否完整

---

## 六、典型问题排查

### 6.1 字段数减少

**可能原因**：去重逻辑过于激进
**排查方法**：
```sql
-- 查看被标记为重复的字段
SELECT * FROM fields WHERE is_duplicate = 1 LIMIT 100;

-- 检查去重映射是否正确
SELECT f1.name, f1.id as duplicate_id, f2.id as survivor_id, f2.name
FROM fields f1
JOIN fields f2 ON f1.survivor_id = f2.id
WHERE f1.is_duplicate = 1
LIMIT 100;
```

### 6.2 血缘关联减少

**可能原因**：采集阶段遗漏上游信息
**排查方法**：
```sql
-- 查看丢失表关联的字段
SELECT f.id, f.name, f.datasource_id
FROM fields f
WHERE f.table_id IS NULL
AND f.is_calculated = 0
AND (f.is_duplicate IS NULL OR f.is_duplicate = 0);
```

### 6.3 计算字段无物理表

**可能原因**：递归血缘未正确追溯
**排查方法**：
```sql
-- 查看计算字段的物理表关联情况
SELECT 
    f.id, f.name, f.lineage_table_name, f.lineage_path
FROM fields f
WHERE f.is_calculated = 1
AND (f.is_duplicate IS NULL OR f.is_duplicate = 0)
AND f.lineage_table_name IS NULL
LIMIT 100;
```
