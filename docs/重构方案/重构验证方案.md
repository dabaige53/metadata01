# 重构验证方案

> **版本**: v1.0  
> **日期**: 2025-12-24  
> **状态**: 执行中

---

## 一、元数据血缘关系交叉表

> ✅ = 已建立直接/穿透关系  
> 行 = 源模块, 列 = 目标模块

| 源 \→ 目标       | 数据库 | 物理表 | 嵌入表 | 数据列 | 发布源 | 嵌入源(穿透) | 嵌入源(独立) | 工作簿 | 视图 | 字段 | 计算字段 |
| ---------------- | ------ | ------ | ------ | ------ | ------ | ------------ | ------------ | ------ | ---- | ---- | -------- |
| **数据库**       | —      | ✅      |        |        |        |              |              |        |      |      |          |
| **物理表**       | ✅      | —      |        | ✅      | ✅      |              | ✅            |        |      | ✅    |          |
| **嵌入表**       |        | ✅      | —      | ✅      |        |              | ✅            |        |      | ✅    |          |
| **数据列**       |        | ✅      | ✅      | —      |        |              |              |        |      | ✅    |          |
| **发布源**       |        | ✅      |        |        | —      | ✅            |              | ✅      |      | ✅    |          |
| **嵌入源(穿透)** |        |        |        |        | ✅      | —            |              | ✅      |      |      |          |
| **嵌入源(独立)** |        | ✅      | ✅      |        |        |              | —            | ✅      |      | ✅    |          |
| **工作簿**       | ✅      | ✅      | ✅      |        | ✅      | ✅            | ✅            | —      | ✅    | ✅    |          |
| **视图**         | ✅      | ✅      |        |        |        |              |              | ✅      | —    | ✅    |          |
| **字段**         | ✅      | ✅      | ✅      | ✅      | ✅      | ✅            | ✅            | ✅      | ✅    | —    | ✅        |
| **计算字段**     |        | ✅      |        |        |        |              |              |        |      | ✅    | —        |

### 模块定义

| 模块         | 数据库条件                                                                         |
| ------------ | ---------------------------------------------------------------------------------- |
| 物理表       | `tables WHERE is_embedded = 0`                                                     |
| 嵌入表       | `tables WHERE is_embedded = 1`（Excel/CSV/CustomSQL）                              |
| 发布源       | `datasources WHERE is_embedded = 0`                                                |
| 嵌入源(穿透) | `datasources WHERE is_embedded = 1 AND source_published_datasource_id IS NOT NULL` |
| 嵌入源(独立) | `datasources WHERE is_embedded = 1 AND source_published_datasource_id IS NULL`     |

### 关系类型说明

| 源           | 目标          | 关系字段/方式                    |
| ------------ | ------------- | -------------------------------- |
| 数据库       | 物理表        | `database_id`                    |
| 物理表       | 数据库        | `database_id`                    |
| 物理表       | 数据列        | `table_id`                       |
| 物理表       | 发布源        | `table_to_datasource`            |
| 物理表       | 嵌入源(独立)  | `table_to_datasource`            |
| 物理表       | 字段          | `table_id`                       |
| 嵌入表       | 物理表        | `upstreamTables` **穿透**        |
| 嵌入表       | 数据列        | `table_id`                       |
| 嵌入表       | 嵌入源(独立)  | `table_to_datasource`            |
| 嵌入表       | 字段          | `table_id`                       |
| 数据列       | 物理表/嵌入表 | `table_id`                       |
| 数据列       | 字段          | `upstream_column_id`             |
| 发布源       | 物理表        | `table_to_datasource`            |
| 发布源       | 嵌入源(穿透)  | `source_published_datasource_id` |
| 发布源       | 工作簿        | `datasource_to_workbook`         |
| 发布源       | 字段          | `datasource_id`                  |
| 嵌入源(穿透) | 发布源        | `source_published_datasource_id` |
| 嵌入源(穿透) | 工作簿        | `datasource_to_workbook`         |
| 嵌入源(独立) | 物理表/嵌入表 | `table_to_datasource`            |
| 嵌入源(独立) | 工作簿        | `datasource_to_workbook`         |
| 嵌入源(独立) | 字段          | `datasource_id`                  |
| 工作簿       | 发布源/嵌入源 | `datasource_to_workbook`         |
| 工作簿       | 视图          | `workbook_id`                    |
| 工作簿       | 物理表/嵌入表 | **穿透**(via 数据源)             |
| 工作簿       | 数据库        | **穿透**(via 数据源→表)          |
| 视图         | 工作簿        | `workbook_id`                    |
| 视图         | 字段          | `field_to_view`                  |
| 视图         | 物理表        | **穿透**(via 字段)               |
| 视图         | 数据库        | **穿透**(via 字段→表)            |
| 字段         | 物理表/嵌入表 | `table_id`                       |
| 字段         | 数据列        | `upstream_column_id`             |
| 字段         | 发布源/嵌入源 | `datasource_id`                  |
| 字段         | 工作簿        | `workbook_id` / **穿透**         |
| 字段         | 视图          | `field_to_view`                  |
| 字段         | 数据库        | **穿透**(via 表)                 |
| 字段         | 计算字段      | `field_dependencies`             |
| 计算字段     | 字段          | `field_dependencies`             |
| 计算字段     | 物理表        | **递归穿透**                     |

---

## 二、验证目标

确保重构后的架构（采集与处理分离）不会导致数据丢失或血缘关系断裂。

**核心验证原则**：
- 重构后的业务数据应与重构前**完全一致**
- 允许的变化：新增列（`is_duplicate`、`lineage_*` 等）
- 不允许的变化：关联关系的数量减少

---

## 二、基准快照（重构前）

**生成时间**: 2025-12-24 16:17

**表级数据统计**：

| 表名                 | 记录数 | 说明         |
| -------------------- | ------ | ------------ |
| `databases`          | 6      | 数据库连接   |
| `tables`             | 516    | 数据表       |
| `db_columns`         | 5893   | 数据库原生列 |
| `datasources`        | 172    | 数据源       |
| `workbooks`          | 80     | 工作簿       |
| `views`              | 1594   | 视图/仪表板  |
| `fields`             | 10567  | 字段         |
| `calculated_fields`  | 4926   | 计算字段详情 |
| `metrics`            | 3242   | 指标         |
| `field_dependencies` | 9809   | 字段依赖关系 |
| `field_full_lineage` | 202484 | 预计算血缘   |

---

## 三、验证项清单

### 3.1 模块一：数据库 → 其他模块

| 验证项      | 说明             | 验证 SQL                                                                                                | 预期 |
| ----------- | ---------------- | ------------------------------------------------------------------------------------------------------- | ---- |
| 数据库总数  | 不应减少         | `SELECT COUNT(*) FROM databases`                                                                        | = 6  |
| 数据库 → 表 | 每个库关联的表数 | `SELECT d.id, COUNT(t.id) FROM databases d LEFT JOIN tables t ON d.id = t.database_id GROUP BY d.id`    | 不变 |
| 无表数据库  | 孤立数据库数量   | `SELECT COUNT(*) FROM databases d WHERE NOT EXISTS (SELECT 1 FROM tables t WHERE t.database_id = d.id)` | 不变 |

---

### 3.2 模块二：数据表 → 其他模块

| 验证项       | 说明                         | 验证 SQL                                                                                                                                            | 预期   |
| ------------ | ---------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------- | ------ |
| 表总数       | 不应减少                     | `SELECT COUNT(*) FROM tables`                                                                                                                       | = 516  |
| 嵌入式表数量 | 按类型分布                   | `SELECT SUM(CASE WHEN is_embedded=1 THEN 1 ELSE 0 END) FROM tables`                                                                                 | 不变   |
| 物理表数量   | 按类型分布                   | `SELECT SUM(CASE WHEN is_embedded=0 THEN 1 ELSE 0 END) FROM tables`                                                                                 | 不变   |
| 表 → 数据源  | 关联数量                     | `SELECT COUNT(*) FROM table_to_datasource`                                                                                                          | 不减少 |
| 表 → 字段    | 每表关联的字段数（仅非重复） | `SELECT t.id, COUNT(f.id) FROM tables t LEFT JOIN fields f ON t.id = f.table_id WHERE (f.is_duplicate IS NULL OR f.is_duplicate = 0) GROUP BY t.id` | 不变   |
| 无数据源的表 | 孤立表数量                   | `SELECT COUNT(*) FROM tables t WHERE NOT EXISTS (SELECT 1 FROM table_to_datasource td WHERE td.table_id = t.id)`                                    | 不变   |

---

### 3.3 模块三：数据源 → 其他模块

| 验证项          | 说明                   | 验证 SQL                                                                                                                                 | 预期  |
| --------------- | ---------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- | ----- |
| 数据源总数      | 不应减少               | `SELECT COUNT(*) FROM datasources`                                                                                                       | = 172 |
| 嵌入式数据源    | 按类型分布             | `SELECT COUNT(*) FROM datasources WHERE is_embedded = 1`                                                                                 | 不变  |
| 发布式数据源    | 按类型分布             | `SELECT COUNT(*) FROM datasources WHERE is_embedded = 0`                                                                                 | 不变  |
| 穿透型嵌入源    | 有上游发布源的嵌入源   | `SELECT COUNT(*) FROM datasources WHERE is_embedded=1 AND source_published_datasource_id IS NOT NULL`                                    | 不变  |
| 数据源 → 表     | 每数据源关联的表数     | `SELECT ds.id, COUNT(td.table_id) FROM datasources ds LEFT JOIN table_to_datasource td ON ds.id = td.datasource_id GROUP BY ds.id`       | 不变  |
| 数据源 → 工作簿 | 每数据源关联的工作簿数 | `SELECT ds.id, COUNT(dw.workbook_id) FROM datasources ds LEFT JOIN datasource_to_workbook dw ON ds.id = dw.datasource_id GROUP BY ds.id` | 不变  |
| 数据源 → 字段   | 每数据源的字段数       | `SELECT ds.id, COUNT(f.id) FROM datasources ds LEFT JOIN fields f ON ds.id = f.datasource_id GROUP BY ds.id`                             | 不变  |

---

### 3.4 模块四：工作簿 → 其他模块

| 验证项          | 说明             | 验证 SQL                                                                                                                    | 预期   |
| --------------- | ---------------- | --------------------------------------------------------------------------------------------------------------------------- | ------ |
| 工作簿总数      | 不应减少         | `SELECT COUNT(*) FROM workbooks`                                                                                            | = 80   |
| 工作簿 → 数据源 | 关联数量         | `SELECT COUNT(*) FROM datasource_to_workbook`                                                                               | 不减少 |
| 工作簿 → 视图   | 每工作簿的视图数 | `SELECT wb.id, COUNT(v.id) FROM workbooks wb LEFT JOIN views v ON wb.id = v.workbook_id GROUP BY wb.id`                     | 不变   |
| 无数据源工作簿  | 孤立工作簿数量   | `SELECT COUNT(*) FROM workbooks wb WHERE NOT EXISTS (SELECT 1 FROM datasource_to_workbook dw WHERE dw.workbook_id = wb.id)` | 不变   |

---

### 3.5 模块五：视图 → 其他模块

| 验证项         | 说明         | 验证 SQL                                                                                                 | 预期   |
| -------------- | ------------ | -------------------------------------------------------------------------------------------------------- | ------ |
| 视图总数       | 不应减少     | `SELECT COUNT(*) FROM views`                                                                             | = 1594 |
| Sheet 数量     | 按类型分布   | `SELECT COUNT(*) FROM views WHERE view_type = 'sheet'`                                                   | 不变   |
| Dashboard 数量 | 按类型分布   | `SELECT COUNT(*) FROM views WHERE view_type = 'dashboard'`                                               | 不变   |
| 视图 → 字段    | 关联数量     | `SELECT COUNT(*) FROM field_to_view`                                                                     | 不减少 |
| 无字段视图     | 孤立视图数量 | `SELECT COUNT(*) FROM views v WHERE NOT EXISTS (SELECT 1 FROM field_to_view fv WHERE fv.view_id = v.id)` | 不变   |

---

### 3.6 模块六：字段 → 其他模块

| 验证项        | 说明                     | 验证 SQL                                                                     | 预期    |
| ------------- | ------------------------ | ---------------------------------------------------------------------------- | ------- |
| 字段总数      | 可能增加（因为保留副本） | `SELECT COUNT(*) FROM fields`                                                | ≥ 10567 |
| 非重复字段数  | 去重后的有效字段         | `SELECT COUNT(*) FROM fields WHERE is_duplicate = 0 OR is_duplicate IS NULL` | = 10567 |
| 计算字段数    | 按类型分布               | `SELECT COUNT(*) FROM fields WHERE is_calculated = 1`                        | 不变    |
| 普通字段数    | 按类型分布               | `SELECT COUNT(*) FROM fields WHERE is_calculated = 0`                        | 不变    |
| 字段 → 表     | 有表关联的字段数         | `SELECT COUNT(*) FROM fields WHERE table_id IS NOT NULL`                     | 不变    |
| 字段 → 数据源 | 有数据源关联的字段数     | `SELECT COUNT(*) FROM fields WHERE datasource_id IS NOT NULL`                | 不变    |
| 字段 → 工作簿 | 有工作簿关联的字段数     | `SELECT COUNT(*) FROM fields WHERE workbook_id IS NOT NULL`                  | 不变    |
| 字段 → 上游列 | 有上游列关联的字段数     | `SELECT COUNT(*) FROM fields WHERE upstream_column_id IS NOT NULL`           | 不变    |
| 字段 → 视图   | field_to_view 记录数     | `SELECT COUNT(*) FROM field_to_view`                                         | 不减少  |

---

### 3.7 模块七：计算字段 → 其他模块

| 验证项         | 说明                   | 验证 SQL                                                                                                                                                          | 预期   |
| -------------- | ---------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------ |
| 计算字段详情数 | calculated_fields 表   | `SELECT COUNT(*) FROM calculated_fields`                                                                                                                          | = 4926 |
| 字段依赖数     | field_dependencies 表  | `SELECT COUNT(*) FROM field_dependencies`                                                                                                                         | 不减少 |
| 依赖完整性     | 依赖字段能找到对应记录 | `SELECT COUNT(*) FROM field_dependencies fd WHERE fd.dependency_field_id IS NOT NULL AND NOT EXISTS (SELECT 1 FROM fields f WHERE f.id = fd.dependency_field_id)` | = 0    |

---

### 3.8 模块八：血缘完整性

| 验证项         | 说明                  | 验证 SQL                                                                                                                                              | 预期     |
| -------------- | --------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| 预计算血缘数   | field_full_lineage 表 | `SELECT COUNT(*) FROM field_full_lineage`                                                                                                             | ≥ 202484 |
| 字段→表→库链路 | 完整链路数            | `SELECT COUNT(*) FROM fields f JOIN tables t ON f.table_id = t.id JOIN databases db ON t.database_id = db.id`                                         | 不变     |
| 字段→源→簿链路 | 完整链路数            | `SELECT COUNT(DISTINCT f.id) FROM fields f JOIN datasources ds ON f.datasource_id = ds.id JOIN datasource_to_workbook dw ON ds.id = dw.datasource_id` | 不变     |
| 断链普通字段   | 无表关联的非计算字段  | `SELECT COUNT(*) FROM fields WHERE table_id IS NULL AND is_calculated = 0`                                                                            | 不变     |

---

### 3.9 关联表完整性

| 验证项                 | 说明              | 验证 SQL                                      | 预期   |
| ---------------------- | ----------------- | --------------------------------------------- | ------ |
| table_to_datasource    | 表→数据源关联     | `SELECT COUNT(*) FROM table_to_datasource`    | 不减少 |
| datasource_to_workbook | 数据源→工作簿关联 | `SELECT COUNT(*) FROM datasource_to_workbook` | 不减少 |
| field_to_view          | 字段→视图关联     | `SELECT COUNT(*) FROM field_to_view`          | 不减少 |
| dashboard_to_sheet     | 仪表板→图表关联   | `SELECT COUNT(*) FROM dashboard_to_sheet`     | 不减少 |

---

## 四、验证执行方法

### 4.1 重构前（已完成）

```bash
# 1. 备份数据库
cp metadata.db metadata_backup_20241224_before_refactor.db

# 2. 生成基准快照
python3 verify_refactor.py --snapshot before
```

**输出文件**：
- `docs/测试验证/refactor_snapshot_before.json`

### 4.2 重构后

```bash
# 1. 执行重构同步
python3 run_backend.py --task sync

# 2. 生成对比快照
python3 verify_refactor.py --snapshot after

# 3. 对比分析
python3 verify_refactor.py --compare
```

**输出文件**：
- `docs/测试验证/refactor_snapshot_after.json`
- `docs/测试验证/refactor_comparison_report.md`

---

## 五、验证通过标准

### 5.1 必须通过

- [ ] 所有记录数验证通过（非重复字段数不变）
- [ ] 所有关联表记录数不减少
- [ ] 血缘完整性不下降

### 5.2 允许的变化

- [ ] `fields` 表总数可能增加（因保留副本）
- [ ] 新增 `is_duplicate` 列标记重复项
- [ ] 新增 `lineage_*` 列存储冗余血缘信息

### 5.3 重点关注

- [ ] 计算字段的物理表关联是否正确
- [ ] 穿透型嵌入源的字段归属是否正确
- [ ] 去重映射关系是否完整

---

## 六、典型问题排查

### 6.1 字段数减少

**可能原因**：去重逻辑过于激进
**排查方法**：
```sql
-- 查看被标记为重复的字段
SELECT * FROM fields WHERE is_duplicate = 1 LIMIT 100;

-- 检查去重映射是否正确
SELECT f1.name, f1.id as duplicate_id, f2.id as survivor_id, f2.name
FROM fields f1
JOIN fields f2 ON f1.survivor_id = f2.id
WHERE f1.is_duplicate = 1
LIMIT 100;
```

### 6.2 血缘关联减少

**可能原因**：采集阶段遗漏上游信息
**排查方法**：
```sql
-- 查看丢失表关联的字段
SELECT f.id, f.name, f.datasource_id
FROM fields f
WHERE f.table_id IS NULL
AND f.is_calculated = 0
AND (f.is_duplicate IS NULL OR f.is_duplicate = 0);
```

### 6.3 计算字段无物理表

**可能原因**：递归血缘未正确追溯
**排查方法**：
```sql
-- 查看计算字段的物理表关联情况
SELECT 
    f.id, f.name, f.lineage_table_name, f.lineage_path
FROM fields f
WHERE f.is_calculated = 1
AND (f.is_duplicate IS NULL OR f.is_duplicate = 0)
AND f.lineage_table_name IS NULL
LIMIT 100;
```
