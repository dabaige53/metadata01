# è®¡ç®—å­—æ®µåŒæ­¥æ¶æ„é‡æ„æ–¹æ¡ˆ

> **ç‰ˆæœ¬**: v2.0  
> **æ—¥æœŸ**: 2025-12-24  
> **çŠ¶æ€**: å¾…è¯„å®¡

---

# ç¬¬ä¸€éƒ¨åˆ†ï¼šæ€»ä½“æ¦‚è¿°

## ä¸€ã€èƒŒæ™¯ä¸é—®é¢˜

### 1.1 å½“å‰æ¶æ„åˆ†æ

ç³»ç»Ÿå½“å‰çš„ `backend/tableau_sync.py` æ–‡ä»¶æ‰¿æ‹…äº†è¿‡å¤šèŒè´£ï¼Œå°†æ•°æ®é‡‡é›†ã€å»é‡åˆ¤æ–­ã€è¡€ç¼˜è®¡ç®—ç­‰é€»è¾‘è€¦åˆåœ¨ä¸€èµ·ã€‚

**ç°æœ‰æµç¨‹**ï¼š
```
è°ƒç”¨ Tableau API è·å–æ•°æ®
    â†“
è¾¹é‡‡é›†è¾¹åˆ¤æ–­æ˜¯å¦é‡å¤ï¼ˆåœ¨å†…å­˜ä¸­ç»´æŠ¤ç¼“å­˜ï¼‰
    â†“
â”œâ”€â”€ é‡å¤ï¼šè·³è¿‡ï¼Œä¸å†™å…¥æ•°æ®åº“
â””â”€â”€ ä¸é‡å¤ï¼šå†™å…¥æ•°æ®åº“
    â†“
åŒæ­¥å®Œæˆåï¼Œæ‰§è¡Œç»Ÿè®¡é¢„è®¡ç®—
```

**é—®é¢˜åˆ†æ**ï¼š

| é—®é¢˜ç±»å‹         | å…·ä½“è¡¨ç°                         | äº§å“å½±å“                   |
| ---------------- | -------------------------------- | -------------------------- |
| **èŒè´£è€¦åˆ**     | é‡‡é›†ä»£ç ä¸­å¤¹æ‚å»é‡é€»è¾‘           | éš¾ä»¥è°ƒè¯•ã€ç»´æŠ¤å›°éš¾         |
| **æ•°æ®ä¸¢å¤±é£é™©** | é‡å¤é¡¹ç›´æ¥è·³è¿‡ï¼Œä¸ä¿ç•™åŸå§‹è®°å½•   | æ— æ³•äº‹åå®¡è®¡æˆ–è°ƒæ•´å»é‡ç­–ç•¥ |
| **è¡€ç¼˜æ–­è£‚**     | è®¡ç®—å­—æ®µæ— ç‰©ç†è¡¨å…³è”æ—¶ç›´æ¥è·³è¿‡   | ç”¨æˆ·çœ‹ä¸åˆ°å®Œæ•´çš„æ•°æ®æ¥æº   |
| **æŸ¥è¯¢å¤æ‚**     | å±•ç¤ºæ—¶éœ€è¦å¤šè¡¨ JOIN è·å–è¡€ç¼˜ä¿¡æ¯ | API å“åº”æ…¢ã€å‰ç«¯é€»è¾‘å¤æ‚   |

### 1.2 é‡æ„ç›®æ ‡

1. **èŒè´£åˆ†ç¦»**ï¼šå°†é‡‡é›†ã€å¤„ç†ã€é¢„è®¡ç®—æ‹†åˆ†ä¸ºç‹¬ç«‹æ¨¡å—
2. **æ•°æ®å®Œæ•´**ï¼šé‡‡é›†é˜¶æ®µå…¨é‡å­˜å‚¨ï¼Œåç½®é˜¶æ®µæ ‡è®°å»é‡
3. **è¡€ç¼˜é¢„å­˜**ï¼šé€šè¿‡å†—ä½™åˆ—æ¶ˆé™¤å¤æ‚ JOIN
4. **å¯è¿½æº¯**ï¼šä¿ç•™å»é‡æ˜ å°„å…³ç³»ï¼Œæ”¯æŒäº‹åå®¡è®¡

---

## äºŒã€é‡æ„åæ¶æ„

### 2.1 æ–‡ä»¶ç»“æ„

```
backend/
â”œâ”€â”€ tableau_collector.py   # [æ–°å»º] çº¯é‡‡é›†æ¨¡å—
â”œâ”€â”€ metadata_processor.py  # [æ–°å»º] åç½®å¤„ç†æ¨¡å—
â”œâ”€â”€ tableau_sync.py        # [æ”¹é€ ] è°ƒåº¦å…¥å£
â””â”€â”€ models.py              # [ä¿®æ”¹] æ–°å¢å†—ä½™åˆ—
```

### 2.2 æ–°æµç¨‹è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ1ï¼šçº¯é‡‡é›†ï¼ˆtableau_collector.pyï¼‰                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è°ƒç”¨ Tableau API è·å–æ•°æ®                                       â”‚
â”‚      â†“                                                           â”‚
â”‚  å…¨é‡å†™å…¥æ•°æ®åº“ï¼ˆä¸åšä»»ä½•å»é‡åˆ¤æ–­ï¼‰                              â”‚
â”‚  - æ¯ä¸ªå­—æ®µéƒ½ä¿ç•™åŸå§‹ ID                                         â”‚
â”‚  - å³ä½¿æ˜¯å‰¯æœ¬ä¹Ÿå®Œæ•´å­˜å‚¨                                          â”‚
â”‚  - æ ‡è®° is_raw = 1ï¼ˆåŸå§‹é‡‡é›†çŠ¶æ€ï¼‰                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ2ï¼šåç½®å»é‡ï¼ˆmetadata_processor.pyï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ‰«æå·²é‡‡é›†çš„æ•°æ®ï¼Œè¯†åˆ«é‡å¤é¡¹                                    â”‚
â”‚      â†“                                                           â”‚
â”‚  â”œâ”€â”€ æ™®é€šå­—æ®µï¼šæŒ‰ (table_name, column_name) å»é‡                 â”‚
â”‚  â””â”€â”€ è®¡ç®—å­—æ®µï¼šæŒ‰ (name, formula_hash) å»é‡                      â”‚
â”‚      â†“                                                           â”‚
â”‚  æ ‡è®°å»é‡å…³ç³»ï¼š                                                   â”‚
â”‚  - è®¾ç½® is_duplicate = 1ï¼ˆé‡å¤é¡¹ï¼‰                               â”‚
â”‚  - è®¾ç½® survivor_id = å­˜æ´»è®°å½•çš„ ID                              â”‚
â”‚  - ä¿ç•™åŸå§‹è®°å½•ï¼Œä¸åˆ é™¤                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ3ï¼šè¡€ç¼˜é¢„è®¡ç®—ï¼ˆmetadata_processor.pyï¼‰                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  éå†æ‰€æœ‰å­—æ®µï¼Œå¡«å……å†—ä½™è¡€ç¼˜åˆ—                                    â”‚
â”‚      â†“                                                           â”‚
â”‚  â”œâ”€â”€ æ™®é€šå­—æ®µï¼šä» table_id â†’ database_id è¿½æº¯                   â”‚
â”‚  â””â”€â”€ è®¡ç®—å­—æ®µï¼šé€’å½’è§£æå…¬å¼ï¼Œæ±‡æ€»æ‰€æœ‰ä¾èµ–å­—æ®µçš„ç‰©ç†è¡¨            â”‚
â”‚      â†“                                                           â”‚
â”‚  å†™å…¥ lineage_* å†—ä½™åˆ—                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ4ï¼šç»Ÿè®¡é¢„å­˜ï¼ˆmetadata_processor.pyï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ›´æ–° usage_countã€metric_usage_count ç­‰é¢„è®¡ç®—å­—æ®µ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ç¬¬äºŒéƒ¨åˆ†ï¼šå„æ¨¡å—è¯¦è§£

---

## æ¨¡å—ä¸€ï¼šé‡‡é›†æ¨¡å— (tableau_collector.py)

### 1. åŸºæœ¬èŒè´£

**ä¸šåŠ¡å«ä¹‰**ï¼šçº¯ç²¹çš„æ•°æ®é‡‡é›†å™¨ï¼Œè´Ÿè´£ä» Tableau API è·å–åŸå§‹æ•°æ®å¹¶å…¨é‡å†™å…¥æ•°æ®åº“ã€‚

**è®¾è®¡åŸåˆ™**ï¼š
- åªè´Ÿè´£"æ‹‰å– + å­˜å‚¨"
- ä¸åšä»»ä½•ä¸šåŠ¡åˆ¤æ–­ï¼ˆå»é‡ã€è¿‡æ»¤ç­‰ï¼‰
- ä¿ç•™æ‰€æœ‰åŸå§‹ ID

---

### 2. ç±»è®¾è®¡

```python
class TableauCollector:
    """Tableau æ•°æ®é‡‡é›†å™¨ï¼ˆçº¯é‡‡é›†ï¼Œæ— ä¸šåŠ¡é€»è¾‘ï¼‰"""
    
    def __init__(self, client: TableauMetadataClient, session):
        self.client = client
        self.session = session
    
    def collect_all(self):
        """æ‰§è¡Œå…¨é‡é‡‡é›†"""
        self.collect_databases()
        self.collect_tables()
        self.collect_datasources()
        self.collect_workbooks()
        self.collect_views()
        self.collect_fields()
        self.collect_calculated_fields()
        self.collect_field_to_view_raw()
```

---

### 3. é‡‡é›†æ–¹æ³•è¯¦è§£

#### 3.1 collect_fields()

**èŒè´£**ï¼šé‡‡é›†æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬å‘å¸ƒå¼å’ŒåµŒå…¥å¼ï¼‰ï¼Œå…¨é‡å†™å…¥ã€‚

**ä¸åŸæœ‰é€»è¾‘çš„åŒºåˆ«**ï¼š

| å¯¹æ¯”é¡¹   | åŸæœ‰é€»è¾‘               | æ–°é€»è¾‘                           |
| -------- | ---------------------- | -------------------------------- |
| å»é‡åˆ¤æ–­ | é‡‡é›†æ—¶åˆ¤æ–­ï¼Œé‡å¤åˆ™è·³è¿‡ | ä¸åˆ¤æ–­ï¼Œå…¨é‡å†™å…¥                 |
| ç¼“å­˜ç»´æŠ¤ | å†…å­˜ä¸­ç»´æŠ¤ä¸‰çº§ç¼“å­˜     | æ— ç¼“å­˜                           |
| ç©¿é€å¤„ç† | é‡‡é›†æ—¶ç©¿é€åˆ°å‘å¸ƒæº     | ä»…è®°å½•åŸå§‹ä¿¡æ¯ï¼Œç©¿é€äº¤ç»™åç½®å¤„ç† |

**è¯¦ç»†è¿‡ç¨‹**ï¼š
```
éå†æ‰€æœ‰æ•°æ®æºï¼š
    â†“
è°ƒç”¨ API è·å–è¯¥æ•°æ®æºçš„æ‰€æœ‰å­—æ®µ
    â†“
å¯¹æ¯ä¸ªå­—æ®µï¼š
    â†“
    æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥ ID
    â†“
    â”œâ”€ å­˜åœ¨ï¼šæ›´æ–°è®°å½•
    â””â”€ ä¸å­˜åœ¨ï¼šæ–°å¢è®°å½•
    â†“
    ä¿å­˜ä»¥ä¸‹å­—æ®µï¼š
       id = å­—æ®µåŸå§‹ ID
       name = å­—æ®µåç§°
       datasource_id = æ‰€å±æ•°æ®æº IDï¼ˆåŸå§‹å€¼ï¼Œä¸ç©¿é€ï¼‰
       workbook_id = æ‰€å±å·¥ä½œç°¿ IDï¼ˆå¦‚æœ‰ï¼‰
       is_calculated = æ˜¯å¦è®¡ç®—å­—æ®µ
       formula = å…¬å¼ï¼ˆå¦‚æœ‰ï¼‰
       ...å…¶ä»–å±æ€§
    â†“
    åŒæ—¶ä¿å­˜ä¸Šæ¸¸ä¿¡æ¯ï¼ˆç”¨äºåç½®å¤„ç†ï¼‰ï¼š
       raw_upstream_column_id = upstreamColumns[0].idï¼ˆåŸå§‹å€¼ï¼‰
       raw_upstream_table_id = upstreamColumns[0].table.idï¼ˆåŸå§‹å€¼ï¼‰
       raw_upstream_table_type = upstreamColumns[0].table.__typename
```

**ä»£ç ç¤ºä¾‹**ï¼š
```python
def collect_fields(self) -> int:
    """é‡‡é›†æ‰€æœ‰å­—æ®µï¼ˆå…¨é‡å†™å…¥ï¼Œä¸å»é‡ï¼‰"""
    print("\nğŸ“¥ é‡‡é›†å­—æ®µ...")
    count = 0
    
    # è·å–æ‰€æœ‰æ•°æ®æºï¼ˆå«åµŒå…¥å¼ï¼‰
    datasources = self.session.query(Datasource).all()
    
    for ds in datasources:
        fields_data = self.client.fetch_fields_for_datasource(ds.id)
        
        for f_data in fields_data:
            if not f_data or not f_data.get("id"):
                continue
            
            # è·å–æˆ–åˆ›å»ºè®°å½•
            field = self.session.query(Field).filter_by(id=f_data["id"]).first()
            if not field:
                field = Field(id=f_data["id"])
                self.session.add(field)
            
            # ä¿å­˜åŸå§‹ä¿¡æ¯ï¼ˆä¸åšç©¿é€å¤„ç†ï¼‰
            field.name = f_data.get("name") or ""
            field.datasource_id = ds.id  # åŸå§‹æ•°æ®æº ID
            field.is_calculated = f_data.get("isCalculated") or False
            field.formula = f_data.get("formula")
            
            # ä¿å­˜ä¸Šæ¸¸åŸå§‹ä¿¡æ¯ï¼ˆç”¨äºåç½®å¤„ç†ï¼‰
            upstream_cols = f_data.get("upstreamColumns") or []
            if upstream_cols:
                first_col = upstream_cols[0]
                field.raw_upstream_column_id = first_col.get("id")
                field.raw_upstream_column_name = first_col.get("name")
                if first_col.get("table"):
                    field.raw_upstream_table_id = first_col["table"].get("id")
                    field.raw_upstream_table_type = first_col["table"].get("__typename")
            
            count += 1
    
    self.session.commit()
    print(f"  âœ… é‡‡é›† {count} ä¸ªå­—æ®µ")
    return count
```

---

## æ¨¡å—äºŒï¼šå¤„ç†æ¨¡å— (metadata_processor.py)

### 1. åŸºæœ¬èŒè´£

**ä¸šåŠ¡å«ä¹‰**ï¼šå¯¹å·²é‡‡é›†çš„åŸå§‹æ•°æ®è¿›è¡Œåç½®å¤„ç†ï¼ŒåŒ…æ‹¬å»é‡æ ‡è®°ã€è¡€ç¼˜é¢„è®¡ç®—ã€ç»Ÿè®¡é¢„å­˜ã€‚

**è®¾è®¡åŸåˆ™**ï¼š
- åªè¯»å–æ•°æ®åº“ä¸­çš„å·²é‡‡é›†æ•°æ®
- ä¸è°ƒç”¨å¤–éƒ¨ API
- æ‰€æœ‰æ“ä½œå¯é‡å¤æ‰§è¡Œï¼ˆå¹‚ç­‰æ€§ï¼‰

---

### 2. ç±»è®¾è®¡

```python
class MetadataProcessor:
    """å…ƒæ•°æ®åç½®å¤„ç†å™¨"""
    
    def __init__(self, session):
        self.session = session
        self.deduplication_map = {}  # skipped_id -> survivor_id
    
    def process_all(self):
        """æ‰§è¡Œå…¨éƒ¨å¤„ç†"""
        self.deduplicate_fields()
        self.deduplicate_calculated_fields()
        self.compute_field_lineage()
        self.compute_stats()
```

---

### 3. å­—æ®µå»é‡è¯¦è§£

#### 3.1 ä¸ºä»€ä¹ˆè¦å»é‡ï¼Ÿ

åŒä¸€ä¸ªå­—æ®µåœ¨ç³»ç»Ÿä¸­å¯èƒ½å­˜åœ¨å¤šä¸ªå‰¯æœ¬ï¼š

| åœºæ™¯                         | è¯´æ˜                             | å‰¯æœ¬æ•°é‡                   |
| ---------------------------- | -------------------------------- | -------------------------- |
| å‘å¸ƒå¼æ•°æ®æºè¢«å¤šä¸ªå·¥ä½œç°¿å¼•ç”¨ | æ¯ä¸ªå·¥ä½œç°¿éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªåµŒå…¥å¼å‰¯æœ¬ | 1 + Nï¼ˆ1ä¸ªå‘å¸ƒ + Nä¸ªåµŒå…¥ï¼‰ |
| ç‹¬ç«‹ç›´è¿åµŒå…¥å¼æ•°æ®æº         | å¤šä¸ªå·¥ä½œç°¿å„è‡ªè¿æ¥åŒä¸€ä¸ª Excel   | Nï¼ˆæ¯ä¸ªå·¥ä½œç°¿ä¸€ä¸ªï¼‰        |
| è®¡ç®—å­—æ®µè¢«å¤åˆ¶               | å¤åˆ¶å·¥ä½œç°¿æ—¶ï¼Œè®¡ç®—å­—æ®µä¹Ÿè¢«å¤åˆ¶   | Mï¼ˆæ¯æ¬¡å¤åˆ¶ä¸€ä¸ªï¼‰          |

**å¦‚æœä¸å»é‡**ï¼š
- æœç´¢"é”€å”®é¢"ä¼šå‡ºç° N ä¸ªç»“æœ
- æ— æ³•ç¡®å®šå“ªä¸ªæ˜¯"æƒå¨å®šä¹‰"
- ç»Ÿè®¡æ•°æ®è†¨èƒ€ï¼ˆå­—æ®µæ•°è¿œè¶…å®é™…ä¸šåŠ¡å­—æ®µæ•°ï¼‰

#### 3.2 å»é‡ç­–ç•¥è®¾è®¡

> [!IMPORTANT]
> å»é‡é‡‡ç”¨**ä¸‰çº§ç¼“å­˜æœºåˆ¶**ï¼šç¬¬ä¸€çº§æŒ‰æ•°æ®æº+å­—æ®µåï¼Œç¬¬äºŒçº§æŒ‰ç‰©ç†è¡¨å+åˆ—åï¼Œç¬¬ä¸‰çº§æŒ‰å…¬å¼å“ˆå¸Œã€‚

**ä¸‰çº§ç¼“å­˜ç»“æ„**ï¼š

| çº§åˆ« | ç¼“å­˜åç§°                | Key ç»“æ„                    | Value      | é€‚ç”¨åœºæ™¯           |
| ---- | ----------------------- | --------------------------- | ---------- | ------------------ |
| ä¸€çº§ | `published_field_cache` | `(datasource_id, name)`     | `field_id` | ç©¿é€å‹åµŒå…¥å¼å­—æ®µ   |
| äºŒçº§ | `physical_column_cache` | `(table_name, column_name)` | `field_id` | ç‹¬ç«‹ç›´è¿å‹æ™®é€šå­—æ®µ |
| ä¸‰çº§ | `calc_field_cache`      | `(name, formula_hash)`      | `field_id` | è®¡ç®—å­—æ®µ           |

**å»é‡æµç¨‹**ï¼š

```
æ‰«æ fields è¡¨ä¸­æ‰€æœ‰è®°å½•ï¼š
    â†“
ç¬¬ä¸€é˜¶æ®µï¼šè¯†åˆ«å‘å¸ƒå¼æ•°æ®æºå­—æ®µï¼ˆæ„å»ºåŸºå‡†ï¼‰
    â†“
    éå†æ‰€æœ‰ is_embedded = 0 çš„æ•°æ®æºçš„å­—æ®µï¼š
    â†“
    å¯¹æ¯ä¸ªå­—æ®µï¼š
        â”œâ”€â”€ åŠ å…¥ä¸€çº§ç¼“å­˜ï¼špublished_field_cache[(ds_id, name)] = field_id
        â”œâ”€â”€ è§£æ raw_upstream_column ä¿¡æ¯
        â”‚   â””â”€â”€ åŠ å…¥äºŒçº§ç¼“å­˜ï¼šphysical_column_cache[(table_name, col_name)] = field_id
        â””â”€â”€ å¦‚æœæ˜¯è®¡ç®—å­—æ®µï¼š
            è®¡ç®— formula_hash = MD5(normalize(formula))
            åŠ å…¥ä¸‰çº§ç¼“å­˜ï¼šcalc_field_cache[(name, formula_hash)] = field_id
    â†“
ç¬¬äºŒé˜¶æ®µï¼šæ‰«æåµŒå…¥å¼æ•°æ®æºå­—æ®µï¼ˆæŸ¥é‡æ ‡è®°ï¼‰
    â†“
    éå†æ‰€æœ‰ is_embedded = 1 çš„æ•°æ®æºçš„å­—æ®µï¼š
    â†“
    å¯¹æ¯ä¸ªå­—æ®µï¼š
        â†“
        æ£€æŸ¥ä¸€çº§ç¼“å­˜ï¼ˆç©¿é€å‹å‰¯æœ¬ï¼‰ï¼š
            è·å–è¯¥åµŒå…¥æºçš„ source_published_datasource_id
            key = (source_published_datasource_id, name)
            â†“
            â”œâ”€â”€ å‘½ä¸­ï¼šæ ‡è®° is_duplicate = 1, survivor_id = ç¼“å­˜å€¼
            â”‚         è®°å½• deduplication_map[å½“å‰ID] = ç¼“å­˜å€¼
            â”‚         continueï¼ˆè·³è¿‡åç»­æ£€æŸ¥ï¼‰
            â”‚
            â””â”€â”€ æœªå‘½ä¸­ï¼šç»§ç»­æ£€æŸ¥äºŒçº§ç¼“å­˜
        â†“
        æ£€æŸ¥äºŒçº§ç¼“å­˜ï¼ˆç‹¬ç«‹ç›´è¿å‹æ™®é€šå­—æ®µï¼‰ï¼š
            ä» raw_upstream_table_name + raw_upstream_column_name æ„å»º key
            â†“
            â”œâ”€â”€ å‘½ä¸­ï¼šæ ‡è®° is_duplicate = 1, survivor_id = ç¼“å­˜å€¼
            â”‚
            â””â”€â”€ æœªå‘½ä¸­ï¼šç»§ç»­æ£€æŸ¥ä¸‰çº§ç¼“å­˜ï¼ˆå¦‚æœæ˜¯è®¡ç®—å­—æ®µï¼‰
        â†“
        æ£€æŸ¥ä¸‰çº§ç¼“å­˜ï¼ˆè®¡ç®—å­—æ®µï¼‰ï¼š
            è®¡ç®— formula_hash
            key = (name, formula_hash)
            â†“
            â”œâ”€â”€ å‘½ä¸­ï¼šæ ‡è®° is_duplicate = 1, survivor_id = ç¼“å­˜å€¼
            â”‚
            â””â”€â”€ æœªå‘½ä¸­ï¼šè¿™æ˜¯æ–°å­—æ®µï¼Œä¿ç•™
                åŠ å…¥å¯¹åº”ç¼“å­˜
```

**ä»£ç ç¤ºä¾‹**ï¼š
```python
def deduplicate_fields(self):
    """å­—æ®µå»é‡ï¼ˆåç½®æ ‡è®°ï¼Œä¸åˆ é™¤ï¼‰"""
    print("\nâš™ï¸ æ‰§è¡Œå­—æ®µå»é‡...")
    
    # åˆå§‹åŒ–ç¼“å­˜
    published_field_cache = {}   # (ds_id, name) -> field_id
    physical_column_cache = {}   # (table_name, col_name) -> field_id
    calc_field_cache = {}        # (name, formula_hash) -> field_id
    
    # ç¬¬ä¸€é˜¶æ®µï¼šå¤„ç†å‘å¸ƒå¼æ•°æ®æºå­—æ®µï¼Œæ„å»ºç¼“å­˜
    published_ds_ids = self.session.execute(
        text("SELECT id FROM datasources WHERE is_embedded = 0")
    ).scalars().all()
    
    published_fields = self.session.query(Field).filter(
        Field.datasource_id.in_(published_ds_ids)
    ).all()
    
    for f in published_fields:
        # ä¸€çº§ç¼“å­˜
        if f.datasource_id and f.name:
            published_field_cache[(f.datasource_id, f.name)] = f.id
        
        # äºŒçº§ç¼“å­˜
        if f.raw_upstream_table_name and f.raw_upstream_column_name:
            key = (f.raw_upstream_table_name, f.raw_upstream_column_name)
            physical_column_cache[key] = f.id
        
        # ä¸‰çº§ç¼“å­˜ï¼ˆè®¡ç®—å­—æ®µï¼‰
        if f.is_calculated and f.formula:
            norm_formula = "".join(f.formula.split()).lower()
            formula_hash = hashlib.md5(norm_formula.encode()).hexdigest()
            calc_field_cache[(f.name, formula_hash)] = f.id
    
    # ç¬¬äºŒé˜¶æ®µï¼šå¤„ç†åµŒå…¥å¼æ•°æ®æºå­—æ®µï¼ŒæŸ¥é‡æ ‡è®°
    embedded_ds = self.session.query(Datasource).filter_by(is_embedded=True).all()
    
    duplicate_count = 0
    for ds in embedded_ds:
        fields = self.session.query(Field).filter_by(datasource_id=ds.id).all()
        
        for f in fields:
            survivor_id = None
            
            # æ£€æŸ¥ä¸€çº§ç¼“å­˜
            if ds.source_published_datasource_id:
                key = (ds.source_published_datasource_id, f.name)
                if key in published_field_cache:
                    survivor_id = published_field_cache[key]
            
            # æ£€æŸ¥äºŒçº§ç¼“å­˜
            if not survivor_id:
                if f.raw_upstream_table_name and f.raw_upstream_column_name:
                    key = (f.raw_upstream_table_name, f.raw_upstream_column_name)
                    if key in physical_column_cache:
                        survivor_id = physical_column_cache[key]
            
            # æ£€æŸ¥ä¸‰çº§ç¼“å­˜
            if not survivor_id and f.is_calculated and f.formula:
                norm_formula = "".join(f.formula.split()).lower()
                formula_hash = hashlib.md5(norm_formula.encode()).hexdigest()
                key = (f.name, formula_hash)
                if key in calc_field_cache:
                    survivor_id = calc_field_cache[key]
            
            # æ ‡è®°é‡å¤
            if survivor_id and survivor_id != f.id:
                f.is_duplicate = True
                f.survivor_id = survivor_id
                self.deduplication_map[f.id] = survivor_id
                duplicate_count += 1
            else:
                # æ–°å­—æ®µï¼ŒåŠ å…¥ç¼“å­˜
                if f.raw_upstream_table_name and f.raw_upstream_column_name:
                    key = (f.raw_upstream_table_name, f.raw_upstream_column_name)
                    if key not in physical_column_cache:
                        physical_column_cache[key] = f.id
                
                if f.is_calculated and f.formula:
                    norm_formula = "".join(f.formula.split()).lower()
                    formula_hash = hashlib.md5(norm_formula.encode()).hexdigest()
                    key = (f.name, formula_hash)
                    if key not in calc_field_cache:
                        calc_field_cache[key] = f.id
    
    self.session.commit()
    print(f"  âœ… æ ‡è®° {duplicate_count} ä¸ªé‡å¤å­—æ®µ")
```

---

### 4. è¡€ç¼˜é¢„è®¡ç®—è¯¦è§£

#### 4.1 ä¸ºä»€ä¹ˆè¦é¢„è®¡ç®—è¡€ç¼˜ï¼Ÿ

**é—®é¢˜**ï¼šå­—æ®µçš„è¡€ç¼˜ä¿¡æ¯åˆ†æ•£åœ¨å¤šä¸ªè¡¨ä¸­ï¼ŒæŸ¥è¯¢æ—¶éœ€è¦å¤šå±‚ JOINã€‚

**ç°æœ‰æŸ¥è¯¢å¤æ‚åº¦**ï¼š
```sql
-- è·å–å­—æ®µçš„å®Œæ•´è¡€ç¼˜ä¿¡æ¯
SELECT f.*, 
       col.name AS column_name,
       t.name AS table_name, t.schema AS table_schema,
       db.name AS database_name,
       ds.name AS datasource_name
FROM fields f
LEFT JOIN db_columns col ON f.upstream_column_id = col.id
LEFT JOIN tables t ON f.table_id = t.id
LEFT JOIN databases db ON t.database_id = db.id
LEFT JOIN datasources ds ON f.datasource_id = ds.id
WHERE f.id = ?
```

**é¢„è®¡ç®—å**ï¼š
```sql
-- ç›´æ¥è¯»å–å†—ä½™åˆ—
SELECT * FROM fields WHERE id = ?
-- æ‰€æœ‰è¡€ç¼˜ä¿¡æ¯å·²åœ¨ lineage_* åˆ—ä¸­
```

#### 4.2 è¡€ç¼˜é¢„è®¡ç®—æµç¨‹

**æ™®é€šå­—æ®µå¤„ç†**ï¼š
```
éå†æ‰€æœ‰éè®¡ç®—å­—æ®µï¼š
    â†“
ä» raw_upstream_table_id è·å–è¡¨ä¿¡æ¯ï¼š
    â†“
    æ£€æŸ¥è¡¨ç±»å‹ (raw_upstream_table_type)ï¼š
    â†“
    â”œâ”€â”€ DatabaseTableï¼ˆç‰©ç†è¡¨ï¼‰ï¼š
    â”‚       ç›´æ¥ä½¿ç”¨è¯¥è¡¨ä¿¡æ¯
    â”‚       å¡«å…… lineage_table_id = è¡¨ ID
    â”‚       å¡«å…… lineage_table_name = è¡¨å
    â”‚       â†“
    â”‚       ä»è¡¨çš„ database_id è·å–æ•°æ®åº“ä¿¡æ¯
    â”‚       å¡«å…… lineage_database_id = åº“ ID
    â”‚       å¡«å…… lineage_database_name = åº“å
    â”‚
    â””â”€â”€ EmbeddedTable / CustomSQLTableï¼ˆåµŒå…¥å¼è¡¨ï¼‰ï¼š
            å°è¯•ç©¿é€ï¼š
            â†“
            æŸ¥è¯¢è¯¥è¡¨çš„ upstreamTables
            â†“
            â”œâ”€â”€ æœ‰å€¼ï¼šå–ç¬¬ä¸€ä¸ªç‰©ç†è¡¨ï¼Œå¡«å……è¡€ç¼˜ä¿¡æ¯
            â””â”€â”€ æ— å€¼ï¼šå¡«å……åµŒå…¥è¡¨ä¿¡æ¯ï¼Œæ ‡è®° lineage_path = "Embedded (æ— æ³•ç©¿é€)"
```

**è®¡ç®—å­—æ®µå¤„ç†ï¼ˆé€’å½’è¿½æº¯ï¼‰**ï¼š
```
éå†æ‰€æœ‰è®¡ç®—å­—æ®µï¼š
    â†“
è§£æå…¬å¼ä¸­çš„ä¾èµ–å­—æ®µï¼š
    ä½¿ç”¨æ­£åˆ™ \[(.*?)\] æå–æ‰€æœ‰å¼•ç”¨
    ä¾‹å¦‚ "[é”€å”®é¢] / [è®¢å•æ•°]" â†’ ["é”€å”®é¢", "è®¢å•æ•°"]
    â†“
é€’å½’æŸ¥æ‰¾ä¾èµ–å­—æ®µçš„ç‰©ç†è¡¨ï¼š
    â†“
    å¯¹æ¯ä¸ªä¾èµ–å­—æ®µï¼š
    â”œâ”€â”€ å¦‚æœæ˜¯æ™®é€šå­—æ®µï¼šè·å–å…¶ lineage_table_id
    â””â”€â”€ å¦‚æœæ˜¯è®¡ç®—å­—æ®µï¼šé€’å½’è§£æå…¶ä¾èµ–
    â†“
æ±‡æ€»æ‰€æœ‰åº•å±‚ç‰©ç†è¡¨ï¼š
    å»é‡åå¾—åˆ° table_id åˆ—è¡¨
    â†“
å¡«å……è¡€ç¼˜ä¿¡æ¯ï¼š
    lineage_table_id = ç¬¬ä¸€ä¸ªè¡¨ IDï¼ˆä¸»ä¾èµ–ï¼‰
    lineage_all_table_ids = JSON æ•°ç»„ï¼ˆæ‰€æœ‰ä¾èµ–è¡¨ï¼‰
    lineage_path = "CalcField â†’ é”€å”®é¢ â†’ Table A; è®¢å•æ•° â†’ Table B"
```

**ä»£ç ç¤ºä¾‹**ï¼š
```python
def compute_field_lineage(self):
    """é¢„è®¡ç®—å­—æ®µè¡€ç¼˜ï¼ˆå¡«å……å†—ä½™åˆ—ï¼‰"""
    print("\nâš™ï¸ é¢„è®¡ç®—å­—æ®µè¡€ç¼˜...")
    
    # æ„å»ºè¾…åŠ©æŸ¥æ‰¾è¡¨
    tables = {t.id: t for t in self.session.query(DBTable).all()}
    databases = {db.id: db for db in self.session.query(Database).all()}
    datasources = {ds.id: ds for ds in self.session.query(Datasource).all()}
    
    fields = self.session.query(Field).filter_by(is_duplicate=False).all()
    
    for f in fields:
        # å¡«å……æ•°æ®æºåç§°
        if f.datasource_id and f.datasource_id in datasources:
            f.lineage_datasource_name = datasources[f.datasource_id].name
        
        if not f.is_calculated:
            # æ™®é€šå­—æ®µï¼šç›´æ¥è¿½æº¯
            self._compute_direct_lineage(f, tables, databases)
        else:
            # è®¡ç®—å­—æ®µï¼šé€’å½’è¿½æº¯
            self._compute_calc_lineage(f, tables, databases)
    
    self.session.commit()
    print(f"  âœ… é¢„è®¡ç®— {len(fields)} ä¸ªå­—æ®µçš„è¡€ç¼˜")

def _compute_direct_lineage(self, field, tables, databases):
    """è®¡ç®—æ™®é€šå­—æ®µçš„ç›´æ¥è¡€ç¼˜"""
    table_id = field.raw_upstream_table_id
    table_type = field.raw_upstream_table_type
    
    # åµŒå…¥å¼è¡¨ç©¿é€
    if table_type in ("EmbeddedTable", "CustomSQLTable"):
        if table_id and table_id in tables:
            tbl = tables[table_id]
            # å°è¯•ä» upstreamTables è·å–ç‰©ç†è¡¨
            # ... (ç©¿é€é€»è¾‘)
    
    # å¡«å……è¡¨ä¿¡æ¯
    if table_id and table_id in tables:
        tbl = tables[table_id]
        field.lineage_table_id = tbl.id
        field.lineage_table_name = tbl.name
        field.lineage_table_schema = tbl.schema
        
        # å¡«å……æ•°æ®åº“ä¿¡æ¯
        if tbl.database_id and tbl.database_id in databases:
            db = databases[tbl.database_id]
            field.lineage_database_id = db.id
            field.lineage_database_name = db.name
        
        field.lineage_path = f"Field â†’ {tbl.name} â†’ {db.name if db else '?'}"

def _compute_calc_lineage(self, field, tables, databases, visited=None):
    """è®¡ç®—è®¡ç®—å­—æ®µçš„é€’å½’è¡€ç¼˜"""
    if visited is None:
        visited = set()
    
    if field.id in visited:
        return set()  # é¿å…å¾ªç¯ä¾èµ–
    visited.add(field.id)
    
    # è§£æå…¬å¼ä¸­çš„ä¾èµ–
    formula = field.formula or ""
    refs = re.findall(r'\[(.*?)\]', formula)
    
    all_table_ids = set()
    
    for ref_name in set(refs):
        # æŸ¥æ‰¾ä¾èµ–å­—æ®µ
        dep_field = self.session.query(Field).filter_by(
            datasource_id=field.datasource_id,
            name=ref_name,
            is_duplicate=False
        ).first()
        
        if dep_field:
            if dep_field.is_calculated:
                # é€’å½’
                sub_tables = self._compute_calc_lineage(dep_field, tables, databases, visited)
                all_table_ids.update(sub_tables)
            else:
                # æ™®é€šå­—æ®µï¼Œè·å–å…¶è¡¨
                if dep_field.lineage_table_id:
                    all_table_ids.add(dep_field.lineage_table_id)
    
    # å¡«å……è¡€ç¼˜ä¿¡æ¯
    if all_table_ids:
        first_table_id = list(all_table_ids)[0]
        field.lineage_table_id = first_table_id
        if first_table_id in tables:
            tbl = tables[first_table_id]
            field.lineage_table_name = tbl.name
            if tbl.database_id and tbl.database_id in databases:
                field.lineage_database_name = databases[tbl.database_id].name
        
        field.lineage_all_table_ids = json.dumps(list(all_table_ids))
        field.lineage_path = f"CalcField â†’ {len(all_table_ids)} tables"
    
    return all_table_ids
```

---

# ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ•°æ®åº“è®¾è®¡å˜æ›´

## ä¸€ã€fields è¡¨æ–°å¢åˆ—

### 1.1 é‡‡é›†é˜¶æ®µåŸå§‹ä¿¡æ¯åˆ—

| åˆ—å                       | ç±»å‹         | è¯´æ˜           | å¡«å……æ—¶æœº |
| -------------------------- | ------------ | -------------- | -------- |
| `raw_upstream_column_id`   | VARCHAR(255) | ä¸Šæ¸¸åˆ—åŸå§‹ ID  | é‡‡é›†é˜¶æ®µ |
| `raw_upstream_column_name` | VARCHAR(255) | ä¸Šæ¸¸åˆ—åŸå§‹åç§° | é‡‡é›†é˜¶æ®µ |
| `raw_upstream_table_id`    | VARCHAR(255) | ä¸Šæ¸¸è¡¨åŸå§‹ ID  | é‡‡é›†é˜¶æ®µ |
| `raw_upstream_table_type`  | VARCHAR(50)  | ä¸Šæ¸¸è¡¨ç±»å‹     | é‡‡é›†é˜¶æ®µ |

### 1.2 å»é‡æ ‡è®°åˆ—

| åˆ—å           | ç±»å‹         | è¯´æ˜                | å¡«å……æ—¶æœº |
| -------------- | ------------ | ------------------- | -------- |
| `is_duplicate` | BOOLEAN      | æ˜¯å¦ä¸ºé‡å¤é¡¹        | å»é‡é˜¶æ®µ |
| `survivor_id`  | VARCHAR(255) | é‡å¤é¡¹æŒ‡å‘çš„å­˜æ´» ID | å»é‡é˜¶æ®µ |

### 1.3 è¡€ç¼˜å†—ä½™åˆ—

| åˆ—å                      | ç±»å‹         | è¯´æ˜                    | å¡«å……æ—¶æœº   |
| ------------------------- | ------------ | ----------------------- | ---------- |
| `lineage_column_name`     | VARCHAR(255) | ä¸Šæ¸¸ç‰©ç†åˆ—å            | è¡€ç¼˜é¢„è®¡ç®— |
| `lineage_table_id`        | VARCHAR(255) | ä¸Šæ¸¸ç‰©ç†è¡¨ IDï¼ˆç©¿é€åï¼‰ | è¡€ç¼˜é¢„è®¡ç®— |
| `lineage_table_name`      | VARCHAR(255) | ä¸Šæ¸¸ç‰©ç†è¡¨å            | è¡€ç¼˜é¢„è®¡ç®— |
| `lineage_table_schema`    | VARCHAR(255) | ä¸Šæ¸¸ç‰©ç†è¡¨ Schema       | è¡€ç¼˜é¢„è®¡ç®— |
| `lineage_database_id`     | VARCHAR(255) | ä¸Šæ¸¸æ•°æ®åº“ ID           | è¡€ç¼˜é¢„è®¡ç®— |
| `lineage_database_name`   | VARCHAR(255) | ä¸Šæ¸¸æ•°æ®åº“å            | è¡€ç¼˜é¢„è®¡ç®— |
| `lineage_datasource_name` | VARCHAR(255) | æ‰€å±æ•°æ®æºå            | è¡€ç¼˜é¢„è®¡ç®— |
| `lineage_workbook_name`   | VARCHAR(255) | æ‰€å±å·¥ä½œç°¿å            | è¡€ç¼˜é¢„è®¡ç®— |
| `lineage_all_table_ids`   | TEXT         | æ‰€æœ‰ä¾èµ–è¡¨ IDï¼ˆJSONï¼‰   | è¡€ç¼˜é¢„è®¡ç®— |
| `lineage_path`            | TEXT         | å®Œæ•´è¡€ç¼˜è·¯å¾„æè¿°        | è¡€ç¼˜é¢„è®¡ç®— |

---

## äºŒã€DDL å˜æ›´è„šæœ¬

```sql
-- ========== é˜¶æ®µ1ï¼šé‡‡é›†é˜¶æ®µåŸå§‹ä¿¡æ¯åˆ— ==========

ALTER TABLE fields ADD COLUMN raw_upstream_column_id VARCHAR(255);
ALTER TABLE fields ADD COLUMN raw_upstream_column_name VARCHAR(255);
ALTER TABLE fields ADD COLUMN raw_upstream_table_id VARCHAR(255);
ALTER TABLE fields ADD COLUMN raw_upstream_table_type VARCHAR(50);

-- ========== é˜¶æ®µ2ï¼šå»é‡æ ‡è®°åˆ— ==========

ALTER TABLE fields ADD COLUMN is_duplicate BOOLEAN DEFAULT 0;
ALTER TABLE fields ADD COLUMN survivor_id VARCHAR(255);

-- ========== é˜¶æ®µ3ï¼šè¡€ç¼˜å†—ä½™åˆ— ==========

ALTER TABLE fields ADD COLUMN lineage_column_name VARCHAR(255);
ALTER TABLE fields ADD COLUMN lineage_table_id VARCHAR(255);
ALTER TABLE fields ADD COLUMN lineage_table_name VARCHAR(255);
ALTER TABLE fields ADD COLUMN lineage_table_schema VARCHAR(255);
ALTER TABLE fields ADD COLUMN lineage_database_id VARCHAR(255);
ALTER TABLE fields ADD COLUMN lineage_database_name VARCHAR(255);
ALTER TABLE fields ADD COLUMN lineage_datasource_name VARCHAR(255);
ALTER TABLE fields ADD COLUMN lineage_workbook_name VARCHAR(255);
ALTER TABLE fields ADD COLUMN lineage_all_table_ids TEXT;
ALTER TABLE fields ADD COLUMN lineage_path TEXT;

-- ========== ç´¢å¼•ä¼˜åŒ– ==========

CREATE INDEX idx_fields_is_duplicate ON fields(is_duplicate);
CREATE INDEX idx_fields_survivor ON fields(survivor_id);
CREATE INDEX idx_fields_lineage_table ON fields(lineage_table_id);
CREATE INDEX idx_fields_lineage_database ON fields(lineage_database_id);
```

---

# ç¬¬å››éƒ¨åˆ†ï¼šå®æ–½æ­¥éª¤

## ä¸€ã€é˜¶æ®µåˆ’åˆ†

### é˜¶æ®µ1ï¼šä»£ç é‡æ„ï¼ˆé¢„è®¡ 2 å¤©ï¼‰

| æ­¥éª¤ | æ“ä½œ                              | éªŒè¯ç‚¹                    |
| ---- | --------------------------------- | ------------------------- |
| 1.1  | åˆ›å»º `tableau_collector.py`       | æ–‡ä»¶å­˜åœ¨ï¼Œç±»ç»“æ„å®Œæ•´      |
| 1.2  | ä» `tableau_sync.py` æå–é‡‡é›†é€»è¾‘ | é‡‡é›†æ–¹æ³•æ­£ç¡®å¤åˆ¶          |
| 1.3  | ç§»é™¤é‡‡é›†ä»£ç ä¸­çš„å»é‡é€»è¾‘          | æ—  `cache`ã€`skip` å…³é”®å­— |
| 1.4  | åˆ›å»º `metadata_processor.py`      | æ–‡ä»¶å­˜åœ¨ï¼Œç±»ç»“æ„å®Œæ•´      |
| 1.5  | å®ç° `deduplicate_fields()`       | ä¸‰çº§ç¼“å­˜é€»è¾‘å®Œæ•´          |
| 1.6  | å®ç° `compute_field_lineage()`    | é€’å½’è¿½æº¯é€»è¾‘å®Œæ•´          |

### é˜¶æ®µ2ï¼šæ•°æ®åº“å˜æ›´ï¼ˆé¢„è®¡ 0.5 å¤©ï¼‰

| æ­¥éª¤ | æ“ä½œ                  | éªŒè¯ç‚¹                 |
| ---- | --------------------- | ---------------------- |
| 2.1  | å¤‡ä»½ç°æœ‰æ•°æ®åº“        | `metadata.db.bak` å­˜åœ¨ |
| 2.2  | æ›´æ–° `models.py`      | æ–°å¢åˆ—å®šä¹‰å®Œæ•´         |
| 2.3  | æ‰§è¡Œ DDL è„šæœ¬         | åˆ—å­˜åœ¨ï¼Œç´¢å¼•åˆ›å»ºæˆåŠŸ   |
| 2.4  | æ›´æ–° `to_dict()` æ–¹æ³• | API è¿”å›æ–°å­—æ®µ         |

### é˜¶æ®µ3ï¼šè°ƒåº¦æ”¹é€ ï¼ˆé¢„è®¡ 0.5 å¤©ï¼‰

| æ­¥éª¤ | æ“ä½œ                   | éªŒè¯ç‚¹           |
| ---- | ---------------------- | ---------------- |
| 3.1  | æ”¹é€  `tableau_sync.py` | è°ƒç”¨æ–°æ¨¡å—       |
| 3.2  | æ›´æ–° `sync_all()` æ–¹æ³• | å››é˜¶æ®µæ‰§è¡Œ       |
| 3.3  | æ·»åŠ æ—¥å¿—è¾“å‡º           | å„é˜¶æ®µæœ‰æ˜ç¡®æ ‡è¯† |

### é˜¶æ®µ4ï¼šAPI ç®€åŒ–ï¼ˆé¢„è®¡ 1 å¤©ï¼‰

| æ­¥éª¤ | æ“ä½œ                        | éªŒè¯ç‚¹                  |
| ---- | --------------------------- | ----------------------- |
| 4.1  | ç®€åŒ– `get_field_detail()`   | ç›´æ¥è¯»å–å†—ä½™åˆ—          |
| 4.2  | ç®€åŒ– `get_fields()`         | è¿‡æ»¤ `is_duplicate = 0` |
| 4.3  | ç®€åŒ– `metrics/catalog`      | ä½¿ç”¨é¢„è®¡ç®—æ•°æ®          |
| 4.4  | ç®€åŒ–å‰ç«¯ `DetailDrawer.tsx` | ç§»é™¤å¤æ‚ JOIN é€»è¾‘      |

---

## äºŒã€éªŒè¯è®¡åˆ’

### 2.1 å•å…ƒæµ‹è¯•

```bash
# æµ‹è¯•é‡‡é›†å®Œæ•´æ€§
python3 -c "
from backend.tableau_collector import TableauCollector
# æ‰§è¡Œé‡‡é›†
# éªŒè¯ fields è¡¨åŒ…å«æ‰€æœ‰åŸå§‹è®°å½•
"

# æµ‹è¯•å»é‡æ­£ç¡®æ€§
python3 -c "
from backend.metadata_processor import MetadataProcessor
# æ‰§è¡Œå»é‡
# éªŒè¯ is_duplicate æ­£ç¡®æ ‡è®°
"
```

### 2.2 é›†æˆæµ‹è¯•

```bash
# æ‰§è¡Œå…¨é‡åŒæ­¥
python3 run_backend.py --task sync

# æ£€æŸ¥é‡‡é›†ç»“æœï¼ˆåº”åŒ…å«æ‰€æœ‰è®°å½•ï¼Œå«å‰¯æœ¬ï¼‰
sqlite3 backend/metadata.db "
SELECT COUNT(*) as total,
       SUM(CASE WHEN is_duplicate = 1 THEN 1 ELSE 0 END) as duplicates
FROM fields
"

# æ£€æŸ¥è¡€ç¼˜å¡«å……
sqlite3 backend/metadata.db "
SELECT COUNT(*) as has_lineage
FROM fields 
WHERE is_duplicate = 0 AND lineage_table_name IS NOT NULL
"
```

### 2.3 å›å½’æµ‹è¯•

| æµ‹è¯•é¡¹           | é¢„æœŸç»“æœ                  |
| ---------------- | ------------------------- |
| æœç´¢"é«˜å³°ç±»å‹"   | åªæ˜¾ç¤º 1 ä¸ªï¼ˆéé‡å¤ï¼‰ç»“æœ |
| æŸ¥çœ‹è®¡ç®—å­—æ®µè¯¦æƒ… | "æ‰€å±æ•°æ®è¡¨"æ­£ç¡®æ˜¾ç¤º      |
| æŸ¥çœ‹æ™®é€šå­—æ®µè¯¦æƒ… | è¡€ç¼˜å®Œæ•´ï¼Œå«æ•°æ®åº“å      |

---

## ä¸‰ã€é£é™©ä¸å›æ»š

### 3.1 é£é™©ç‚¹

| é£é™©             | å½±å“           | ç¼“è§£æªæ–½               |
| ---------------- | -------------- | ---------------------- |
| æ•°æ®åº“å˜æ›´ä¸å…¼å®¹ | æ—§ç‰ˆæœ¬æ— æ³•è¿è¡Œ | æ·»åŠ åˆ—è€Œéåˆ åˆ—         |
| å»é‡é€»è¾‘é”™è¯¯     | è¯¯æ ‡è®°æœ‰æ•ˆå­—æ®µ | åªæ ‡è®°ä¸åˆ é™¤ï¼Œæ”¯æŒé‡ç½® |
| åŒæ­¥æ—¶é—´å¢åŠ      | ç”¨æˆ·ç­‰å¾…å˜é•¿   | åˆ†é˜¶æ®µæ˜¾ç¤ºè¿›åº¦         |

### 3.2 å›æ»šæ–¹æ¡ˆ

```bash
# æ¢å¤æ•°æ®åº“
mv backend/metadata.db.bak backend/metadata.db

# æ¢å¤ä»£ç 
git checkout HEAD~1 -- backend/tableau_sync.py

# é‡ç½®å»é‡æ ‡è®°
sqlite3 backend/metadata.db "
UPDATE fields SET is_duplicate = 0, survivor_id = NULL
"
```

---

# é™„å½•

## A. ç›¸å…³æ–‡ä»¶æ¸…å•

| æ–‡ä»¶                                       | å˜æ›´ç±»å‹ | è¯´æ˜         |
| ------------------------------------------ | -------- | ------------ |
| `backend/tableau_collector.py`             | æ–°å»º     | çº¯é‡‡é›†æ¨¡å—   |
| `backend/metadata_processor.py`            | æ–°å»º     | åç½®å¤„ç†æ¨¡å— |
| `backend/tableau_sync.py`                  | æ”¹é€      | è°ƒåº¦å…¥å£     |
| `backend/models.py`                        | ä¿®æ”¹     | æ–°å¢åˆ—å®šä¹‰   |
| `backend/routes/api.py`                    | ç®€åŒ–     | ä½¿ç”¨å†—ä½™åˆ—   |
| `frontend/src/components/DetailDrawer.tsx` | ç®€åŒ–     | ç§»é™¤å¤æ‚é€»è¾‘ |

## B. å‚è€ƒæ–‡æ¡£

- [å…ƒæ•°æ®è¡€ç¼˜å…³ç³»è¯´æ˜](file:///Users/w/Desktop/å‰ç¥¥/Team/ä»£ç ç®¡ç†/metadataåˆ†æ/docs/å…ƒæ•°æ®è¡€ç¼˜å…³ç³»è¯´æ˜.md)
- [å­—æ®µé‡‡é›†å»é‡å…³è”æµç¨‹](file:///Users/w/Desktop/å‰ç¥¥/Team/ä»£ç ç®¡ç†/metadataåˆ†æ/docs/å­—æ®µé‡‡é›†å»é‡å…³è”æµç¨‹.md)
