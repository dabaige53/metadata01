# Tableau 元数据治理平台 - 完整产品说明报告

> **版本**: v2.1  
> **生成日期**: 2025-12-31  
> **技术栈**: Next.js 16 + React 19 + Flask 3.0 + SQLite

---

## 一、产品概述

### 1.1 产品定位

本产品是一个**Tableau 元数据治理平台**，专注于从 Tableau Server 采集元数据，构建完整的数据血缘图谱，并提供数据治理分析能力。参考开源项目 DataHub 的设计理念，实现元数据采集、管理、血缘分析等功能。

### 1.2 核心价值

| 维度 | 价值 |
|------|------|
| **数据可见性** | 统一视图展示所有 Tableau 资产（数据库、表、数据源、工作簿、视图、字段） |
| **血缘追溯** | 从物理表到展示层的完整数据流向可视化 |
| **治理分析** | 识别孤立资产、重复指标、缺失描述等治理问题 |
| **健康度评估** | 多维度量化评估元数据治理水平 |

### 1.3 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户浏览器                                │
│                    http://localhost:3200                        │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                   Next.js 前端应用                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  App Router (页面)                                       │   │
│  │  ├── / (概览仪表板)     ├── /databases  ├── /tables     │   │
│  │  ├── /datasources       ├── /workbooks  ├── /views      │   │
│  │  ├── /fields            ├── /metrics    ├── /glossary   │   │
│  │  ├── /projects          ├── /users      └── /search     │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  核心组件                                                 │   │
│  │  AppLayout │ DetailDrawer │ DataTable │ Cards │ Intros  │   │
│  └─────────────────────────────────────────────────────────┘   │
└────────────────────────────┬────────────────────────────────────┘
                             │ /api/* 代理
┌────────────────────────────▼────────────────────────────────────┐
│                   Flask 后端 API                                 │
│                    http://localhost:8201                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Routes 层                                               │   │
│  │  databases │ tables │ datasources │ workbooks │ views   │   │
│  │  fields │ metrics │ lineage │ glossary │ api_legacy     │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Services 层                                             │   │
│  │  TableauMetadataClient │ MetadataSync                    │   │
│  └─────────────────────────────────────────────────────────┘   │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                   SQLite 数据库                                  │
│                    metadata.db                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  核心表: databases │ tables │ db_columns │ datasources  │   │
│  │         workbooks │ views │ fields │ calculated_fields  │   │
│  │  血缘表: table_to_datasource │ datasource_to_workbook   │   │
│  │         field_to_view │ regular_field_to_view           │   │
│  └─────────────────────────────────────────────────────────┘   │
└────────────────────────────┬────────────────────────────────────┘
                             │ GraphQL + REST API
┌────────────────────────────▼────────────────────────────────────┐
│                   Tableau Server                                │
│              Metadata API + REST API                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、数据模型详解

### 2.1 核心实体 (15 个主表)

#### 2.1.1 物理数据层

| 模型 | 表名 | 说明 | 关键字段 |
|------|------|------|----------|
| **Database** | `databases` | 数据库连接 | `id`, `name`, `connection_type`, `host_name`, `port` |
| **DBTable** | `tables` | 数据表 | `id`, `name`, `schema`, `database_id`, `is_embedded`, `is_certified` |
| **DBColumn** | `db_columns` | 数据库原生列 | `id`, `name`, `remote_type`, `table_id`, `is_nullable` |

#### 2.1.2 Tableau 资源层

| 模型 | 表名 | 说明 | 关键字段 |
|------|------|------|----------|
| **Datasource** | `datasources` | 已发布/嵌入式数据源 | `id`, `name`, `project_name`, `owner`, `is_embedded`, `is_certified`, `has_extract` |
| **Workbook** | `workbooks` | 工作簿 | `id`, `name`, `project_name`, `owner`, `view_count`, `datasource_count` |
| **View** | `views` | 视图/仪表板 | `id`, `name`, `view_type` (sheet/dashboard), `workbook_id`, `total_view_count` |

#### 2.1.3 字段资产层

| 模型 | 表名 | 说明 | 关键字段 |
|------|------|------|----------|
| **Field** | `fields` | 原始字段（旧版统一表） | `id`, `name`, `data_type`, `role`, `datasource_id`, `is_calculated` |
| **RegularField** | `regular_fields` | 原始字段实例（新版分表） | `id`, `name`, `table_id`, `datasource_id`, `usage_count` |
| **CalculatedField** | `calculated_fields` | 计算字段实例 | `id`, `name`, `formula`, `formula_hash`, `complexity_score`, `has_duplicates` |
| **UniqueRegularField** | `unique_regular_fields` | 去重后的标准字段 | `id`, `name`, `table_id`, `upstream_column_id` |
| **UniqueCalculatedField** | `unique_calculated_fields` | 去重后的标准指标 | `id`, `name`, `formula`, `formula_hash` |

#### 2.1.4 组织管理层

| 模型 | 表名 | 说明 | 关键字段 |
|------|------|------|----------|
| **Project** | `projects` | Tableau 项目 | `id`, `name`, `description`, `parent_project_id` |
| **TableauUser** | `tableau_users` | 用户 | `id`, `name`, `display_name`, `email`, `site_role` |
| **Glossary** | `glossary` | 术语表 | `id`, `term`, `label`, `definition`, `category`, `element` |

### 2.2 血缘关系表 (6 个关联表)

| 关联表 | 说明 | 主键 |
|--------|------|------|
| `table_to_datasource` | 表 → 数据源 | `(table_id, datasource_id)` |
| `datasource_to_workbook` | 数据源 → 工作簿 | `(datasource_id, workbook_id)` |
| `field_to_view` | 字段 → 视图 | `(field_id, view_id)` |
| `regular_field_to_view` | 原始字段 → 视图 (v5+) | `(field_id, view_id)` |
| `calc_field_to_view` | 计算字段 → 视图 (v5+) | `(field_id, view_id)` |
| `dashboard_to_sheet` | 仪表板 → 工作表 | `(dashboard_id, sheet_id)` |

### 2.3 预计算统计字段

为避免 API 层实时聚合，所有统计字段在 `MetadataSync.calculate_stats()` 中预计算：

| 模型 | 预计算字段 | 用途 |
|------|-----------|------|
| **Workbook** | `view_count`, `datasource_count`, `field_count`, `metric_count` | 工作簿资源统计 |
| **Datasource** | `table_count`, `workbook_count`, `field_count`, `metric_count` | 数据源使用情况 |
| **Field** | `usage_count`, `metric_usage_count` | 字段被引用次数 |
| **CalculatedField** | `has_duplicates`, `duplicate_count`, `formula_hash` | 重复指标检测 |
| **View** | `total_view_count` | 视图访问统计 |

---

## 三、功能模块详解

### 3.1 概览页 (Overview)

**路径**: `/` (首页)

**功能说明**:
这是系统的核心仪表板，提供全局治理健康度评估和资产全景视图。

**页面元素**:

| 区块 | 说明 | 数据来源 |
|------|------|----------|
| **治理健康度** | 0-100 分的综合健康评分 + 环形进度图 | `/api/dashboard/analysis` |
| **五维治理评分** | 完整性/规范性/时效性/一致性/有效性 | `governance_scores` 对象 |
| **资产全景** | 7 类资产的数量统计卡片 | `total_assets` 对象 |
| **资产明细分布** | 嵌入式/去重/活跃/僵尸资产分类 | `/api/lineage/sankey` |
| **项目分布** | Top 5 项目的数据源/工作簿分布柱状图 | `project_distribution` |
| **复杂度分布** | 低/中/高复杂度计算字段饼图 | `complexity_distribution` |
| **字段角色分布** | 维度/度量/未分类饼图 | `role_distribution` |
| **行动中心** | 按优先级排列的治理待办项 | `issues` 对象 |
| **热点字段 Top 10** | 被引用次数最多的字段列表 | `top_fields` |
| **热点工作簿 Top 10** | 视图数最多的工作簿列表 | `top_workbooks` |
| **血缘桑基图** | 数据库→表→数据源→字段→工作簿→视图 流向图 | `/api/lineage/sankey` |

**治理健康度计算规则**:
```
健康分 = 完整性×0.25 + 规范性×0.2 + 时效性×0.2 + 一致性×0.2 + 有效性×0.15
```

**行动中心优先级**:
- **高优先级** (红色): 重复公式、停更数据源
- **中优先级** (黄色): 缺失字段描述、孤立表
- **低优先级** (灰色): 缺失指标描述、未认证数据源

---

### 3.2 数据库模块 (Databases)

**路径**: `/databases`

**功能说明**:
展示所有从 Tableau 采集的数据库连接信息。

**页面元素**:

| 元素 | 说明 |
|------|------|
| **搜索框** | 按名称、连接类型、主机名搜索 |
| **Facet 筛选** | 按 `connection_type` 筛选 |
| **排序按钮** | 支持按名称、表数量排序 |
| **数据库卡片** | 显示名称、连接类型、主机地址、表数量 |

**详情抽屉 (点击卡片)**:
- **概览 Tab**: 基本信息、连接类型、主机地址
- **数据表 Tab**: 该数据库下的所有表列表
- **血缘 Tab**: 以此数据库为中心的血缘关系图

**API 端点**:
- `GET /api/databases` - 列表（支持分页、筛选）
- `GET /api/databases/<id>` - 详情

---

### 3.3 数据表模块 (Tables)

**路径**: `/tables`

**功能说明**:
管理物理数据表，支持区分已发布表和嵌入式表。

**标签页**:

| Tab | 说明 |
|-----|------|
| **已发布** | 显示非嵌入式的正式发布表 |
| **嵌入式** | 显示嵌入在工作簿中的临时表 |
| **表治理分析** | 孤立表分析（无下游数据源的表） |

**页面元素**:

| 元素 | 说明 |
|------|------|
| **Facet 筛选** | 按 `schema`, `database_name` 筛选 |
| **搜索框** | 搜索表名 |
| **排序按钮** | 支持按字段数、名称排序 |
| **表卡片** | 显示表名、schema、数据库、列数、字段数、状态标识 |

**状态标识**:
- **已认证** (绿色盾牌): `is_certified = true`
- **嵌入式** (紫色标签): `is_embedded = true`
- **孤立** (红色标签): 无下游数据源关联

**详情抽屉 Tabs**:
- **概览**: 基本信息、认证状态、描述
- **所属数据库**: 上游数据库信息
- **原始列**: `db_columns` 列表
- **Tableau 字段**: 关联的 `fields` 列表（按原始列分组）
- **下游数据源**: 使用此表的数据源列表
- **嵌入式数据源**: 嵌入此表的数据源
- **关联工作簿**: 间接关联的工作簿
- **血缘图**: Mermaid 可视化

**API 端点**:
- `GET /api/tables` - 列表（支持 `is_embedded` 筛选）
- `GET /api/tables/<id>` - 详情
- `GET /api/tables/governance/unused` - 孤立表分析

---

### 3.4 数据源模块 (Datasources)

**路径**: `/datasources`

**功能说明**:
管理 Tableau 已发布数据源和嵌入式数据源。

**标签页**:

| Tab | 说明 |
|-----|------|
| **已发布** | 正式发布到 Tableau Server 的数据源 |
| **嵌入式** | 嵌入在工作簿中的数据源 |
| **未认证分析** | 按项目分组的未认证数据源 |
| **孤立数据源** | 无下游工作簿使用的数据源 |

**页面元素**:

| 元素 | 说明 |
|------|------|
| **Facet 筛选** | 按 `is_certified`, `project_name` 筛选 |
| **搜索框** | 搜索数据源名称 |
| **排序按钮** | 按表数量、关联工作簿、更新时间、名称排序 |
| **数据源卡片** | 显示名称、项目、所有者、认证状态、表/工作簿统计 |

**详情抽屉 Tabs**:
- **概览**: 基本信息、认证状态、Extract 刷新时间
- **上游表**: 使用的物理表列表
- **嵌入式表**: 嵌入的表
- **原始列**: 来源列
- **字段**: 按表分组的字段列表
- **计算字段**: 该数据源的计算字段/指标
- **下游工作簿**: 使用此数据源的工作簿
- **嵌入式引用**: 嵌入式数据源（引用发布源）
- **血缘图**: Mermaid 可视化

**API 端点**:
- `GET /api/datasources` - 列表
- `GET /api/datasources/<id>` - 详情
- `GET /api/datasources/governance/uncertified` - 未认证分析
- `GET /api/datasources/governance/orphan` - 孤立分析

---

### 3.5 工作簿模块 (Workbooks)

**路径**: `/workbooks`

**功能说明**:
管理 Tableau 工作簿及其关联资源。

**标签页**:

| Tab | 说明 |
|-----|------|
| **工作簿列表** | 所有工作簿 |
| **治理分析** | 空工作簿分析（无视图的工作簿） |

**页面元素**:

| 元素 | 说明 |
|------|------|
| **Facet 筛选** | 按 `project_name` 筛选 |
| **搜索框** | 搜索工作簿名称 |
| **排序按钮** | 按视图数、名称排序 |
| **工作簿卡片** | 显示名称、项目、所有者、视图数、上游数据源标签 |

**详情抽屉 Tabs**:
- **概览**: 基本信息、Tableau Server 链接
- **视图列表**: 该工作簿下的 sheets/dashboards
- **已发布数据源**: 使用的已发布数据源
- **嵌入式数据源**: 嵌入的数据源
- **上游表**: 使用的物理表
- **嵌入式表**: 嵌入的表
- **原始字段**: 使用的字段
- **计算字段**: 使用的指标
- **访问统计**: 视图访问趋势图
- **血缘图**: Mermaid 可视化

**API 端点**:
- `GET /api/workbooks` - 列表
- `GET /api/workbooks/<id>` - 详情
- `GET /api/workbooks/governance/empty` - 空工作簿分析

---

### 3.6 视图模块 (Views)

**路径**: `/views`

**功能说明**:
管理 Tableau 仪表板和工作表，支持访问统计分析。

**标签页**:

| Tab | 说明 |
|-----|------|
| **仪表盘列表** | 仅显示 `view_type = 'dashboard'` 或独立 sheet |
| **全部视图** | 所有 sheets + dashboards |
| **零访问视图** | `total_view_count = 0` 的视图（按工作簿分组） |
| **热门视图** | 访问量 Top N 的视图 |

**页面元素**:

| 元素 | 说明 |
|------|------|
| **Facet 筛选** | 按 `view_type`, `workbook_name` 筛选 |
| **搜索框** | 搜索视图名称 |
| **排序按钮** | 按访问量、字段数、名称排序 |
| **视图卡片** | 显示名称、类型、工作簿、访问量、字段数 |

**详情抽屉 Tabs**:
- **概览**: 基本信息、访问量、Tableau Server 链接
- **所属工作簿**: 上游工作簿信息
- **使用的字段**: 该视图引用的字段
- **使用的指标**: 该视图引用的计算字段
- **访问统计**: 历史访问趋势
- **包含的视图**: (仅 Dashboard) 包含的 sheets
- **血缘图**: Mermaid 可视化

**API 端点**:
- `GET /api/views` - 列表（支持 `include_standalone` 参数）
- `GET /api/views/<id>` - 详情
- `GET /api/views/<id>/usage-stats` - 访问统计历史
- `GET /api/views/governance/zero-access` - 零访问视图

---

### 3.7 原始字段模块 (Fields)

**路径**: `/fields`

**功能说明**:
管理原始字段（非计算字段），支持去重聚合和治理分析。

**标签页**:

| Tab | 说明 |
|-----|------|
| **原始字段目录** | 去重后的标准字段列表（按 table_id + upstream_column_id 去重） |
| **无描述字段** | 缺失 description 的字段 |
| **孤立字段** | 无视图引用的字段 |
| **热门字段** | 被引用次数最多的字段 |

**去重规则**:
```
同一物理表的同一列 → 聚合为 1 个标准字段
数据来源：unique_regular_fields 表
```

**页面元素**:

| 元素 | 说明 |
|------|------|
| **Facet 筛选** | 按 `role`, `dedup_method` 筛选 |
| **搜索框** | 搜索字段名、表名 |
| **排序按钮** | 按热度、实例数、名称排序 |
| **字段目录卡片** | 显示字段名、角色、数据类型、所属表、实例数、热度 |

**详情抽屉 Tabs**:
- **概览**: 基本信息、数据类型、角色、描述
- **所属表**: 上游物理表信息
- **依赖字段**: 上游依赖的字段（如有）
- **所属数据源**: 定义此字段的数据源
- **嵌入式数据源**: 嵌入此字段的数据源
- **影响指标**: 被哪些计算字段引用
- **使用视图**: 在哪些视图中使用
- **关联工作簿**: 间接关联的工作簿
- **血缘图**: Mermaid 可视化

**API 端点**:
- `GET /api/fields` - 字段实例列表
- `GET /api/fields/catalog` - 去重后的字段目录
- `GET /api/fields/<id>` - 详情（支持 `mode=aggregated`）
- `GET /api/fields/governance/no-description` - 无描述字段
- `GET /api/fields/governance/orphan` - 孤立字段
- `GET /api/fields/governance/hot` - 热门字段

---

### 3.8 计算字段模块 (Metrics)

**路径**: `/metrics`

**功能说明**:
管理计算字段/指标，支持重复检测和复杂度分析。

**标签页**:

| Tab | 说明 |
|-----|------|
| **计算字段目录** | 去重后的标准指标列表（按 name + formula_hash 去重） |
| **同名不同公式** | 名称相同但公式不同的指标组 |
| **同公式不同名称** | 公式相同但名称不同的指标组 |
| **高复杂度** | `complexity_score > 7` 的复杂指标 |
| **未使用指标** | 无视图引用的指标 |

**去重规则**:
```
按『名称＋公式哈希』聚合
不同工作簿中逻辑相同的公式仅计为 1 项
```

**复杂度计算规则**:
- **低** (0-1): 简单重命名，如 `[字段名]`
- **中** (2-7): 中等计算，如 `SUM([Sales])`
- **高** (>7): 复杂嵌套，如多层 IF/CASE/LOD

**页面元素**:

| 元素 | 说明 |
|------|------|
| **Facet 筛选** | 按 `role`, `is_aggregated`, `dedup_method` 筛选 |
| **搜索框** | 搜索指标名称、公式 |
| **排序按钮** | 按热度、复杂度、名称排序 |
| **指标目录卡片** | 显示名称、公式预览、复杂度标签、实例数、热度 |

**详情抽屉 Tabs**:
- **概览**: 基本信息、公式、复杂度评分
- **所属表**: 上游物理表（如有）
- **依赖字段**: 公式中引用的原始字段
- **所属数据源**: 定义此指标的数据源
- **嵌入式数据源**: 嵌入此指标的数据源
- **影响指标**: 被其他计算字段引用
- **使用视图**: 在哪些视图中使用
- **关联工作簿**: 间接关联的工作簿
- **同名定义**: 名称相同但公式不同的变体
- **实例列表**: 该指标在各工作簿中的实例
- **血缘图**: Mermaid 可视化

**API 端点**:
- `GET /api/metrics` - 指标实例列表
- `GET /api/metrics/catalog` - 去重后的指标目录
- `GET /api/metrics/<id>` - 详情（支持 `mode=aggregated`）
- `GET /api/metrics/governance/duplicate-name` - 同名不同公式
- `GET /api/metrics/governance/duplicate-formula` - 同公式不同名称
- `GET /api/metrics/governance/complex` - 高复杂度
- `GET /api/metrics/governance/unused` - 未使用指标

---

### 3.9 项目模块 (Projects)

**路径**: `/projects`

**功能说明**:
展示 Tableau 项目组织结构。

**页面元素**:
- 项目列表卡片
- 支持搜索

**详情抽屉 Tabs**:
- **概览**: 项目名称、描述、父项目
- **数据源**: 该项目下的数据源
- **工作簿**: 该项目下的工作簿

**API 端点**:
- `GET /api/projects` - 列表
- `GET /api/projects/<id>` - 详情

---

### 3.10 用户模块 (Users)

**路径**: `/users`

**功能说明**:
展示 Tableau 用户信息。

**页面元素**:
- 用户列表卡片
- 支持搜索

**详情抽屉 Tabs**:
- **概览**: 用户名、显示名、邮箱、站点角色
- **拥有的数据源**: 该用户创建的数据源
- **拥有的工作簿**: 该用户创建的工作簿

**API 端点**:
- `GET /api/users` - 列表
- `GET /api/users/<id>` - 详情

---

### 3.11 术语介绍模块 (Glossary)

**路径**: `/glossary`

**功能说明**:
系统术语定义与解释，帮助用户理解元数据概念。

**页面元素**:

| 元素 | 说明 |
|------|------|
| **元素筛选** | 按所属元素类型筛选（全部/数据库/表/字段/指标/数据源/工作簿/视图/项目/用户） |
| **搜索框** | 搜索术语 |
| **同步按钮** | 从脚本重新同步术语数据 |
| **术语卡片** | 显示术语英文名、中文标签、定义、所属分类、枚举值 |

**术语结构**:
- `term`: 英文术语标识
- `label`: 中文显示名称
- `definition`: 详细定义说明
- `category`: 分类（技术术语/业务术语）
- `element`: 所属元素（database/table/field 等）
- `enums`: 枚举值列表（如角色的 measure/dimension）

**API 端点**:
- `GET /api/glossary` - 术语列表
- `POST /api/glossary/sync` - 同步术语数据

---

### 3.12 全局搜索 (Search)

**路径**: `/search?q=<keyword>`

**功能说明**:
跨所有资产类型的全文搜索。

**搜索范围**:
- 数据库、数据表、数据源
- 工作簿、视图
- 字段、计算字段

**快捷键**: `Cmd+K` / `Ctrl+K` 聚焦搜索框

**API 端点**:
- `GET /api/search?q=<keyword>` - 全局搜索

---

## 四、通用组件说明

### 4.1 应用布局 (AppLayout)

**文件**: `frontend/src/components/AppLayout.tsx`

**功能**:
- 左侧固定导航栏，按模块分组
- 显示各模块资产数量统计
- 顶部全局搜索框
- 用户信息展示

**导航分组**:
1. **数据血缘**: 概览、数据库、数据表、数据源、工作簿、视图
2. **字段资产**: 原始字段、计算字段
3. **组织管理**: 项目、用户
4. **知识库**: 术语介绍

### 4.2 详情抽屉 (DetailDrawer)

**文件**: `frontend/src/components/DetailDrawer.tsx`

**功能**:
- 右侧滑出的详情面板
- 支持多 Tab 切换
- 支持导航历史（面包屑回退）
- 支持预加载（鼠标悬停预取）
- 支持帮助介绍弹窗（IntroDemo）

**通用 Tabs**:
- 概览 (overview)
- 血缘图 (lineage)

### 4.3 数据表格组件系统

| 组件 | 文件 | 说明 |
|------|------|------|
| **FacetFilterBar** | `FacetFilterBar.tsx` | 多维度 Facet 筛选条，支持下拉多选 |
| **InlineFilter** | `InlineFilter.tsx` | Chip 样式内联筛选器 |
| **SortButtons** | `SortButtons.tsx` | 排序按钮组，支持升序/降序切换 |
| **Pagination** | `Pagination.tsx` | 分页控件，支持页码跳转和每页条数切换 |
| **DropdownFilter** | `DropdownFilter.tsx` | 下拉筛选面板 |

### 4.4 卡片组件

| 组件 | 文件 | 用于页面 |
|------|------|----------|
| **TableCard** | `TableCard.tsx` | /tables |
| **DatasourceCard** | `DatasourceCard.tsx` | /datasources |
| **WorkbookCard** | `WorkbookCard.tsx` | /workbooks |
| **ViewCard** | `ViewCard.tsx` | /views |
| **FieldCard** | `FieldCard.tsx` | /fields (旧版) |
| **FieldCatalogCard** | `FieldCatalogCard.tsx` | /fields (目录模式) |
| **MetricCard** | `MetricCard.tsx` | /metrics (旧版) |
| **MetricCatalogCard** | `MetricCatalogCard.tsx` | /metrics (目录模式) |

### 4.5 核心 Hook: useDataTable

**文件**: `frontend/src/hooks/useDataTable.ts`

**功能**:
统一封装表格的筛选、排序、分页逻辑。

**支持模式**:
- **前端模式** (`serverSide: false`): 一次性加载全部数据，客户端筛选排序
- **后端模式** (`serverSide: true`): 服务端分页，通过 `onParamsChange` 回调触发 API 请求

**返回值**:
```typescript
{
  displayData,          // 当前页显示的数据
  filteredData,         // 筛选后的全部数据
  totalCount,           // 筛选后总数
  facets,               // Facet 统计
  activeFilters,        // 当前激活的筛选条件
  handleFilterChange,   // 筛选变更处理
  handleBatchFilterChange,
  handleClearAllFilters,
  sortState,            // 排序状态
  handleSortChange,     // 排序变更处理
  paginationState,      // 分页状态
  handlePageChange,     // 页码变更处理
  handlePageSizeChange, // 每页条数变更
  searchTerm,           // 搜索关键词
  setSearchTerm,
  handleSearch,         // 执行搜索
  clearSearch,          // 清空搜索
}
```

---

## 五、API 接口汇总

### 5.1 核心接口

| 路径 | 方法 | 说明 |
|------|------|------|
| `/api/stats` | GET | 全局统计数据 |
| `/api/dashboard/analysis` | GET | 治理健康度分析 |
| `/api/search?q=` | GET | 全局搜索 |

### 5.2 资源列表接口

| 路径 | 方法 | 支持参数 |
|------|------|----------|
| `/api/databases` | GET | `page`, `page_size`, `connection_type` |
| `/api/tables` | GET | `page`, `page_size`, `schema`, `database_name`, `is_embedded` |
| `/api/datasources` | GET | `page`, `page_size`, `is_certified`, `project_name`, `is_embedded` |
| `/api/workbooks` | GET | `page`, `page_size`, `project_name` |
| `/api/views` | GET | `page`, `page_size`, `view_type`, `workbook_name`, `include_standalone` |
| `/api/fields` | GET | `page`, `page_size`, `role` |
| `/api/fields/catalog` | GET | `page`, `page_size`, `role`, `dedup_method` |
| `/api/metrics` | GET | `page`, `page_size`, `role` |
| `/api/metrics/catalog` | GET | `page`, `page_size`, `role`, `dedup_method` |
| `/api/projects` | GET | `page`, `page_size` |
| `/api/users` | GET | `page`, `page_size` |
| `/api/glossary` | GET | `page`, `page_size`, `search`, `element` |

### 5.3 资源详情接口

| 路径 | 方法 | 说明 |
|------|------|------|
| `/api/databases/<id>` | GET | 数据库详情 |
| `/api/tables/<id>` | GET | 数据表详情 |
| `/api/datasources/<id>` | GET | 数据源详情 |
| `/api/workbooks/<id>` | GET | 工作簿详情 |
| `/api/views/<id>` | GET | 视图详情 |
| `/api/fields/<id>` | GET | 字段详情（支持 `mode=aggregated`） |
| `/api/metrics/<id>` | GET | 指标详情（支持 `mode=aggregated`） |

### 5.4 血缘接口

| 路径 | 方法 | 说明 |
|------|------|------|
| `/api/lineage/<type>/<id>` | GET | 单资产血缘关系 |
| `/api/lineage/graph/<type>/<id>` | GET | Mermaid 血缘图 |
| `/api/lineage/sankey` | GET | 全局桑基图数据 |

### 5.5 治理分析接口

| 路径 | 方法 | 说明 |
|------|------|------|
| `/api/tables/governance/unused` | GET | 孤立表分析 |
| `/api/datasources/governance/uncertified` | GET | 未认证数据源 |
| `/api/datasources/governance/orphan` | GET | 孤立数据源 |
| `/api/workbooks/governance/empty` | GET | 空工作簿 |
| `/api/views/governance/zero-access` | GET | 零访问视图 |
| `/api/fields/governance/no-description` | GET | 无描述字段 |
| `/api/fields/governance/orphan` | GET | 孤立字段 |
| `/api/fields/governance/hot` | GET | 热门字段 |
| `/api/metrics/governance/duplicate-name` | GET | 同名不同公式 |
| `/api/metrics/governance/duplicate-formula` | GET | 同公式不同名称 |
| `/api/metrics/governance/complex` | GET | 高复杂度指标 |
| `/api/metrics/governance/unused` | GET | 未使用指标 |

---

## 六、数据同步说明

### 6.1 同步命令

```bash
# 完整同步
python3 backend/tableau_sync.py

# 跳过视图使用统计
python3 backend/tableau_sync.py --skip-usage

# 仅同步视图使用统计
python3 backend/tableau_sync.py --usage-only
```

### 6.2 同步流程

```
1. 认证 Tableau Server (PAT 令牌)
2. 采集元数据 (GraphQL Metadata API)
   - databases, tables, columns
   - datasources, workbooks, views
   - fields, calculated_fields
   - projects, users
3. 建立血缘关系
   - table_to_datasource
   - datasource_to_workbook
   - field_to_view
   - dashboard_to_sheet
4. 预计算统计字段 (calculate_stats)
5. 同步视图使用统计 (REST API)
6. 写入 SQLite 数据库
```

### 6.3 关键修复 (2025-12-25)

- 修复仪表板字段关联缺失问题
- `fetch_views_with_fields` 现在同时查询 sheets 和 dashboards
- 字段-视图血缘关系完整采集

---

## 七、启动部署

### 7.1 开发模式

```bash
# 一键启动
python3 dev.py

# 访问地址
# 前端: http://localhost:3200
# 后端: http://localhost:8201
```

### 7.2 生产模式

```bash
# 一键构建并启动
python3 deploy.py

# 跳过构建
python3 deploy.py --skip-build
```

### 7.3 环境配置

```bash
# .env 文件
TABLEAU_BASE_URL=http://tbi.juneyaoair.com
TABLEAU_PAT_NAME=your_pat_name
TABLEAU_PAT_SECRET=your_pat_secret
```

---

## 八、附录

### 8.1 技术栈详情

| 层级 | 技术 | 版本 |
|------|------|------|
| 前端框架 | Next.js | 16.0.10 |
| UI 库 | React | 19.2.1 |
| 类型系统 | TypeScript | 5.x |
| 样式 | Tailwind CSS | 4.x |
| 图标 | Lucide React | 0.561+ |
| 图表 | Recharts, ECharts | - |
| 血缘图 | Mermaid | 11.x |
| 后端框架 | Flask | 3.0 |
| ORM | SQLAlchemy | - |
| 数据库 | SQLite | - |

### 8.2 文件结构

```
metadata分析/
├── frontend/                   # Next.js 前端
│   ├── src/app/               # 页面路由
│   ├── src/components/        # 组件库
│   ├── src/hooks/             # 自定义 Hooks
│   └── src/lib/               # 工具库
├── backend/                    # Flask 后端
│   ├── routes/                # API 路由
│   ├── services/              # 业务逻辑
│   └── models.py              # ORM 模型
├── scripts/                    # 工具脚本
├── tests/                      # 测试
├── data/metadata.db           # SQLite 数据库
├── dev.py                     # 开发启动脚本
└── deploy.py                  # 生产部署脚本
```

---

**报告生成完毕**

> 本报告完整记录了 Tableau 元数据治理平台的所有模块、元素和功能，可作为产品文档、开发参考和用户培训材料使用。
