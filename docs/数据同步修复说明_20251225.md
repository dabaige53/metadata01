# 数据同步修复说明（2025-12-25）

## 问题概述

在数据初始化过程中发现严重的血缘关系缺失问题，导致大量字段无法与视图建立关联。

## 问题详情

### 1. 字段-视图关系严重缺失

**数据统计**（修复前）：
- `fields` 表总数：20,231个字段
- `field_to_view` 关联数：15,288条
- 有视图关系的字段：3,063个（**仅15%**）
- **无视图关系的字段：17,168个（85%）**

**问题分布**：
| 字段类型 | 总数 | 有视图关系 | 无视图关系 | 缺失率 |
|---------|------|-----------|-----------|--------|
| 嵌入式原始字段 | 11,579 | 1,353 | 10,226 | 88% |
| 嵌入式计算字段 | 4,934 | 1,710 | 3,224 | 65% |
| 已发布数据源原始字段 | 3,717 | 0 | 3,717 | 100% |
| 已发布数据源计算字段 | 1 | 0 | 1 | 100% |

### 2. 仪表板字段完全缺失

**根本原因**：`fetch_views_with_fields()` 方法只查询 `sheets`，未查询 `dashboards`

**影响**：
- 199个仪表板（100%）无字段关联
- 仪表板包含的字段无法被统计
- 仪表板的血缘分析完全失效

### 3. V5新表迁移继承问题

V5迁移脚本从 `field_to_view` 表迁移数据到新表（`regular_field_to_view` 和 `calc_field_to_view`），但源表本身数据就不完整，导致新表也不完整。

## 修复方案

### 修复内容

**文件**：`backend/services/tableau_client.py`

**修改位置**：`fetch_views_with_fields()` 方法（第820-910行）

**修改前**：
```python
sheets {{
    id
    name
    sheetFieldInstances {{
        id
        name
        datasource {{ id }}
    }}
}}
# ❌ 缺少 dashboards 的查询
```

**修改后**：
```python
sheets {{
    id
    name
    sheetFieldInstances {{
        id
        name
        datasource {{ id }}
    }}
}}
dashboards {{  # ✅ 新增仪表板查询
    id
    name
    dashboardFieldInstances {{
        id
        name
        datasource {{ id }}
    }}
}}
```

**解析逻辑增强**：
- 增加对 `dashboards` 数据的解析
- 为每个字段关联记录增加 `view_type` 标识（sheet/dashboard）
- 合并 sheets 和 dashboards 的字段关联

### 修复流程

1. **备份旧逻辑**
   ```bash
   backend/services/archived/tableau_client_20251225.py
   ```

2. **修改API查询**
   - 增加 `dashboards` 查询
   - 增加 `dashboardFieldInstances` 字段获取

3. **清空并重新同步数据**
   ```bash
   # 备份旧数据库
   cp data/metadata.db data/metadata_backup_20251225.db

   # 删除旧数据库
   rm -f data/metadata.db

   # 初始化新数据库
   PYTHONPATH=. python3 backend/init_db.py

   # 重新同步（包含修复后的逻辑）
   PYTHONPATH=. python3 backend/tableau_sync.py
   ```

4. **运行V5迁移**
   - 同步完成后自动触发V5迁移
   - 将完整的 `field_to_view` 数据迁移到新表

## 预期效果

### 修复前
- ❌ 字段-视图关系覆盖率：15%
- ❌ 仪表板字段关联：0%
- ❌ 血缘分析不完整
- ❌ 字段治理功能结果不可信

### 修复后
- ✅ 字段-视图关系完整
- ✅ 仪表板字段可追溯
- ✅ 血缘分析准确
- ✅ 治理功能可用

## 验证方法

### 1. 检查字段-视图关系总数

```sql
SELECT COUNT(*) FROM field_to_view;
-- 预期：显著增加（从15,288增加到预计30,000+）
```

### 2. ��查仪表板字段关联

```sql
SELECT
    COUNT(DISTINCT v.id) as dashboard_count,
    COUNT(DISTINCT ftv.field_id) as fields_with_dashboard_relation
FROM views v
LEFT JOIN field_to_view ftv ON v.id = ftv.view_id
WHERE v.view_type = 'dashboard';
-- 预期：fields_with_dashboard_relation > 0
```

### 3. 检查字段覆盖率

```sql
SELECT
    COUNT(*) as total_fields,
    COUNT(CASE WHEN id IN (SELECT field_id FROM field_to_view) THEN 1 END) as fields_with_view,
    ROUND(100.0 * COUNT(CASE WHEN id IN (SELECT field_id FROM field_to_view) THEN 1 END) / COUNT(*), 2) as coverage_rate
FROM fields;
-- 预期：coverage_rate 显著提升（从15%提升到预计50%+）
```

## 影响范围

### 受影响的功能模块

1. **字段模块** (`/fields`)
   - 字段使用统计现在准确
   - "孤立字段"检测结果可信

2. **视图模块** (`/views`)
   - 视图的字段列表完整
   - 仪表板字段可追溯

3. **工作簿模块** (`/workbooks`)
   - 工作簿的字段统计准确
   - 字段使用分析完整

4. **血缘分析**
   - 字段→视图血缘完整
   - 端到端血缘可追溯

### 不受影响的功能

- 数据表模块（已在之前修复）
- 数据源模块
- 项目模块
- 用户模块

## 后续建议

1. **立即重新同步**
   - 如果数据库是2025-12-25之前同步的，建议立即重新同步

2. **定期验证**
   - 每次同步后运行验证脚本检查数据完整性
   - 使用 `scripts/validation/verify_card_detail_consistency.py`

3. **监控指标**
   - 监控 `field_to_view` 表的记录数
   - 监控字段覆盖率（有视图关系的字段占比）

4. **文档更新**
   - ✅ 已更新 `CLAUDE.md`
   - ✅ 已创建本修复说明文档

## 技术细节

### Tableau Metadata API

**GraphQL 查询结构**：
```graphql
{
  workbooks(filter: {id: "xxx"}) {
    id
    name
    sheets {
      id
      name
      sheetFieldInstances {
        id
        name
        datasource { id }
      }
    }
    dashboards {  # 新增
      id
      name
      dashboardFieldInstances {  # 新增
        id
        name
        datasource { id }
      }
    }
  }
}
```

### 数据流向

```
Tableau Server (GraphQL API)
    ↓
fetch_views_with_fields() [修复后]
    ↓ 返回 sheets + dashboards 的字段
sync_field_to_view()
    ↓ 写入 field_to_view 表
V5 Migration
    ↓ 迁移到 regular_field_to_view + calc_field_to_view
完整的字段-视图血缘关系
```

## 归档信息

- **修复日期**：2025-12-25
- **修复人员**：Claude Code
- **旧代码备份**：`backend/services/archived/tableau_client_20251225.py`
- **旧数据库备份**：`data/metadata_backup_20251225.db`
- **相关Issue**：数据初始化不全面，导致很多字段和计算字段没有连接上血缘

## 相关文档

- `CLAUDE.md` - 项目主文档（已更新）
- `docs/validation_json/embedded_tables.json` - 嵌入式表验证规范（已更新）
- `scripts/validation/verify_card_detail_consistency.py` - 一致性验证脚本
