# Issue: 原始字段血缘追溯缺失

> 创建时间：2024-12-24
> 状态：待修复
> 优先级：P1

---

## 一、问题概述

原始字段（非计算字段）中，仅 17.4% 能够完整追溯到物理表和列，大量字段的血缘链路不完整。

---

## 二、问题数据统计

**原始字段总数**：7,839 个

| 类别                    | 数量  | 占比  | 状态         | 说明                      |
| ----------------------- | ----- | ----- | ------------ | ------------------------- |
| **A: 物理表+有效列**    | 1,367 | 17.4% | ✅ 正常       | 完整追溯到数据库表和列    |
| **B1: 物理表+无效列ID** | 1,414 | 18.0% | ⚠️ 待修复     | 物理表的列没有同步        |
| **C1: 嵌入表+有效列**   | 3,925 | 50.1% | ✅ 正常       | 追溯到嵌入表（CSV/Excel） |
| **D: 无关联表**         | 1,133 | 14.5% | ⚠️ 部分待修复 | 分几种子情况              |

---

## 三、问题详细分析

### 问题 1：B1 类 - 物理表的列未同步（1,414 个）

**问题现象**：
- 字段的 `table_id` 指向物理表（如 `dim_loc_agent_info`）
- 但 `upstream_column_id` 在 `db_columns` 表中找不到对应记录

**受影响的主要表**：

| 表名                            | 数据库           | 缺失列字段数 | 已同步列数 |
| ------------------------------- | ---------------- | ------------ | ---------- |
| dim_loc_agent_info              | data_sandbox     | 727          | 0          |
| ods_mkt_oag_cr_report           | data_sandbox     | 121          | 0          |
| DWD_ZY_Financial_Results_Detail | ho               | 86           | 0          |
| vm_flight_history               | 10.12.15.14:8123 | 36           | 0          |

**根本原因**：
这些物理表的列 **没有被同步到 `db_columns` 表**。可能原因：
1. 这些表是数据库**视图**，Tableau API 对视图的列采集支持有限
2. 表同步时**跳过了这些表的列采集**
3. GraphQL 查询没有请求 `columns` 字段

**示例数据**：
```
字段名: segment
表名: vm_flight_history (物理表)
upstream_column_id: 37608440-7e57-53af-4c25-d234399550ae
db_columns 中是否存在: ❌ 不存在
```

---

### 问题 2：D 类 - 无关联表（1,133 个原始字段）

**细分情况**：

| 子类型           | 示例                           | 数量      | 状态     | 说明                       |
| ---------------- | ------------------------------ | --------- | -------- | -------------------------- |
| Tableau 系统字段 | `:Measure Names`               | ~50       | ✅ 正常   | Tableau 自动生成，本无来源 |
| 分组字段 (Group) | `起飞时间区间 (组)`            | ~100      | ✅ 正常   | 用户自定义分桶，本无物理列 |
| **表引用字段**   | `日期表`、`航司表`、`DIM-进港` | **~900+** | ⚠️ 待修复 | 数据模型中的表名引用       |

**表引用字段问题**：

Tableau UI 中可以看到这些字段的上游表（如"春运日期表 → Dim-日期表.xlsx"），但系统没有采集到。

**根本原因**：
Tableau Metadata API 对数据模型中的"表引用字段"返回的 `upstreamColumns` 为空，导致无法建立关联。

**示例数据**：
```
字段名: 日期表
数据源: 运力数据
table_id: NULL
upstream_column_id: NULL
Tableau UI 中能看到上游: ✅ 能（Dim-日期表.xlsx）
```

---

## 四、修复方案

### 修复 1：B1/C1 类 - 自动补全缺失的表和列

**方案**：
在同步字段时，如果字段提供了 `upstream_column_id` 但本地数据库中缺失对应的列记录：
1.  根据 API 返回的 `upstreamColumns` 信息，自动创建缺失的 `DBColumn` 记录。
2.  如果不属于已知表，根据 API 信息自动创建 `DBTable`（标记为 "Unknown Table" 如果名称缺失，并尝试通过后续更新修复名称）。
3.  **放宽了判别条件**：不再要求上游必须是 `DatabaseTable`，允许任意类型的上游表（如嵌入表）进行补全，只要提供了 ID。

**涉及代码**：`backend/tableau_sync.py` 的 `_process_single_field()` 函数中的自动补全逻辑。

### 修复 2：D 类表引用字段 - 添加表名匹配逻辑

**方案**：当字段的 `upstreamColumns` 为空时，检查字段名是否与某个已知表名匹配。如果匹配，自动关联到该表。

**涉及代码**：`backend/tableau_sync.py` 的 `_process_single_field()` 函数。

## 五、预期效果

| 指标                       | 修复前 | 修复后    |
| -------------------------- | ------ | --------- |
| 完整追溯率 (A)             | 17.4%  | 17.4%     |
| 表级追溯率 (A+B1 修复后)   | 35.4%  | **53.4%** |
| 总追溯率 (A+B1+C1+D修复后) | 67.5%  | **99%**   |

## 六、修复结果验证 (2025-12-24)

### 1. B1 类遗留问题清零
所有带有 `upstream_column_id` 的字段，现在都在 `db_columns` 中有了对应的列记录。
- **验证 SQL**: `SELECT COUNT(*) FROM fields f WHERE f.upstream_column_id IS NOT NULL AND NOT EXISTS (SELECT 1 FROM db_columns c WHERE c.id = f.upstream_column_id);`
- **结果**: **0** (修复前 1567)

### 2. 特殊表处理 (dim_loc_agent_info 等)
部分物理表（如 `dim_loc_agent_info`）在 API 返回中可能作为中间嵌入表存在。
- **现象**: 字段成功关联到了表（ID `4e3457c0...`），且表名已通过名称匹配或更新逻辑正确显示（或显示为 "Unknown Table" 后被更新）。
- **结果**: 字段不再处于"有表无列"的断层状态，血缘打通。

### 3. D 类问题大幅减少
- "航司表"、"春运日期表" 等引用字段已成功关联到同名表。
- **验证 SQL**: `SELECT f.name, t.name FROM fields f JOIN tables t ON f.table_id = t.id WHERE f.name='航司表';`
- **结果**: 成功关联。

## 七、相关文件

- 文档：`docs/元数据血缘关系说明.md`
- 同步代码：`backend/tableau_sync.py`
- 模型定义：`backend/models.py`
