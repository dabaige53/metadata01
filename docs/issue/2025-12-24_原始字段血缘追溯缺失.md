# Issue: 原始字段血缘追溯缺失

> 创建时间：2024-12-24
> 状态：待修复
> 优先级：P1

---

## 一、问题概述

原始字段（非计算字段）中，仅 17.4% 能够完整追溯到物理表和列，大量字段的血缘链路不完整。

---

## 二、问题数据统计

**原始字段总数**：7,839 个

| 类别                    | 数量  | 占比  | 状态         | 说明                      |
| ----------------------- | ----- | ----- | ------------ | ------------------------- |
| **A: 物理表+有效列**    | 1,367 | 17.4% | ✅ 正常       | 完整追溯到数据库表和列    |
| **B1: 物理表+无效列ID** | 1,414 | 18.0% | ⚠️ 待修复     | 物理表的列没有同步        |
| **C1: 嵌入表+有效列**   | 3,925 | 50.1% | ✅ 正常       | 追溯到嵌入表（CSV/Excel） |
| **D: 无关联表**         | 1,133 | 14.5% | ⚠️ 部分待修复 | 分几种子情况              |

---

## 三、问题详细分析

### 问题 1：B1 类 - 物理表的列未同步（1,414 个）

**问题现象**：
- 字段的 `table_id` 指向物理表（如 `dim_loc_agent_info`）
- 但 `upstream_column_id` 在 `db_columns` 表中找不到对应记录

**受影响的主要表**：

| 表名                            | 数据库           | 缺失列字段数 | 已同步列数 |
| ------------------------------- | ---------------- | ------------ | ---------- |
| dim_loc_agent_info              | data_sandbox     | 727          | 0          |
| ods_mkt_oag_cr_report           | data_sandbox     | 121          | 0          |
| DWD_ZY_Financial_Results_Detail | ho               | 86           | 0          |
| vm_flight_history               | 10.12.15.14:8123 | 36           | 0          |

**根本原因**：
这些物理表的列 **没有被同步到 `db_columns` 表**。可能原因：
1. 这些表是数据库**视图**，Tableau API 对视图的列采集支持有限
2. 表同步时**跳过了这些表的列采集**
3. GraphQL 查询没有请求 `columns` 字段

**示例数据**：
```
字段名: segment
表名: vm_flight_history (物理表)
upstream_column_id: 37608440-7e57-53af-4c25-d234399550ae
db_columns 中是否存在: ❌ 不存在
```

---

### 问题 2：D 类 - 无关联表（1,133 个原始字段）

**细分情况**：

| 子类型           | 示例                           | 数量      | 状态     | 说明                       |
| ---------------- | ------------------------------ | --------- | -------- | -------------------------- |
| Tableau 系统字段 | `:Measure Names`               | ~50       | ✅ 正常   | Tableau 自动生成，本无来源 |
| 分组字段 (Group) | `起飞时间区间 (组)`            | ~100      | ✅ 正常   | 用户自定义分桶，本无物理列 |
| **表引用字段**   | `日期表`、`航司表`、`DIM-进港` | **~900+** | ⚠️ 待修复 | 数据模型中的表名引用       |

**表引用字段问题**：

Tableau UI 中可以看到这些字段的上游表（如"春运日期表 → Dim-日期表.xlsx"），但系统没有采集到。

**根本原因**：
Tableau Metadata API 对数据模型中的"表引用字段"返回的 `upstreamColumns` 为空，导致无法建立关联。

**示例数据**：
```
字段名: 日期表
数据源: 运力数据
table_id: NULL
upstream_column_id: NULL
Tableau UI 中能看到上游: ✅ 能（Dim-日期表.xlsx）
```

---

## 四、修复方案

### 修复 1：B1 类 - 确保物理表的列被同步

**方案**：检查表同步逻辑，确保 GraphQL 查询包含 `columns` 字段，并为所有物理表同步其列信息。

**涉及代码**：`backend/tableau_sync.py` 的 `sync_tables()` 函数

**验证方式**：
```sql
-- 修复后应该没有"物理表列数为0"的情况
SELECT t.name, COUNT(c.id) as column_count
FROM tables t
LEFT JOIN db_columns c ON c.table_id = t.id
WHERE t.is_embedded = 0
GROUP BY t.id
HAVING column_count = 0;
```

---

### 修复 2：D 类表引用字段 - 添加表名匹配逻辑

**方案**：当字段的 `upstreamColumns` 为空时，检查字段名是否与某个已知表名匹配。如果匹配，自动关联到该表。

**涉及代码**：`backend/tableau_sync.py` 的 `_process_single_field()` 函数

**新增逻辑**：
```python
# 补救逻辑：当 upstreamColumns 为空时
if not field.table_id and field.name:
    # 检查字段名是否与表名匹配
    matching_table = session.query(DBTable).filter_by(name=field.name).first()
    if matching_table:
        field.table_id = matching_table.id
```

**验证方式**：
```sql
-- 修复后"表引用字段"应该有 table_id
SELECT f.name, f.table_id, t.name as table_name
FROM fields f
LEFT JOIN tables t ON f.table_id = t.id
WHERE f.name IN ('日期表', '航司表', 'DIM-进港')
  AND f.table_id IS NOT NULL;
```

---

## 五、预期效果

| 指标                       | 修复前 | 修复后    |
| -------------------------- | ------ | --------- |
| 完整追溯率 (A)             | 17.4%  | 17.4%     |
| 表级追溯率 (A+B1 修复后)   | 35.4%  | **53.4%** |
| 总追溯率 (A+B1+C1+D修复后) | 67.5%  | **~85%**  |

---

## 六、相关文件

- 文档：`docs/元数据血缘关系说明.md`
- 同步代码：`backend/tableau_sync.py`
- 模型定义：`backend/models.py`
