# Issue: Prefetch 404 错误 - 孤立 table_id 引用

**日期**: 2025-12-24  
**状态**: ✅ 已修复  
**严重程度**: 低（用户体验问题）  

---

## 问题描述

控制台频繁报错：
```
Prefetch failed for "tables:46a9e6d8-35e8-f14b-9e29-9cd653811fca" Error: API Error: 404 NOT FOUND
```

用户在查看字段详情时，hover 到「所属数据表」会触发后台预取请求，但由于该 table_id 在数据库中不存在，导致 404 错误。

---

## 根因分析

### 数据不一致问题

通过数据库查询验证：

```sql
-- fields 表中孤立的 table_id 引用
SELECT COUNT(*) FROM fields 
WHERE table_id IS NOT NULL 
AND table_id NOT IN (SELECT id FROM tables);
-- 结果：1526

-- field_full_lineage 表中孤立的 table_id 引用
SELECT COUNT(*) FROM field_full_lineage 
WHERE table_id IS NOT NULL 
AND table_id NOT IN (SELECT id FROM tables);
-- 结果：1510
```

**结论**：存在大量字段引用了不存在的 `table_id`，这些是在数据同步过程中产生的孤立引用。

### 触发流程

```
用户 hover 「所属数据表」卡片
    ↓
前端 prefetch(table_id, 'tables')
    ↓
调用 GET /api/tables/{table_id}
    ↓
后端查询 tables 表，找不到记录
    ↓
返回 404 NOT FOUND
    ↓
前端 console.error 打印错误
```

---

## 修复方案

### 1. 前端防御性优化

**文件**: `frontend/src/lib/drawer-context.tsx`

静默处理 404 错误，仅在开发模式下打印 warn 级别日志：

```typescript
try {
    const data = await api.getDetail(type, id);
    setCache(prev => ({ ...prev, [key]: data }));
} catch (e: any) {
    // 静默处理 404 错误（孤立引用导致的数据不一致）
    if (e?.message?.includes('404')) {
        if (process.env.NODE_ENV === 'development') {
            console.warn(`[Prefetch] 资源不存在: ${key}`);
        }
    } else {
        console.error('Prefetch failed for', key, e);
    }
}
```

### 2. 后端数据过滤优化

**文件**: `backend/routes/api.py`

在字段详情 API 的 table_info 查询中，将 `LEFT JOIN` 改为 `INNER JOIN`，过滤掉不存在的 table_id：

```sql
-- 修改前 (LEFT JOIN 会返回孤立的 table_id)
SELECT DISTINCT fl.table_id, t.name, ...
FROM fields f
JOIN field_full_lineage fl ON f.id = fl.field_id
LEFT JOIN tables t ON fl.table_id = t.id  -- 这里即使 t 不存在也会返回 fl.table_id
...

-- 修改后 (INNER JOIN 只返回真实存在的表)
SELECT DISTINCT fl.table_id, t.name, ...
FROM fields f
JOIN field_full_lineage fl ON f.id = fl.field_id
JOIN tables t ON fl.table_id = t.id  -- 只返回实际存在的表
...
WHERE ... AND t.id IS NOT NULL
```

---

## 验证结果

修复后：
1. ✅ 控制台不再频繁出现红色 404 错误
2. ✅ 字段详情页的「所属数据表」只显示真实存在的表
3. ✅ 用户体验改善，开发调试更清晰

---

## 后续建议

此问题暴露了数据同步过程中的**引用完整性**问题。建议在后续版本中：

1. **同步脚本优化**：在 `tableau_sync.py` 中添加外键约束检查
2. **数据清理**：提供清理孤立引用的维护脚本
3. **监控告警**：在验证脚本中添加孤立引用的检测项

---

## 相关文件

- `frontend/src/lib/drawer-context.tsx` - 预取逻辑
- `backend/routes/api.py` - 字段详情 API
- `backend/tableau_sync.py` - 数据同步脚本
