# Issue: 嵌入式表无法关联工作簿

**日期**: 2025-12-24  
**状态**: ✅ 已修复  
**严重程度**: 中等  

---

## 问题描述

用户发现嵌入式数据表（`is_embedded=1`）在详情页显示"引用工作簿: 0"，但嵌入式表应该来自工作簿，理应能追溯到其所属工作簿。

## 问题截图

嵌入式表详情显示缺失工作簿关联信息。

## 根因分析

### 正确的血缘链路

```
嵌入式表 → 嵌入式数据源 → 工作簿
   │             │            │
   └─table_to_datasource      │
                 └─datasource_to_workbook
```

### 发现的问题

在 `backend/tableau_sync.py` 的 `sync_workbooks()` 方法中，处理嵌入式数据源时存在两种场景：

1. **场景1**: 嵌入式数据源引用已发布数据源（穿透模式）
2. **场景2**: 完全独立的嵌入式直连源（保留模式）

**Bug**: 场景1 只调用了 `_save_embedded_datasource()` 保存嵌入式数据源记录，但**遗漏了** `_link_datasource_to_workbook()` 调用，导致嵌入式数据源没有建立到工作簿的关联。

### 数据影响统计

| 指标                     | 数量 |
| ------------------------ | ---- |
| 嵌入式表总数             | 446  |
| 有数据源关联的嵌入式表   | 139  |
| 嵌入式数据源有工作簿关联 | 47   |
| 嵌入式数据源无工作簿关联 | 68   |

---

## 修复方案

### 代码修改

**文件**: `backend/tableau_sync.py`  
**位置**: `sync_workbooks()` 方法，第 1450-1451 行

```diff
                         # 🆕 场景1也保存嵌入式数据源记录，并设置 source_published_datasource_id
                         self._save_embedded_datasource(eds, wb_data["id"], source_published_ds_id=upstream_ds_id)
+                        # 🔧 修复：场景1也需要建立嵌入式数据源到工作簿的关联
+                        self._link_datasource_to_workbook(eds["id"], wb_data["id"])
```

### 前端优化

**文件**: `frontend/src/components/cards/TableCard.tsx`

为嵌入式表优化卡片显示：
- 使用更友好的状态标签（"已关联"/"待关联"）
- 隐藏不准确的"工作簿 0个"信息

---

## 验证步骤

1. 执行数据初始化同步
2. 检查嵌入式数据源的 `datasource_to_workbook` 关联数量
3. 验证嵌入式表详情页能正确显示关联工作簿

---

## 相关文件

- `backend/tableau_sync.py` - 元数据同步逻辑
- `backend/routes/api.py` - 表详情 API
- `frontend/src/components/cards/TableCard.tsx` - 表卡片组件
