# Issue: åµŒå…¥å¼è¡¨æ— æ³•å…³è”å·¥ä½œç°¿

**æ—¥æœŸ**: 2025-12-24  
**çŠ¶æ€**: âœ… å·²ä¿®å¤  
**ä¸¥é‡ç¨‹åº¦**: ä¸­ç­‰  

---

## é—®é¢˜æè¿°

ç”¨æˆ·å‘ç°åµŒå…¥å¼æ•°æ®è¡¨ï¼ˆ`is_embedded=1`ï¼‰åœ¨è¯¦æƒ…é¡µæ˜¾ç¤º"å¼•ç”¨å·¥ä½œç°¿: 0"ï¼Œä½†åµŒå…¥å¼è¡¨åº”è¯¥æ¥è‡ªå·¥ä½œç°¿ï¼Œç†åº”èƒ½è¿½æº¯åˆ°å…¶æ‰€å±å·¥ä½œç°¿ã€‚

## é—®é¢˜æˆªå›¾

åµŒå…¥å¼è¡¨è¯¦æƒ…æ˜¾ç¤ºç¼ºå¤±å·¥ä½œç°¿å…³è”ä¿¡æ¯ã€‚

## æ ¹å› åˆ†æ

### æ­£ç¡®çš„è¡€ç¼˜é“¾è·¯

```
åµŒå…¥å¼è¡¨ â†’ åµŒå…¥å¼æ•°æ®æº â†’ å·¥ä½œç°¿
   â”‚             â”‚            â”‚
   â””â”€table_to_datasource      â”‚
                 â””â”€datasource_to_workbook
```

### å‘ç°çš„é—®é¢˜

åœ¨ `backend/tableau_sync.py` çš„ `sync_workbooks()` æ–¹æ³•ä¸­ï¼Œå¤„ç†åµŒå…¥å¼æ•°æ®æºæ—¶å­˜åœ¨ä¸¤ç§åœºæ™¯ï¼š

1. **åœºæ™¯1**: åµŒå…¥å¼æ•°æ®æºå¼•ç”¨å·²å‘å¸ƒæ•°æ®æºï¼ˆç©¿é€æ¨¡å¼ï¼‰
2. **åœºæ™¯2**: å®Œå…¨ç‹¬ç«‹çš„åµŒå…¥å¼ç›´è¿æºï¼ˆä¿ç•™æ¨¡å¼ï¼‰

**Bug**: åœºæ™¯1 åªè°ƒç”¨äº† `_save_embedded_datasource()` ä¿å­˜åµŒå…¥å¼æ•°æ®æºè®°å½•ï¼Œä½†**é—æ¼äº†** `_link_datasource_to_workbook()` è°ƒç”¨ï¼Œå¯¼è‡´åµŒå…¥å¼æ•°æ®æºæ²¡æœ‰å»ºç«‹åˆ°å·¥ä½œç°¿çš„å…³è”ã€‚

### æ•°æ®å½±å“ç»Ÿè®¡

| æŒ‡æ ‡                     | æ•°é‡ |
| ------------------------ | ---- |
| åµŒå…¥å¼è¡¨æ€»æ•°             | 446  |
| æœ‰æ•°æ®æºå…³è”çš„åµŒå…¥å¼è¡¨   | 139  |
| åµŒå…¥å¼æ•°æ®æºæœ‰å·¥ä½œç°¿å…³è” | 47   |
| åµŒå…¥å¼æ•°æ®æºæ— å·¥ä½œç°¿å…³è” | 68   |

---

## ä¿®å¤æ–¹æ¡ˆ

### ä»£ç ä¿®æ”¹

**æ–‡ä»¶**: `backend/tableau_sync.py`  
**ä½ç½®**: `sync_workbooks()` æ–¹æ³•ï¼Œç¬¬ 1450-1451 è¡Œ

```diff
                         # ğŸ†• åœºæ™¯1ä¹Ÿä¿å­˜åµŒå…¥å¼æ•°æ®æºè®°å½•ï¼Œå¹¶è®¾ç½® source_published_datasource_id
                         self._save_embedded_datasource(eds, wb_data["id"], source_published_ds_id=upstream_ds_id)
+                        # ğŸ”§ ä¿®å¤ï¼šåœºæ™¯1ä¹Ÿéœ€è¦å»ºç«‹åµŒå…¥å¼æ•°æ®æºåˆ°å·¥ä½œç°¿çš„å…³è”
+                        self._link_datasource_to_workbook(eds["id"], wb_data["id"])
```

### å‰ç«¯ä¼˜åŒ–

**æ–‡ä»¶**: `frontend/src/components/cards/TableCard.tsx`

ä¸ºåµŒå…¥å¼è¡¨ä¼˜åŒ–å¡ç‰‡æ˜¾ç¤ºï¼š
- ä½¿ç”¨æ›´å‹å¥½çš„çŠ¶æ€æ ‡ç­¾ï¼ˆ"å·²å…³è”"/"å¾…å…³è”"ï¼‰
- éšè—ä¸å‡†ç¡®çš„"å·¥ä½œç°¿ 0ä¸ª"ä¿¡æ¯

---

## é™„åŠ é—®é¢˜ï¼šå­—æ®µè¯¦æƒ…é¡µ"å¼•ç”¨å·¥ä½œç°¿"è®¡æ•°æ˜¾ç¤ºä¸º0

### é—®é¢˜ç°è±¡

å­—æ®µè¯¦æƒ…é¡µçš„ Tab æ ‡ç­¾æ˜¾ç¤º"å¼•ç”¨å·¥ä½œç°¿ (0)"ï¼Œä½†å®é™…ä¸‹æ–¹åˆ—è¡¨ä¸­æœ‰å¤šä¸ªå·¥ä½œç°¿ã€‚

### æ ¹å› åˆ†æ

**æ–‡ä»¶**: `frontend/src/components/DetailDrawer.tsx`

1. **Tab æ ‡ç­¾è®¡æ•°**ï¼ˆç¬¬ 269 è¡Œï¼‰ä¼˜å…ˆä½¿ç”¨ `all_workbooks`
2. **Tab å†…å®¹æ¸²æŸ“**ï¼ˆç¬¬ 1357 è¡Œï¼‰ä¼˜å…ˆä½¿ç”¨ `usedInWorkbooks`

å½“åç«¯è¿”å› `all_workbooks = []`ï¼ˆç©ºæ•°ç»„ï¼‰ä½† `usedInWorkbooks` æœ‰æ•°æ®æ—¶ï¼š
- ç©ºæ•°ç»„ `[]` åœ¨ JavaScript ä¸­æ˜¯ truthy å€¼
- `all_workbooks || usedInWorkbooks` ä¼šç›´æ¥è¿”å› `[]`ï¼Œä¸ä¼š fallback

### ä¿®å¤æ–¹æ¡ˆ

**ä¿®æ”¹**ï¼šç»Ÿä¸€ Tab æ ‡ç­¾å’Œå†…å®¹çš„æ•°æ®æºä¼˜å…ˆçº§é€»è¾‘ï¼Œä½¿ç”¨ `Array.find()` æŸ¥æ‰¾ç¬¬ä¸€ä¸ªéç©ºæ•°ç»„ï¼š

```javascript
const allWbSources = [
    data.all_workbooks,
    data.usedInWorkbooks,
    data.used_in_workbooks,
    data.workbooks
];
const allWb = allWbSources.find(arr => arr && arr.length > 0) || [];
```

---

## éªŒè¯æ­¥éª¤

1. æ‰§è¡Œæ•°æ®åˆå§‹åŒ–åŒæ­¥
2. æ£€æŸ¥åµŒå…¥å¼æ•°æ®æºçš„ `datasource_to_workbook` å…³è”æ•°é‡
3. éªŒè¯åµŒå…¥å¼è¡¨è¯¦æƒ…é¡µèƒ½æ­£ç¡®æ˜¾ç¤ºå…³è”å·¥ä½œç°¿
4. **æ–°å¢**ï¼šéªŒè¯å­—æ®µè¯¦æƒ…é¡µ"å¼•ç”¨å·¥ä½œç°¿"Tab æ ‡ç­¾è®¡æ•°ä¸å®é™…å†…å®¹ä¸€è‡´

---

## ç›¸å…³æ–‡ä»¶

- `backend/tableau_sync.py` - å…ƒæ•°æ®åŒæ­¥é€»è¾‘
- `backend/routes/api.py` - è¡¨è¯¦æƒ… API
- `frontend/src/components/cards/TableCard.tsx` - è¡¨å¡ç‰‡ç»„ä»¶
- `frontend/src/components/DetailDrawer.tsx` - è¯¦æƒ…æŠ½å±‰ç»„ä»¶ï¼ˆå­—æ®µå·¥ä½œç°¿è®¡æ•°ï¼‰
