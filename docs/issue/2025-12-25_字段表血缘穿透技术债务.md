# 字段→表血缘穿透问题（技术债务）

## 问题描述

在数据表详情页的"包含字段"Tab中，显示的字段包含了通过 JOIN 关联进来的其他表的字段。

### 具体案例

- **表**: `tbl_tic_trace_ticket`
- **现象**: "包含字段"中出现了"城市中文名"分组，包含"出港-城市英文名"等字段
- **问题**: 这些字段的 `upstream_column_id` 实际指向的是"机场三字代码表"，而非 `tbl_tic_trace_ticket`

### 根本原因

当前的字段获取逻辑存在三条路径：

```python
# tables.py - get_table_detail()

# 1. 直接关联字段（Field.table_id = table.id）✅ 正确
# 2. 间接关联字段（upstream_column_id → DBColumn → table）✅ 正确  
# 3. 通过关联的数据源获取字段 ⚠️ 问题所在
if table.datasources:
    for ds in table.datasources:
        for f in ds.fields:  # 这里拿到的是数据源的所有字段
            full_fields.append(f)  # 包括 JOIN 进来的其他表字段
```

问题在于：`销售航段` 数据源做了**多表 JOIN**（`tbl_tic_trace_ticket` + `机场三字代码表`），当前代码把数据源的所有字段都归属到了表，但这些字段的 `upstream_column_id` 实际指向的是不同的表。

## 当前修复（补丁方案）

在 `tables.py` 的查询层添加了过滤逻辑：

```python
# 3. 通过关联的数据源获取字段（用于嵌入式表）
# 重要：只保留 upstream_column 真正属于当前表的字段
column_ids = set(col.id for col in table.columns) if table.columns else set()

if table.datasources:
    for ds in table.datasources:
        for f in ds.fields:
            if f.id not in seen_field_ids:
                # 过滤逻辑：如果字段有 upstream_column_id，必须属于当前表
                if f.upstream_column_id:
                    if f.upstream_column_id not in column_ids:
                        continue  # 跳过不属于本表的字段
                full_fields.append(f_data)
```

**修复效果**（以 `tbl_tic_trace_ticket` 为例）：
- 过滤前：6654 个字段
- 过滤后：4764 个字段
- 过滤掉：1890 个不属于本表的 JOIN 字段

## 全局修复方案（待实施）

### 方案描述

在数据同步层 (`sync_manager.py`) 修改 `Field.table_id` 的填充逻辑：

1. `Field.table_id` **仅**基于 `upstream_column_id → DBColumn.table_id` 填充
2. 废弃通过 `datasource → table_to_datasource → table` 的间接推导
3. 可选：新增 `field_to_table` 多对多关联表，精确记录字段归属

### 影响评估

| 方面         | 影响                     |
| ------------ | ------------------------ |
| 字段数量     | 表详情页字段数减少约 28% |
| 数据源详情页 | 无影响（仍显示所有字段） |
| 血缘图       | 字段→表连线更精确        |
| 搜索/过滤    | 字段按表过滤更准确       |
| 需要重新同步 | 是                       |

### 相关代码位置

- `backend/routes/tables.py` - 第 289-305 行（当前补丁）
- `backend/services/sync_manager.py` - 第 775-786 行（字段→表关联逻辑）
- `backend/models.py` - `Field.table_id`, `Field.upstream_column_id`

## 优先级

**P2 - 中等优先级**

当前补丁已解决用户可见的问题，全局修复可在后续版本中统一处理。

## 相关 Issue

- 2025-12-24_原始字段血缘追溯缺失.md
