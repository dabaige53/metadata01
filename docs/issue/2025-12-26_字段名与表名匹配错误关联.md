 # 字段名与表名匹配错误关联问题
 
 ## 问题描述
 
 在数据表详情页的"包含字段"Tab中：
 1. 显示"未知数据源"
 2. 出现错误的字段（如 `dwd_tic_hsd_iinv_1min`）
 
 ## 根本原因
 
 ### 1. "未知数据源"显示问题
 
 前端 `DetailDrawer.tsx` 使用 `datasourceName`（驼峰命名），但后端返回的是 `datasource_name`（下划线命名）。
 
 ```javascript
 // 前端期望
 const sourceName = f.via_datasource || f.datasourceName || '未知数据源';
 // 后端实际返回
 { datasource_name: 'IINV', ... }
 ```
 
 ### 2. 错误字段关联问题
 
 后端 `sync_manager.py` 中存在一段"名称匹配"逻辑：
 
 ```python
 # D Fix: 如果此时还没有 table_id，尝试通过名称匹配物理表
 if not field.table_id and field.name:
     matched_table = self.session.query(DBTable).filter_by(name=field.name).first()
     if matched_table:
         field.table_id = matched_table.id
 ```
 
 当字段名与表名相同时（如 `dwd_tic_hsd_iinv_1min`），会错误地将字段关联到该表。
 
 ## 修复方案
 
 ### 1. 前端修复
 
 在 `DetailDrawer.tsx` 中同时支持两种命名格式：
 
 ```javascript
 const sourceName = f.via_datasource || f.datasourceName || f.datasource_name || '未知数据源';
 ```
 
 ### 2. 后端修复
 
 1. **禁用名称匹配逻辑** - 在 `sync_manager.py` 中注释掉错误的名称匹配代码
 2. **修复表详情 API** - 在 `tables.py` 中：
    - 确保所有字段都有 `via_datasource` 值
    - 过滤掉没有 `upstream_column_id` 的字段
 
 ### 3. 数据清理
 
 清理 `fields` 和 `regular_fields` 两张表中错误的 `table_id` 关联：
 
 ```sql
 UPDATE fields 
 SET table_id = NULL
 WHERE id IN (
     SELECT f.id 
     FROM fields f
     JOIN tables t ON f.table_id = t.id
     WHERE f.name = t.name
     AND f.upstream_column_id IS NULL
 );
 
 UPDATE regular_fields 
 SET table_id = NULL
 WHERE id IN (
     SELECT f.id 
     FROM regular_fields f
     JOIN tables t ON f.table_id = t.id
     WHERE f.name = t.name
     AND f.upstream_column_id IS NULL
 );
 ```
 
 ## 修复状态
 
 - [x] 前端字段名映射修复
 - [x] 后端名称匹配逻辑禁用
 - [x] 表详情 API 修复
 - [x] 数据库数据清理（共清理 178 条记录）
- [x] 表列表 API 字段统计修复（field_count 计算逻辑与详情页一致）
 
 ## 待办事项（技术债务）
 
 ### 统一表架构
 
 当前项目存在两套字段表：
 - `fields` (Field 模型) - 老表，同步时的主表
 - `regular_fields` (RegularField 模型) - 新表，分表架构
 
 以下路由仍在使用 `Field`（老表）：
 - `api_legacy.py` - 5 处查询
 - `lineage.py` - 4 处查询
 - `tables.py` - 2 处查询
 - `workbooks.py` - 1 处查询
 
 **建议**：后续可逐步迁移这些路由到新表架构，当前两表数据通过迁移脚本保持一致，不影响功能。
 
 ## 相关文件
 
 - `frontend/src/components/DetailDrawer.tsx`
 - `backend/services/sync_manager.py`
 - `backend/routes/tables.py`
