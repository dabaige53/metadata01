# 计算字段重复及血缘缺失问题分析

## 1. 问题现象

用户反馈计算字段存在与普通字段类似的重复问题。经数据库排查确认：
- **重复字段**：发现 **931** 组计算字段具有相同的名称和公式，但作为不同实体存在。
- **血缘缺失**：**3,807** 个计算字段没有关联到表 (`table_id` 为空)，其中 474 个属于嵌入式数据源。

## 2. 根因分析

### 2.1 为什么会重复？

目前的字段去重逻辑（`sync_fields`）主要依赖两级缓存：
1.  **一级缓存 (已发布字段)**：`(datasource_id, field_name)`。
    *   仅适用于引用了"已发布数据源"的嵌入式字段（穿透型）。
2.  **二级缓存 (物理列)**：`(table_name, column_name)`。
    *   仅适用于拥有详细 `upstreamColumns` 信息的字段（ColumnField）。

**计算字段 (CalculatedField)** 的特殊性在于：
- 它们通常没有 `upstreamColumns`（物理列信息）。
- 对于**独立直连型**嵌入式数据源（如每个 Workbook 都有自己的一份 Excel 直连或 Custom SQL），每个副本都有独立的 `datasource_id`。
- 因此，它们既未命中一级缓存（DS ID 不同），也未命中二级缓存（无物理列）。
- **结果**：每一份嵌入式数据源中的计算字段，即使名称和公式完全一样，也会被当做新字段保存，导致大量重复。

### 2.2 为什么去重会破坏视图关联？

如果我们简单地通过 `(名称, 公式)` 对计算字段进行去重（只保留第一个，跳过后续的），会引发新的问题：

1.  Workbook A (DS A) 有计算字段 `[利润率]` (ID: Calc_A)。
2.  Workbook B (DS B) 有计算字段 `[利润率]` (ID: Calc_B)，公式相同。
3.  去重逻辑保留 `Calc_A`，跳过 `Calc_B`。
4.  在同步视图关联（`sync_field_to_view`）时，API 返回 Workbook B 的视图使用了 `Calc_B`。
5.  但是 `Calc_B` 在数据库中不存在（被跳过）。
6.  现有的"智能重连"逻辑只会去 Workbook B 的数据源 (DS B) 中找同名字段。但 DS B 中并没有被保存的字段（因为被去重了，"真身"在 DS A）。
7.  **结果**：Workbook B 的视图关联丢失，显示"未使用字段"。

## 3. 解决方案

### 3.1 增加三级缓存：计算字段去重

在 `sync_fields` 中增加针对计算字段的去重逻辑：
- **缓存 Key**：`(field_name, formula_hash)`。
- **逻辑**：如果名称和公式完全一致（忽略空格/大小写差异），则视为同一指标，复用已存在的 Field ID。

### 3.2 引入 "ID 重映射机制" (ID Remapping)

为了解决视图关联断裂的问题，需要在 `TableauSynchronizer` 实例中维护一个映射表。

- **机制**：
    1.  在 `sync_fields` 阶段，每当决定**跳过**一个重复字段时，记录映射：
        `deduplication_map[skipped_id] = survivor_id`
    2.  在 `sync_field_to_view` 阶段，当遇到无效的 `field_id` 时，首先检查 `deduplication_map`。
    3.  如果命中映射，直接使用 `survivor_id` 建立关联。

### 3.3 预期效果

- **降低数据量**：计算字段数量预计减少约 20% (931+ 个重复)。
- **统一口径**：相同的指标定义在系统中只有唯一的一个 Field 实体，便于治理。
- **完整血缘**：通过 ID 重映射，确保所有引用了"副本"的视图都能正确指向"真身"，不再出现关联丢失。

## 4. 实施步骤

1.  修改 `TableauSynchronizer.__init__`：初始化 `self.deduplication_map`。
2.  修改 `sync_fields`：
    - 增加计算字段去重逻辑（基于名称+公式）。
    - 在跳过字段（无论是物理列去重还是计算字段去重）时，填充 `self.deduplication_map`。
3.  修改 `sync_field_to_view`：
    - 在查找无效 ID 时，优先查找 `self.deduplication_map`。
