# 元数据系统设计分析报告
> **生成时间**: 2025-12-23 | **验证版本**: v2.5 (修复后重验)

---

## 1. 概要 (Executive Summary)

> [!IMPORTANT]
> **本报告采用去重口径**：字段和指标按 `(name + formula_hash)` 去重，统计的是"逻辑实体"数量而非原始记录数。

| 统计项            | 数值 |
| :---------------- | :--- |
| CSV 验证项总数    | 38   |
| 通过数 (异常数=0) | 21   |
| 问题数 (异常数>0) | 17   |

**关键发现 (去重后)**:
1.  ✅ ~~**API 指标逻辑缺陷**~~: 已修复，`metrics: 0 → 3341`，`duplicate_formulas: 202 → 3375`
2.  🟡 **僵尸计算指标**: 774 个逻辑实体 (去重前 2060 条记录)
3.  🟡 **冗余物理列**: 2769 个逻辑实体 (去重前 13823 条记录)
4.  🟡 **字段-视图血缘中断**: 3916 个逻辑实体 (去重前 17049 条记录)

---

## 2. 问题明细 (Issue Details - CSV Aligned)

### 1. 物理基础设施

#### 1.1 数据库主键ID冲突
*   **SQL 查询结果**: 异常数 `0` ✅
*   **前端布局位置**: 无直接前端展示 (底层数据完整性)
*   **错误信息元素**: N/A

#### 1.2 孤立数据表记录
*   **SQL 查询结果**: 异常数 `0` ✅
*   **前端布局位置**: 数据表列表 (TablesPage)
*   **错误信息元素**: `database_name` 显示为空

#### 1.3 无效的数据库引用
*   **SQL 查询结果**: 异常数 `0` ✅
*   **前端布局位置**: 无直接前端展示
*   **错误信息元素**: N/A

#### 1.4 孤立物理列记录
*   **SQL 查询结果**: 异常数 `0` ✅
*   **前端布局位置**: 无直接前端展示
*   **错误信息元素**: N/A

#### 1.5 无效的数据表引用
*   **SQL 查询结果**: 异常数 `0` ✅
*   **前端布局位置**: 无直接前端展示
*   **错误信息元素**: N/A

---

### 2. 数据源语义层

#### 2.1 数据源名称为空
*   **SQL 查询结果**: 异常数 `0` ✅
*   **API 查询结果**: 返回空数组 ✅
*   **前端布局位置**: 数据源列表 (DatasourcesPage)
*   **错误信息元素**: `name` 字段

#### 2.2 数据源未归属项目
*   **SQL 查询结果**: 异常数 `0` ✅
*   **API 查询结果**: 返回空数组 ✅
*   **前端布局位置**: 数据源列表
*   **错误信息元素**: `project_name` 标签

#### 2.3 空壳数据源(无表)
*   **SQL 查询结果**: 异常数 `0` ✅
*   **前端布局位置**: 数据源详情抽屉
*   **错误信息元素**: "关联物理表" Tab

#### 2.4 空壳数据源(无字段)
*   **SQL 查询结果**: 异常数 `0` ✅
*   **前端布局位置**: 数据源详情抽屉
*   **错误信息元素**: "包含字段" Tab

---

### 3. 消费层

#### 3.1 工作簿未归属项目
*   **SQL 查询结果**: 异常数 `0` ✅
*   **API 查询结果**: 返回空数组 ✅
*   **前端布局位置**: 工作簿列表 (WorkbooksPage)
*   **错误信息元素**: `project_name` 标签

#### 3.2 工作簿缺少负责人
*   **SQL 查询结果**: 异常数 `0` ✅
*   **API 查询结果**: 返回空数组 ✅
*   **前端布局位置**: 工作簿列表 / 详情抽屉
*   **错误信息元素**: `owner` 字段

#### 3.3 工作簿名称为空
*   **SQL 查询结果**: 异常数 `0` ✅
*   **前端布局位置**: 工作簿列表
*   **错误信息元素**: `name` 字段

#### 3.4 孤立视图记录
*   **SQL 查询结果**: 异常数 `0` ✅
*   **API 查询结果**: 返回空数组 ✅
*   **前端布局位置**: 视图列表 (ViewsPage)
*   **错误信息元素**: `workbook_name` 字段

#### 3.5 无效的工作簿引用
*   **SQL 查询结果**: 异常数 `0` ✅
*   **前端布局位置**: 无直接前端展示
*   **错误信息元素**: N/A

#### 3.6 仪表板内容缺失
*   **SQL 查询结果**: 异常数 `57` ⚠️
*   **前端布局位置**: 视图列表 (ViewsPage) / 视图详情抽屉
*   **错误信息元素**: `view_type='dashboard'` 但 `containedSheetCount=0`
*   **缺失内容详解**:
    *   **缺失的关系**: `views` 表中 `view_type='dashboard'` 的记录，在 `dashboard_to_sheet` 关联表中找不到对应的 `sheet_id` 引用。
    *   **缺失的字段**: `dashboard_to_sheet.sheet_id` (应指向被包含的 worksheet 视图 ID)
    *   **业务影响**: 前端详情抽屉中"包含的工作表"列表为空，无法进行血缘穿透分析。
    *   **根因推测**: Tableau Metadata API 的 `containedSheets` 属性未被正确解析。
*   **详细记录 (前5条)**:
    | ID                                     | 名称       | 所属工作簿          |
    | :------------------------------------- | :--------- | :------------------ |
    | `0ec2a4f0-c540-5ad6-417d-4892252936bd` | 航段分布   | ZY经营数据分析-同比 |
    | `6dab3f84-3d6a-7463-e7f6-2126b573b1ab` | 看板汇总   | 致远-预算分解       |
    | `1e48d671-317c-4992-bdaf-c4d8aadd888c` | 2.1定位    | OAG数据分析汇报     |
    | `26dcca6a-7968-90bb-b69a-14dd7cc6a557` | 目录       | OAG数据分析汇报     |
    | `2965f754-79d8-9bb3-7244-e4a611dd9c77` | 挑战与机遇 | OAG数据分析汇报     |

---

### 4. 字段与指标逻辑

#### 4.1 幽灵字段(悬空)
*   **SQL 查询结果**: 异常数 `0` (定义为 ds_id AND wb_id 均为空) ✅
*   **前端布局位置**: 侧边栏统计 (AppLayout)
*   **错误信息元素**: `stats.orphanedFields`

#### 4.2 计算公式丢失
*   **SQL 查询结果**: 异常数 `2` ⚠️
*   **前端布局位置**: 字段详情抽屉 (DetailDrawer)
*   **错误信息元素**: `formula` 字段显示为空
*   **缺失内容详解**:
    *   **缺失的字段**: `fields.formula` 为 NULL 或空字符串，但 `is_calculated=1`。
    *   **业务影响**: 前端详情抽屉中"计算公式"区域显示为空白。

#### 4.3 度量数据类型缺失
*   **SQL 查询结果**: 异常数 `0` ✅
*   **前端布局位置**: 字段列表 (FieldsPage)
*   **错误信息元素**: `data_type` 字段

#### 4.4 计算字段角色未定义
*   **SQL 查询结果**: 异常数 `0` ✅
*   **前端布局位置**: 字段列表
*   **错误信息元素**: `role` 字段

---

### 6. 血缘全链路

#### 6.1 物理-语义血缘中断
*   **SQL 查询结果**: 异常数 `8` ⚠️
*   **前端布局位置**: 数据表列表 (TablesPage)
*   **错误信息元素**: `datasource_count = 0` 的表
*   **缺失内容详解**:
    *   **缺失的关系**: `table_to_datasource` 关联表中，这 8 个物理表无 `datasource_id` 记录。
    *   **业务影响**: 血缘图中孤立节点，无法向上追溯。

#### 6.2 语义-消费血缘中断
*   **SQL 查询结果**: 异常数 `30` ⚠️
*   **前端布局位置**: 数据源列表 (DatasourcesPage)
*   **错误信息元素**: `workbook_count = 0` 的数据源
*   **详细记录 (前5条)**:
    | 数据源名                      | 项目         |
    | :---------------------------- | :----------- |
    | DDS-OD数据                    | 数据处理流程 |
    | DDS-O&D_2024后续删除          | 默认值       |
    | 输出_test                     | Tableau 示例 |
    | 中转航段数据补充票价数据-去重 | 数据沙盒     |
    | 经营分析复盘-本地数据         | 数据沙盒     |

#### 6.3 字段-视图血缘中断 (去重后)
*   **SQL 查询结果**: 异常数 `3916` 个逻辑实体 ⚠️
*   **原始记录数**: 17049 条 (去重后降低 77%)
*   **前端布局位置**: 字段列表 / 侧边栏
*   **错误信息元素**: `usage_count = 0` 的字段
*   **缺失内容详解**:
    *   **缺失的关系**: `field_to_view` 关联表中，这些字段的 `field_id` 没有对应的 `view_id` 记录。
    *   **业务影响**: 字段虽被定义，但从未被任何视图使用，属于"僵尸字段"。

---

### 7. 治理合理性

#### 7.1 僵尸计算指标 (去重后)
*   **SQL 查询结果**: 异常数 `774` 个逻辑实体 ⚠️
*   **原始记录数**: 2060 条 (去重后降低 62%)
*   **API 查询结果**: `stats.metrics: 3341` ✅ **已修复**
*   **前端布局位置**: 侧边栏统计 / 指标库页面 (MetricsPage)
*   **错误信息元素**: `stats.metrics`
*   **修复说明**: role 大小写问题已修复，`role='measure'` → `role='MEASURE'`
*   **详细记录 (前5条)**:
    | 指标名         | formula_hash        | 数据源          |
    | :------------- | :------------------ | :-------------- |
    | 客公里-投影    | 1f8149e19e58bacb... | 航班信息表-中科 |
    | //缺口程数量   | a5096d559a066c91... | 销售航段        |
    | //缺失首段数量 | e2ffb1a170ec00db... | 销售航段        |
    | 1-Destination  | bfc91a8bcb14f308... | (空)            |
    | 1-Origin       | 0508f460ae3f5aaa... | (空)            |

#### 7.2 僵尸计算维度 (去重后)
*   **SQL 查询结果**: 异常数 `374` 个逻辑实体 ⚠️
*   **原始记录数**: 1166 条 (去重后降低 68%)
*   **前端布局位置**: 字段列表
*   **错误信息元素**: 未被引用的 Dimension 类型字段

#### 7.3 冗余物理列 (去重后)
*   **SQL 查询结果**: 异常数 `2769` 个逻辑实体 ⚠️
*   **原始记录数**: 13823 条 (去重后降低 80%)
*   **前端布局位置**: 字段列表
*   **错误信息元素**: `is_calculated=0` 且 `usage_count=0`
*   **缺失内容详解**:
    *   **缺失的价值**: 物理列虽存在于数据源中，但从未被使用。
    *   **业务影响**: 增加数据提取开销，无分析价值。

#### 7.4 僵尸数据源
*   **SQL 查询结果**: 异常数 `30` ⚠️
*   **前端布局位置**: 数据源列表
*   **错误信息元素**: `workbook_count = 0`
*   **详细记录**: (同 6.2 语义-消费血缘中断)

#### 7.5 逻辑重复定义
*   **SQL 查询结果**: 异常数 `3375` 组 ⚠️
*   **API 查询结果**: `issues.duplicate_formulas: 3375` ✅ **已修复**
*   **前端布局位置**: Overview 仪表板 / 指标库重复分析 Tab
*   **错误信息元素**: `issues.duplicate_formulas`
*   **修复说明**: 移除 LIMIT 10 截断，改为全量统计。
*   **详细记录 (前5条)**:
    | 重复公式                                               | 出现次数 |
    | :----------------------------------------------------- | :------- |
    | `INDEX()`                                              | 45       |
    | `COUNTD([TICKETNUMBER])`                               | 27       |
    | `SUM[分摊票价])/[销售航段张数]`                        | 26       |
    | `IF [出港-区域]="国内" AND [进港-区域]="国内" THEN...` | 20       |
    | `WINDOW_MEDIAN([平均票价-航段含油])`                   | 17       |

#### 7.6 字段名歧义冲突
*   **SQL 查询结果**: 异常数 `179` 组 ⚠️
*   **前端布局位置**: 指标库页面
*   **错误信息元素**: 同名但公式不同的字段组
*   **缺失内容详解**:
    *   **冲突的数据**: 179 组字段名相同但 `formula` 不同。
    *   **业务影响**: **极高风险**。用户看到同名字段，实际计算逻辑不同。
*   **详细记录 (前5条)**:
    | 冲突名称 | 不同公式数 |
    | :------- | :--------- |
    | 平均票价 | 9          |
    | 计算 1   | 8          |
    | 班次     | 8          |
    | 产品     | 8          |
    | 计算 2   | 7          |

#### 7.7 空容器工作簿
*   **SQL 查询结果**: 异常数 `0` ✅
*   **前端布局位置**: 工作簿列表
*   **错误信息元素**: `view_count = 0`

#### 7.8 空容器仪表板
*   **SQL 查询结果**: 异常数 `57` ⚠️
*   **前端布局位置**: 视图列表
*   **错误信息元素**: `containedSheetCount = 0`
*   **详细记录**: (同 3.6 仪表板内容缺失)

#### 7.9 非认证数据源
*   **SQL 查询结果**: 异常数 `55` ⚠️
*   **API 查询结果**: `quality_metrics.datasource_coverage.certified: 0`
*   **前端布局位置**: 数据源列表
*   **错误信息元素**: `is_certified` 标签
*   **缺失内容详解**:
    *   **缺失的认证**: 所有 55 个发布数据源的 `is_certified` 均为 0。
    *   **业务影响**: 用户无法通过"官方认证"筛选可信数据源。

#### 7.10 资产描述缺失
*   **SQL 查询结果**: 异常数 `20265` ⚠️
*   **API 查询结果**: `issues.missing_description: 15177` 🟡 口径差异
*   **前端布局位置**: 详情抽屉 (所有资产)
*   **错误信息元素**: `description` 字段显示为空
*   **缺失内容详解**:
    *   **缺失的字段**: `description` 为 NULL 或空。
    *   **缺失的数据**: 业务含义、计算口径、数据来源等。
    *   **口径差异说明**: SQL 统计了 `tables` + 全量 `fields`；API 仅统计 `is_calculated=0` 的物理字段。

#### 7.11 低价值重命名
*   **SQL 查询结果**: 异常数 `5057` ⚠️
*   **API 查询结果**: `complexity_distribution.low: 5057` ✅
*   **前端布局位置**: 指标库复杂度分析
*   **错误信息元素**: `complexity_score <= 1`

#### 7.12 无主资产
*   **SQL 查询结果**: 异常数 `0` ✅
*   **前端布局位置**: 工作簿列表
*   **错误信息元素**: `owner` 字段

---

### 8. 统计准确性

#### 8.1 全局计数不一致
*   **API 查询结果**: `stats.metrics: 3341` ✅ **已修复**
*   **前端布局位置**: 侧边栏统计 (AppLayout)
*   **错误信息元素**: `stats.metrics`

#### 8.2 字段来源归类错误
*   **API 查询结果**: `field_source_distribution: {...}`
*   **前端布局位置**: Overview 仪表板
*   **错误信息元素**: 字段来源饼图

#### 8.3 质量分计算偏差
*   **API 查询结果**: `quality_metrics.*`
*   **前端布局位置**: Overview 仪表板
*   **错误信息元素**: 健康度评分

#### 8.4 治理看板计数偏差
*   **API 查询结果**: `issues.duplicate_formulas: 3375` ✅ **已修复**
*   **前端布局位置**: Overview 仪表板
*   **错误信息元素**: `issues.duplicate_formulas`

---

## 3. 总结与建议 (Conclusion & Recommendations)

### 致命缺陷 (已修复 ✅)
1.  ~~**API 大小写敏感问题**~~: 已修复，`role = 'measure'` → `role = 'MEASURE'`。
2.  ~~**重复公式统计截断**~~: 已修复，移除 `LIMIT 10` 并使用全量 COUNT。
3.  ~~**复杂度阈值不一致**~~: 已修复，统一为 `<= 1`。

### 高优先级治理 (待处理)
1.  清理 774 个僵尸计算指标 (去重后)。
2.  合并 3375 组重复公式，建立公共计算字段库。
3.  补充核心资产的业务描述 (20265 条缺失)。
4.  修复 57 个仪表板的 Sheet 关联关系。

---
> 报告生成规范详见: [claude.md](./claude.md)
