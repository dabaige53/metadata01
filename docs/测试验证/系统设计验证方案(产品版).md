# Tableau 元数据治理平台 - 系统设计验证方案 (产品版)

**发布版本**: v2.0
**最后更新**: 2025-12-23
**适用对象**: 产品经理 (PM)、QA、系统设计人员

---

## 1. 方案概述

### 1.1 验证目标
本方案旨在验证元数据治理平台的**系统设计完整性**，确保系统采集的元数据能够准确反映 Tableau 的真实状态，不存在因系统设计缺陷导致的数据丢失、断链或错误关联。

### 1.2 核心价值
通过执行本方案，我们希望达成以下结果：
- **准确性**: 确保每一个展示在前端的数字（如字段数、引用数）都是真实可靠的。
- **完整性**: 确保从物理表到仪表板的**从头到尾**的血缘链路是连通的。
- **一致性**: 确保前后端统计数据一致，消除"数据打架"现象。

### 1.3 验证范围 (系统设计 vs 数据治理)
> [!NOTE]
> 本方案仅关注**系统层面的设计缺陷**（如：字段没有保存归属关系）。
> **不包含**业务层面的数据治理问题（如：字段被创建了但没人用）。后者属于"治理分析"功能，而非"系统系统验证"。

---

## 2. 模块化验证方案详情

我们按照产品前端的**功能模块**来组织测试内容，方便对照验证。

### 2.1 基础设施层 (物理数据库/表)
**页面**: 侧边栏统计、数据库列表、数据表列表

| 测试内容              | 为什么要测试?                                                                                    | 预期结果         | 如何测试                            |
| :-------------------- | :----------------------------------------------------------------------------------------------- | :--------------- | :---------------------------------- |
| **1. 数据库主键冲突** | 确保系统不会把两个不同的数据库混为一谈。                                                         | **0** 个冲突     | SQL 检查 `databases` 表 ID 唯一性。 |
| **2. 孤立数据表/列**  | 所有的表都必须属于某个数据库，所有的列都必须属于某个表。如果有"孤儿"，说明采集逻辑漏了父级信息。 | **0** 个孤立记录 | SQL 检查 `database_id` 为空的表。   |
| **3. 外键死链**       | 表记录了它属于"数据库A"，但系统里根本没有"数据库A"。这会导致点击跳转报错。                       | **0** 个死链     | SQL 检查外键有效性。                |

### 2.2 语义层 (数据源)
**页面**: 数据源列表 (Datasources)

| 测试内容                | 为什么要测试?                                                                                                               | 预期结果            | 如何测试                                    |
| :---------------------- | :-------------------------------------------------------------------------------------------------------------------------- | :------------------ | :------------------------------------------ |
| **4. 数据源名称缺失**   | 用户无法识别没有名字的数据源。                                                                                              | **0** 个无名数据源  | API 检查 `name` 为空的记录。                |
| **5. 数据源归属缺失**   | 已发布数据源必须属于某个项目，否则权限和位置不明。                                                                          | **0** 个无项目DS    | API 检查 `project_name` 缺失。              |
| **6. 空壳数据源(无表)** | **[修正]** 仅验证**已发布数据源**。如果发布源无关联表，通常是不规范的。嵌入式源因使用 Custom SQL 可能解析不出表，属于正常。 | **0** 个异常发布源  | SQL 检查 `is_embedded=0` 且无关联表的记录。 |
| **7. 孤儿字段引用**     | **[高频问题]** 计算字段引用了"影子代理ID"，导致显示"Unknown"。                                                              | **0** 个Unknown引用 | 查看计算字段详情页的来源数据源。            |

> [!TIP]
> **关于"代理ID"机制**: 当工作簿连接已发布数据源时，内部会生成一个"影子代理ID"。系统必须能够正确处理这个代理ID，或者在展示时说明其指向的真实源头，否则会被误判为"孤儿"。

### 2.3 消费层 (工作簿/视图)
**页面**: 工作簿列表、视图列表

| 测试内容               | 为什么要测试?                                                              | 预期结果            | 如何测试                             |
| :--------------------- | :------------------------------------------------------------------------- | :------------------ | :----------------------------------- |
| **8. 工作簿归属缺失**  | 工作簿必须属于项目和负责人，否则是无主资产。                               | **0** 个缺失        | API 检查 `project/owner` 字段。      |
| **9. 孤立视图记录**    | 每个 View (Sheet/Dashboard) 都必须属于一个工作簿。                         | **0** 个孤立视图    | SQL 检查 `workbook_id` 为空的视图。  |
| **10. 仪表板内容缺失** | 一个 Dashboard 如果不包含任何 Sheet，可能是解析失败或损坏。                | **0** 个空Dashboard | 查看 Dashboard 详情页的 Sheet 列表。 |
| **11. 工作簿无数据源** | 工作簿通常应连接数据源。虽然**静态工作簿**允许无数据源，但大量出现需警惕。 | 少量或0             | 检查无关联数据源的工作簿。           |

### 2.4 字段逻辑层 (字段/指标)
**页面**: 指标库 (Metrics)、字段列表

#### 2.4.1 核心设计原则 (Tableau 理念对齐)
> [!IMPORTANT]
> 本系统的字段模型严格遵循以下 Tableau 设计原则，验证时请务必对齐：
> 1.  **原始字段 (Column/Field)**: **一定属于**一个数据源 (Datasource)。它可以被多个工作簿引用，但其物理根基在数据源中。
> 2.  **计算字段 (Calculated Field)**: **一定属于**一个工作簿 (Workbook)。它是由工作簿内创建的逻辑（即使跨源），因此必须有工作簿归属。
> 3.  **指标 (Metric)**: **产品定义的逻辑聚合**。
>     *   Tableau 无跨工作簿指标概念，但本系统通过 **"同公式聚合"** 策略，将分散在不同工作簿中、同名且同公式的计算字段聚合为一个"指标"。
>     *   **点击指标卡片时**: 展示该指标涉及的所有 **工作簿 (来源)**、引用的 **数据源** 及 **原始字段**。

#### 2.4.2 验证指标清单

| 测试内容                 | 为什么要测试?                                                                                        | 预期结果         | 如何测试                                               |
| :----------------------- | :--------------------------------------------------------------------------------------------------- | :--------------- | :----------------------------------------------------- |
| **12. 原始字段归属缺失** | **[修正]** 原始字段 (`is_calculated=0`) **一定属于**一个数据源，它是数据的源头。                     | **0** 个异常     | SQL 检查 `is_calculated=0 AND datasource_id IS NULL`。 |
| **13. 计算字段归属缺失** | **[修正]** 计算字段 (`is_calculated=1`) **一定属于**一个工作簿，因为它是在工作簿内创建的(即使跨源)。 | **0** 个异常     | SQL 检查 `is_calculated=1 AND workbook_id IS NULL`。   |
| **14. 计算公式丢失**     | 既然标记为"计算字段"，就必须有公式。没公式就是系统没采集成。                                         | **0** 个丢失公式 | API 检查 `formula` 字段。                              |
| **15. 度量类型缺失**     | 度量字段必须有数据类型(Number等)，否则前端无法聚合。                                                 | **0** 个缺失类型 | API 检查 `data_type`。                                 |

> [!NOTE]
> **关于指标 (Metric) 的聚合逻辑**:
> 在本产品中，**"指标"** 是对 **计算字段** 的逻辑聚合。
> - **聚合规则**: 不同工作簿中创建的、具有 **"同名 + 同公式"** (忽略空格/大小写) 的计算字段，会被视为同一个"指标"。
> - **详情展示**: 点击指标卡片时，系统会聚合展示所有包含该计算字段的 **工作簿** (来源) 和它们引用的 **数据源**。
> - **验证重点**: 验证计算字段是否正确记录了 `workbook_id` 和 `formula`，这是实现聚合的基础。

### 2.5 全链路血缘 (Lineage)
**页面**: 详情抽屉 (DetailDrawer) 的"血缘/引用" Tab

| 测试内容                   | 为什么要测试?                                                                                                                                                         | 预期结果     | 如何测试                            |
| :------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------- | :---------------------------------- |
| **16. 物理-语义断裂**      | 物理表存在，但没被任何数据源引用。这可能是因为同步脚本没解析 `table_to_datasource`。                                                                                  | 关注异常高值 | SQL 检查断链数量。                  |
| **17. 字段-视图断裂**      | 字段存在，但没被任何视图使用。虽可能是"未使用的字段"，但从系统角度看，需确认关联表是否正常填充。                                                                      | 关注异常高值 | 检查 `field_to_view` 表。           |
| **18. 计算字段物理表血缘** | ⚠️ **设计特性**: 计算字段 (`is_calculated=1`) **没有直接的 `table_id`**，因为它是公式定义而非物理列。物理表血缘需通过 **公式依赖 → 原始字段 → 数据源 → 表** 间接穿透。 | ⚠️ 预期为空   | 查看详情页"依赖字段"Tab，间接追溯。 |

> [!NOTE]
> **v2.1 新增: `field_full_lineage` 预计算血缘表**
> 系统在同步阶段预计算每个字段的完整血缘链，存储于 `field_full_lineage` 表。验证时应确保：
> 1.  所有计算字段都能通过该表间接关联到物理表
> 2.  `lineage_type` 正确标记为 `direct` (原始字段) 或 `indirect` (计算字段穿透)

| 测试内容                 | 为什么要测试?                                    | 预期结果                                      | 如何测试                                                                       |
| :----------------------- | :----------------------------------------------- | :-------------------------------------------- | :----------------------------------------------------------------------------- |
| **19. 预计算血缘覆盖率** | 验证 `field_full_lineage` 表是否完整覆盖所有字段 | 100% 覆盖                                     | `SELECT COUNT(DISTINCT field_id) FROM field_full_lineage` 应等于 `fields` 总数 |
| **20. 计算字段间接血缘** | 计算字段应能通过预计算表关联到物理表             | 所有计算字段有 `lineage_type='indirect'` 记录 | SQL 检查                                                                       |

### 2.6 统计准确性验证 (详细对照表)

我们需要确保**页面上的每一个数字**都有据可查，且与数据库完全一致。

#### 2.6.1 核心指标卡片 (Statistics Cards)
**验证位置**: 各个列表页顶部的统计卡片。

| 模块           | 卡片名称            | 验证逻辑 (预期一致性)                       | SQL 验证示例                                                                                             |
| :------------- | :------------------ | :------------------------------------------ | :------------------------------------------------------------------------------------------------------- |
| **Database**   | **已认证数据库**    | `verified_count` = `is_certified=1`         | `SELECT COUNT(*) FROM databases WHERE is_certified=1`                                                    |
| **Table**      | **孤立数据表**      | `orphan_count` = `database_id IS NULL`      | `SELECT COUNT(*) FROM tables WHERE database_id IS NULL`                                                  |
| **Datasource** | **有警告数据源**    | `warning_count` = `has_active_warning=1`    | `SELECT COUNT(*) FROM datasources WHERE has_active_warning=1`                                            |
| **Datasource** | **含提取(Extract)** | `extract_count` = `has_extract=1`           | `SELECT COUNT(*) FROM datasources WHERE has_extract=1`                                                   |
| **Workbook**   | **无项目归属**      | `no_project_count` = `project_name IS NULL` | `SELECT COUNT(*) FROM workbooks WHERE project_name IS NULL`                                              |
| **Field**      | **未使用字段**      | `unused_count` = `usage_count=0`            | `SELECT COUNT(*) FROM fields f WHERE NOT EXISTS (SELECT 1 FROM field_to_view fv WHERE fv.field_id=f.id)` |

#### 2.6.2 右侧详情侧边栏 (Detail Drawer & Lineage)
**验证位置**: 点击列表项后弹出的右侧抽屉 -> 顶部 Tab 的数字徽标。

| 实体                  | Tab 名称       | 计数逻辑                             | 验证重点                                                              |
| :-------------------- | :------------- | :----------------------------------- | :-------------------------------------------------------------------- |
| **Database**          | **包含数据表** | 该 DB 下的 Table 总数                | `SELECT COUNT(*) FROM tables WHERE database_id = ?`                   |
| **Table**             | **关联数据源** | 引用该表的 Datasource 数             | `SELECT COUNT(*) FROM table_to_datasource WHERE table_id = ?`         |
| **Datasource**        | **关联工作簿** | 连接该 DS 的 Workbook 数             | `SELECT COUNT(*) FROM datasource_to_workbook WHERE datasource_id = ?` |
| **Datasource**        | **包含字段**   | 归属该 DS 的 Field 总数              | `SELECT COUNT(*) FROM fields WHERE datasource_id = ?`                 |
| **Workbook**          | **包含视图**   | 该 WB 下的 View (Sheet+Dashboard) 数 | `SELECT COUNT(*) FROM views WHERE workbook_id = ?`                    |
| **Workbook**          | **嵌入字段**   | 归属该 WB 的嵌入式 Field 数          | `SELECT COUNT(*) FROM fields WHERE workbook_id = ?`                   |
| **Field**             | **视图引用**   | 使用了该字段的 View 数               | `SELECT COUNT(*) FROM field_to_view WHERE field_id = ?`               |
| **Metric (计算字段)** | **依赖字段**   | 公式中引用的原始字段数               | 需解析公式或查看 `upstream_fields` 关联表                             |

#### 2.6.3 列表总数 (Pagination Total)
**验证位置**: 列表底部的分页条 "Total X items"。

| 验证项         | 预期结果                                                                                                |
| :------------- | :------------------------------------------------------------------------------------------------------ |
| **全局总数**   | API `/api/{entity}` 返回的 `total` 必须等于 `SELECT COUNT(*) FROM {entity}`                             |
| **筛选后总数** | API 带参数 `/api/fields?is_calculated=1` 返回的总数必须等于 `SELECT COUNT(*) ... WHERE is_calculated=1` |

#### 2.6.4 详情页数据完整性 (Detail Completeness)
**验证位置**: 点击任意数据源、数据表，检查"包含字段/指标"列表。

| 验证项           | 预期结果                                          | 如何测试                                                                     |
| :--------------- | :------------------------------------------------ | :--------------------------------------------------------------------------- |
| **无硬编码截断** | 列表长度应等于`Total`计数，不能锁定在 100 或 50。 | 找一个字段数 > 100 的数据源，查看"包含字段"Tab里的数字是否等于卡片上的总数。 |


### 2.7 关键指标计算逻辑详解 (引用数算法)

前端展示的各种"热度"和"引用数"指标，其底层计算逻辑如下，测试时请严格按此公式核对：

#### 2.7.1 字段引用数 (Field Usage Score)
*   **定义**: 一个字段被多少个视图 (Sheet/Dashboard) 所使用。
*   **计算方式**: 直接 count `field_to_view` 关联表。
*   **数据来源**: 实时查询或预计算字段 `usage_count`。
*   **SQL公式**:
    ```sql
    SELECT count(*) FROM field_to_view WHERE field_id = '{field_id}'
    ```
*   **注意**: 如果字段A被计算字段B引用，而B被视图使用，目前系统**仅统计直接引用**（视图直接使用了A），间接引用暂未计入（除非实现了递归解析）。

#### 2.7.2 数据源引用数 (Datasource Connected Workbooks)
*   **定义**: 多少个工作簿连接了这个数据源。
*   **计算方式**: `datasource_to_workbook` 关联表。
*   **数据来源**: `Datasource.workbook_count` 预计算字段。
*   **SQL公式**:
    ```sql
    SELECT count(*) FROM datasource_to_workbook WHERE datasource_id = '{ds_id}'
    ```

#### 2.7.3 数据表引用数 (Table Downstream Impact)
*   **定义**: 多少个数据源使用了这张表。
*   **计算方式**: `table_to_datasource` 关联表。
*   **SQL公式**:
    ```sql
    SELECT count(*) FROM table_to_datasource WHERE table_id = '{table_id}'
    ```

#### 2.7.4 工作簿热度 (Workbook Views)
*   **定义**: 工作簿被用户查看的总次数 (All Time)。
*   **数据来源**: 直接从 Tableau Server 同步的 `total_view_count` 字段，不做累加计算。
*   **验证方式**: 对比 Tableau Server 界面上的数字。

#### 2.7.5 视图引用 (View Fields Count)
*   **定义**: 一个视图里使用了多少个字段。
*   **计算方式**: Count `field_to_view`。
*   **SQL公式**:
    ```sql
    SELECT count(*) FROM field_to_view WHERE view_id = '{view_id}'
    ```

---

## 3. 详情页专项验证 (Detail Page Verification)

本章节针对前台点击资产名称后弹出的 **右侧抽屉 (Detail Drawer)** 进行全量验证。
**通用验证原则**:
1.  **徽标归位**: 列表 Tab 上的数字 (如 `包含字段 (150)`) 必须与 API 返回的 `total` 一致。
2.  **数表一致**: 列表实际渲染的行数必须等于徽标数字 (检查是否存在 `LIMIT 100` 等截断问题)。
3.  **零值隐藏**: 如果某项数据为 0 (如无表、无视图)，对应 Tab 应自动隐藏。

### 3.1 Database (数据库) 详情
验证进入任意 Database 详情页：

| Tab 名称   | 显示条件     | 验证内容   | 预期结果                               |
| :--------- | :----------- | :--------- | :------------------------------------- |
| **数据表** | `tables > 0` | 列表完整性 | 列表行数 == 徽标计数。点击表名能跳转。 |

### 3.2 Table (数据表) 详情
验证进入任意 Table 详情页：

| Tab 名称       | 显示条件          | 验证内容      | 预期结果                                                  |
| :------------- | :---------------- | :------------ | :-------------------------------------------------------- |
| **所属数据库** | 始终显示          | 归属关系      | 正确显示 DB 名称，点击可跳转。                            |
| **原始列**     | `columns > 0`     | 物理结构      | 显示列名、类型、主键标识。                                |
| **包含字段**   | `fields > 0`      | Tableau层映射 | 显示被引用的 Field，包含维度和度量。                      |
| **关联数据源** | `datasources > 0` | 语义层引用    | 显示该表被哪些数据源引用。                                |
| **关联工作簿** | `workbooks > 0`   | 消费层引用    | 包含**直连**(Embedded)和**间接**(Published)两种关联方式。 |

### 3.3 Datasource (数据源) 详情
验证进入任意 Datasource 详情页：

| Tab 名称       | 显示条件        | 验证内容 | 预期结果                                           |
| :------------- | :-------------- | :------- | :------------------------------------------------- |
| **原始表**     | `tables > 0`    | 物理来源 | 列出所有关联的物理表 (Schema + Table)。            |
| **包含字段**   | `fields > 0`    | 语义定义 | **重点验证**: 列表长度是否被截断？应显示全部字段。 |
| **包含指标**   | `metrics > 0`   | 核心指标 | 显示该数据源下的计算字段(Metric)。                 |
| **关联工作簿** | `workbooks > 0` | 下游影响 | 显示连接此数据源的所有工作簿。                     |

### 3.4 Workbook (工作簿) 详情
验证进入任意 Workbook 详情页：

| Tab 名称       | 显示条件           | 验证内容 | 预期结果                          |
| :------------- | :----------------- | :------- | :-------------------------------- |
| **视图/看板**  | `views > 0`        | 内容构成 | 列出所有 Sheet 和 Dashboard。     |
| **使用数据源** | `datasources > 0`  | 上游依赖 | 列出已发布数据源。                |
| **关联数据表** | `tables > 0`       | 物理穿透 | 穿透显示底层依赖的所有物理表。    |
| **使用字段**   | `used_fields > 0`  | 字段清单 | 列出视图中实际使用的字段 (去重)。 |
| **使用指标**   | `used_metrics > 0` | 指标清单 | 列出视图中实际使用的指标 (去重)。 |
| **访问统计**   | 始终显示           | 热度趋势 | 图表显示近30天访问量。            |

### 3.5 View (视图/工作表) 详情
验证进入任意 View 详情页：

| Tab 名称       | 显示条件           | 验证内容 | 预期结果                                   |
| :------------- | :----------------- | :------- | :----------------------------------------- |
| **所属工作簿** | 始终显示           | 归属关系 | 显示父级 Workbook。                        |
| **使用字段**   | `used_fields > 0`  | 字段依赖 | 仅显示当前 Sheet/Dashboard 用到的字段。    |
| **使用指标**   | `used_metrics > 0` | 指标依赖 | 仅显示当前 Sheet/Dashboard 用到的指标。    |
| **包含视图**   | Dashboard          | 内部结构 | 仅仪表板显示此 Tab，列出内部包含的 Sheet。 |

### 3.6 Field/Metric (字段/指标) 详情
验证进入任意 Field 或 Metric 详情页：

| Tab 名称       | 显示条件    | 验证内容 | 预期结果                                |
| :------------- | :---------- | :------- | :-------------------------------------- |
| **所属数据表** | 物理字段    | 来源追溯 | 物理字段显示所属 Table。                |
| **所属数据源** | 始终显示    | 来源追溯 | 必须显示所属 Datasource (或 Workbook)。 |
| **依赖字段**   | 计算字段    | 公式解析 | 列出公式引用的上游字段。                |
| **影响指标**   | 普通字段    | 下游影响 | 列出引用了该字段的计算指标。            |
| **关联视图**   | `views > 0` | 使用情况 | 列出使用了该字段的所有视图。            |
| **引用工作簿** | `wbs > 0`   | 使用情况 | 列出使用了该字段的所有工作簿。          |

---

## 4. 执行策略


### 4.1 自动化验证脚本
我们提供了一键执行脚本，开发和 QA 可随时运行：
- **API 验证**: `./docs/测试验证/系统设计验证API.sh` (模拟前端请求)
- **数据库验证**: `sqlite3 metadata.db < docs/测试验证/系统设计验证.sql` (底层数据核查)

### 4.2 验收标准
1.  **致命问题 (Blocker)**: 字段无归属、主键冲突、前后端计数不一致。 **必须清零**。
2.  **严重问题 (Critical)**: 孤儿引用、死链、核心属性(Name/Project)丢失。 **必须修复**。
3.  **一般问题 (Major)**: 孤立记录、断链。 **需排查是否为 Tableau 正常特性** (如静态工作簿)。

---

## 5. 特殊情况说明 (Tableau 特性)

以下现象可能是 **Tableau 的正常设计**，不一定代表系统错误，测试时请留意：

*   **字段无视图引用**: 仅仅是因为用户创建了字段但没拖进报表，属于正常"数据治理"问题，非系统Bug。
*   **Sheet 无 Dashboard 归属**: Sheet 可以独立发布，不一定非要放在 Dashboard 里。
*   **跨数据源字段重复**: 用户经常复制粘贴字段，导致同名同公式字段在多个数据源出现，系统只负责如实记录。
*   **工作簿无已发布数据源**: 工作簿可能只使用了内嵌Excel文件，没有连接 Server 上的共享数据源。

---
**编写**: 系统架构师
**审核**: 产品经理
