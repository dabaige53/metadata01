# ç³»ç»Ÿè®¾è®¡éªŒè¯æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2025-12-23 16:45:00  
**éªŒè¯ç‰ˆæœ¬**: v2.1 (ä¸“æ³¨ç³»ç»Ÿé—®é¢˜)

---

## 1. éªŒè¯èŒƒå›´è¯´æ˜

> æœ¬æŠ¥å‘Š**ä»…å…³æ³¨ç³»ç»Ÿè®¾è®¡é—®é¢˜**ï¼ˆä»£ç /åŒæ­¥é€»è¾‘ç¼ºé™·ï¼‰ï¼Œä¸åŒ…å«æ•°æ®æ²»ç†é—®é¢˜ï¼ˆå¦‚èµ„äº§æè¿°ç¼ºå¤±ã€åƒµå°¸èµ„äº§ç­‰ï¼‰ã€‚

---

## 2. ç³»ç»Ÿé—®é¢˜æ£€æµ‹ç»“æœ

### 2.1 è¡€ç¼˜å®Œæ•´æ€§ç¼ºé™·

| éªŒè¯å†…å®¹               | SQLç»“æœ   | å½±å“èŒƒå›´            | çŠ¶æ€   |
| :--------------------- | :-------- | :------------------ | :----- |
| è®¡ç®—å­—æ®µå­¤å„¿æ•°æ®æºå¼•ç”¨ | **1,303** | æŒ‡æ ‡è¯¦æƒ…-æ‰€å±æ•°æ®æº | ğŸ”´ é—®é¢˜ |
| å­¤å„¿æ•°æ®æºIDæ•°é‡       | **38**    | åç«¯æ•°æ®å…³è”        | ğŸ”´ é—®é¢˜ |
| è®¡ç®—å­—æ®µç‰©ç†è¡¨è¡€ç¼˜ç¼ºå¤± | **5,057** | æŒ‡æ ‡è¯¦æƒ…-æ‰€å±æ•°æ®è¡¨ | ğŸ”´ é—®é¢˜ |
| è®¡ç®—å­—æ®µç‰©ç†è¡¨å…³è”ç‡   | **0.0%**  | è¡€ç¼˜è¿½æº¯èƒ½åŠ›        | ğŸ”´ é—®é¢˜ |

### 2.2 é—®é¢˜æ ¹å› åˆ†æ

#### é—®é¢˜#1: å­¤å„¿æ•°æ®æºå¼•ç”¨

- **ç°è±¡**: æŒ‡æ ‡è¯¦æƒ…æŠ½å±‰"æ‰€å±æ•°æ®æº"æ˜¾ç¤º "Unknown"
- **æ ¹å› **: åµŒå…¥å¼æ•°æ®æº (Embedded Datasources) æœªåŒæ­¥åˆ° `datasources` è¡¨
- **Top 5 å­¤å„¿æ•°æ®æºID**:
  | å­¤å„¿æ•°æ®æºID                         | å¼•ç”¨å­—æ®µæ•° |
  | :----------------------------------- | :--------- |
  | 8f892a27-bcb8-5f3f-9c25-05b8ca58456a | 129        |
  | a6553fb7-5acc-1099-26ac-493a171bc4fa | 109        |
  | 0222e5a6-c7f4-da9d-aa44-d1b118ca90cc | 99         |
  | 5c35f1f7-0d01-0f07-2d33-bfc32541e6f0 | 84         |
  | 5850874b-94ed-7914-5704-6a682b6abbcc | 84         |

#### é—®é¢˜#2: ç‰©ç†è¡¨è¡€ç¼˜ç¼ºå¤±

- **ç°è±¡**: æŒ‡æ ‡è¯¦æƒ…æŠ½å±‰"æ‰€å±æ•°æ®è¡¨"Tabæ˜¾ç¤ºç©º
- **æ ¹å› **: 
  1. GraphQL æŸ¥è¯¢ `CalculatedField` æœªè·å– `upstreamFields[].upstreamColumns[].table`
  2. `sync_fields()` ä»…å¯¹ `ColumnField` è®¾ç½® `table_id`

---

## 3. ä¿®å¤æ–¹æ¡ˆ

### 3.1 å·²å®Œæˆä¿®å¤

**æ–‡ä»¶**: `backend/tableau_sync.py`

**ä¿®æ”¹1: æ‰©å±• GraphQL æŸ¥è¯¢**
```diff
... on CalculatedField {
    upstreamFields {
        id
        name
        datasource { id, name }
+       ... on ColumnField {
+           upstreamColumns {
+               id
+               name
+               table { id, name }
+           }
+       }
    }
}
```

**ä¿®æ”¹2: å¤„ç†è®¡ç®—å­—æ®µçš„ table_id**
```python
# åœ¨ sync_fields() çš„ CalculatedField åˆ†æ”¯ä¸­æ·»åŠ :
upstream_cols = uf.get("upstreamColumns") or []
if upstream_cols and not field.table_id:
    for col in upstream_cols:
        if col and col.get("table"):
            field.table_id = col["table"].get("id")
            break
```

### 3.2 å¾…æ‰§è¡Œæ“ä½œ

é‡æ–°è¿è¡Œæ•°æ®åŒæ­¥ä»¥åº”ç”¨ä¿®å¤ï¼š
```bash
python3 backend/tableau_sync.py
```

---

## 4. éªŒè¯å‘½ä»¤

ä¿®å¤åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯ï¼š

```bash
# éªŒè¯è®¡ç®—å­—æ®µçš„ table_id ä¸å†å…¨ä¸ºç©º
sqlite3 metadata.db "SELECT COUNT(*) FROM fields WHERE is_calculated = 1 AND table_id IS NOT NULL AND table_id != '';"
# æœŸæœ›: > 0

# éªŒè¯å­¤å„¿æ•°æ®æºå¼•ç”¨æ•°é‡å‡å°‘
sqlite3 metadata.db "SELECT COUNT(*) FROM fields f LEFT JOIN datasources d ON f.datasource_id = d.id WHERE f.is_calculated = 1 AND f.datasource_id IS NOT NULL AND d.id IS NULL;"
# æœŸæœ›: 0 æˆ–æ˜¾è‘—å‡å°‘
```

---

**æŠ¥å‘Šç»“æŸ**
