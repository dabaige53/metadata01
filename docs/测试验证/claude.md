# 测试验证文档规范 (CLAUDE.md)

本文档定义了 `docs/测试验证/` 目录下的报告生成规范，供 AI 和开发者参考。

---

## 0. 验证范围说明 (Critical: Validation Scope)

> [!IMPORTANT]
> **本测试验证仅关注系统设计基础问题,不包含数据治理层面的验证。**

### 验证范围
**包含的系统问题**：
- 物理基础设施完整性（主键冲突、外键死链、孤立记录）
- 数据源语义层完整性（空值、空壳数据源、归属缺失）
- 消费层完整性（工作簿/视图的完整性和关联性）
- 字段逻辑基础验证（公式缺失、类型缺失、角色未定义）
- 血缘关系完整性（物理→语义→消费的链路中断）
- 统计准确性验证（前后端数据计数一致性）
- 血缘完整性（孤儿数据源引用、物理表血缘缺失）

**不包含的治理问题**（已移除）：
- 资产利用率分析（僵尸指标、未使用字段、僵尸数据源等）
- 逻辑冗余度分析（重复公式、字段名歧义等）
- 容器有效性分析（空容器工作簿、空容器仪表板等）
- 规范性验证（非认证数据源、资产描述缺失、低价值重命名等）

---

## 1. 核心文件清单

| 文件名                      | 用途                   | 格式要求                         |
| :-------------------------- | :--------------------- | :------------------------------- |
| `系统设计验证清单.csv`      | 验证项主清单（真理源） | 一行一个问题，含验证逻辑/API代码 |
| `系统设计验证.sql`          | 数据库层验证脚本       | 与 CSV 问题项一一对应            |
| `系统设计验证API.sh`        | API 层验证脚本         | 与 CSV 中有 API 命令的项一一对应 |
| `元数据系统设计分析报告.md` | 最终分析报告           | 结构详见下文                     |

---

## 2. 分析报告结构规范 (`元数据系统设计分析报告.md`)

### 2.1 整体结构
```
1. 概要 (Executive Summary)
2. 问题明细 (Issue Details) - 逐行对应 CSV
3. 总结与建议 (Conclusion & Recommendations)
```

### 2.2 问题明细格式要求

**每个问题项必须包含以下字段**：

| 字段                  | 说明                               | 示例                                           |
| :-------------------- | :--------------------------------- | :--------------------------------------------- |
| **验证模块**          | 来自 CSV 第1列                     | `1. 物理基础设施`                              |
| **验证内容**          | 来自 CSV 第2列                     | `数据库主键ID冲突`                             |
| **SQL 查询结果**      | 执行 SQL 得到的异常数              | `异常数: 0`                                    |
| **API 查询结果**      | 执行 cURL 得到的返回值 (若有)      | `API 返回: N/A`                                |
| **前端布局位置**      | 此问题会影响前端哪个页面/组件      | `侧边栏统计 / 治理看板 / 字段列表`             |
| **错误信息元素**      | 前端展示哪个具体字段/指标受影响    | `stats.databases / issues.missing_description` |
| **详细记录(最多5条)** | 如果有异常，列出前5条明细          | `[id: xxx, name: yyy]`                         |
| **缺失内容详解**      | 必须详细说明**缺失了什么具体信息** | 见下方示例                                     |

### 2.3 缺失内容详解规范 (Deficiency Detail Specification)

对于每个发现的问题，**必须详细说明缺失了什么**，不允许简化或省略。

**示例：仪表板内容缺失**
```
问题：仪表板内容缺失
缺失内容详解：
  - 缺失的关系：views 表中 view_type='dashboard' 的记录，未在 dashboard_to_sheet 关联表中
                找到对应的 sheet_id 引用。
  - 缺失的字段：dashboard_to_sheet.sheet_id (应指向被包含的 worksheet 视图 ID)
  - 业务影响：前端在展示该 Dashboard 时，无法渲染其内部的子视图布局，用户看到的是
             一个空白仪表板。
  - 根因推测：Tableau Metadata API 在同步时可能未正确解析 Dashboard 的 containedSheets
             属性，或者该 Dashboard 在 Tableau 中确实为空。
```

**示例：资产描述缺失**
```
问题：资产描述缺失
缺失内容详解：
  - 缺失的字段：fields.description 或 tables.description 为 NULL 或空字符串
  - 缺失的数据：业务含义说明、计算口径、数据来源、更新频率等元数据
  - 业务影响：用户在浏览字段列表或详情抽屉时，无法理解字段的业务含义，只能看到
             技术名称 (如 [Measure1])，严重阻碍自助分析。
```

**示例：逻辑重复定义**
```
问题：逻辑重复定义
缺失内容详解：
  - 缺失的设计：统一的公共计算字段库 (Shared Calculated Field Library)
  - 冗余的数据：多个字段 (field_id_1, field_id_2, ...) 存储了完全相同的 formula 字符串
  - 业务影响：公式逻辑分散在多处，一旦需要修改口径，必须逐个定位和修改，容易遗漏，
             导致数据口径不一致。
```

### 2.4 前端布局位置对照表

| 验证模块/问题类型 | 对应前端页面                 | 对应组件/元素                                     |
| :---------------- | :--------------------------- | :------------------------------------------------ |
| 全局统计对账      | 侧边栏 (AppLayout)           | `databases`, `tables`, `fields`, `metrics` 等计数 |
| 数据源名称为空    | 数据源列表 (DatasourcesPage) | name 字段显示                                     |
| 工作簿归属缺失    | 工作簿列表 (WorkbooksPage)   | project_name 字段显示                             |
| 孤立视图记录      | 视图列表 (ViewsPage)         | workbook_id 关联                                  |
| 仪表板内容缺失    | 视图详情抽屉 (DetailDrawer)  | Dashboard Sheet 列表                              |
| 计算公式丢失      | 指标库页面 (MetricsPage)     | formula 字段显示                                  |
| 孤儿数据源引用    | 指标详情抽屉 (DetailDrawer)  | datasource_name 显示为 "Unknown"                  |
| 物理表血缘缺失    | 字段详情抽屉 (DetailDrawer)  | "所属数据表" Tab 无数据                           |


---

## 3. 报告生成规则

1.  **一行对应一个问题**：报告中的问题明细部分必须与 `系统设计验证清单.csv` 行数匹配。
2.  **概要只写结论**：概要部分仅列出通过/失败的统计和关键发现，不重复明细。
3.  **详细记录限5条**：如果某个问题发现了超过5条异常记录，只列出前5条，并注明"更多..."。
4.  **强制关联前端**：每个问题必须标注其对前端的影响位置，即使是"无直接前端展示"也要说明。

---

## 4. 执行命令

```bash
# 执行 SQL 验证
sqlite3 metadata.db < docs/测试验证/系统设计验证.sql

# 执行 API 验证
./docs/测试验证/系统设计验证API.sh
```

---

**版本**: v1.1
**最后更新**: 2025-12-23

---

## 5. 验证白名单机制 (Validation Whitelist)

为了避免已知误报 (False Positives) 反复干扰验证结果，系统引入了独立的白名单机制。

### 5.1 配置文件
*   **路径**: `docs/测试验证/validation_whitelist.sql`
*   **格式**: SQL Insert 语句，向临时表 `temp_whitelist` 插入记录。

### 5.2 数据结构
| 字段         | 类型 | 说明                                        |
| :----------- | :--- | :------------------------------------------ |
| `rule_id`    | TEXT | 对应验证项 ID (如 `'2.3'`, `'4.2'`)         |
| `value`      | TEXT | 需要排除的值 (支持 `%` 通配符)              |
| `match_type` | TEXT | `'EXACT'` (精确匹配) 或 `'LIKE'` (模糊匹配) |
| `reason`     | TEXT | 排除原因说明                                |

### 5.3 使用示例
若要排除名为 `[My Field]` 的误报字段 (适用于规则 4.2)：

```sql
INSERT INTO temp_whitelist VALUES 
('4.2', 'My Field', 'EXACT', '业务确认无需公式');
```

