# 测试验证文档规范 (CLAUDE.md)

本文档定义了 `docs/测试验证/` 目录下的报告生成规范，供 AI 和开发者参考。

---

## 0. 统计口径说明 (Critical: Aggregation Rule)

> [!IMPORTANT]
> **字段和指标的统计必须采用去重后的"逻辑实体"数量，而非数据库原始记录数。**

### 去重规则
系统采用 **`(name + formula_hash)`** 作为去重键：
- 同名 + 同公式哈希 = **同一个逻辑实体**（即使存在于多个数据源中）
- 仅计算一次，避免因复制/继承导致的膨胀

### SQL 去重模板
```sql
-- 错误示例 (原始记录数，会严重膨胀)
SELECT COUNT(*) FROM fields;  -- 结果: 20234

-- 正确示例 (去重后的逻辑实体数)
SELECT COUNT(DISTINCT f.name || COALESCE(cf.formula_hash, ''))
FROM fields f 
LEFT JOIN calculated_fields cf ON f.id = cf.field_id;  -- 结果: 4724
```

### 对比示例
| 统计项       | 原始记录数 | 去重后逻辑实体数 | 差异 |
| :----------- | :--------- | :--------------- | :--- |
| 全量字段     | 20,234     | 4,724            | -76% |
| 僵尸计算指标 | 2,060      | 774              | -62% |

---

## 1. 核心文件清单

| 文件名                      | 用途                   | 格式要求                         |
| :-------------------------- | :--------------------- | :------------------------------- |
| `系统设计验证清单.csv`      | 验证项主清单（真理源） | 一行一个问题，含验证逻辑/API代码 |
| `系统设计验证.sql`          | 数据库层验证脚本       | 与 CSV 问题项一一对应            |
| `系统设计验证API.sh`        | API 层验证脚本         | 与 CSV 中有 API 命令的项一一对应 |
| `元数据系统设计分析报告.md` | 最终分析报告           | 结构详见下文                     |

---

## 2. 分析报告结构规范 (`元数据系统设计分析报告.md`)

### 2.1 整体结构
```
1. 概要 (Executive Summary)
2. 问题明细 (Issue Details) - 逐行对应 CSV
3. 总结与建议 (Conclusion & Recommendations)
```

### 2.2 问题明细格式要求

**每个问题项必须包含以下字段**：

| 字段                  | 说明                               | 示例                                           |
| :-------------------- | :--------------------------------- | :--------------------------------------------- |
| **验证模块**          | 来自 CSV 第1列                     | `1. 物理基础设施`                              |
| **验证内容**          | 来自 CSV 第2列                     | `数据库主键ID冲突`                             |
| **SQL 查询结果**      | 执行 SQL 得到的异常数              | `异常数: 0`                                    |
| **API 查询结果**      | 执行 cURL 得到的返回值 (若有)      | `API 返回: N/A`                                |
| **前端布局位置**      | 此问题会影响前端哪个页面/组件      | `侧边栏统计 / 治理看板 / 字段列表`             |
| **错误信息元素**      | 前端展示哪个具体字段/指标受影响    | `stats.databases / issues.missing_description` |
| **详细记录(最多5条)** | 如果有异常，列出前5条明细          | `[id: xxx, name: yyy]`                         |
| **缺失内容详解**      | 必须详细说明**缺失了什么具体信息** | 见下方示例                                     |

### 2.3 缺失内容详解规范 (Deficiency Detail Specification)

对于每个发现的问题，**必须详细说明缺失了什么**，不允许简化或省略。

**示例：仪表板内容缺失**
```
问题：仪表板内容缺失
缺失内容详解：
  - 缺失的关系：views 表中 view_type='dashboard' 的记录，未在 dashboard_to_sheet 关联表中
                找到对应的 sheet_id 引用。
  - 缺失的字段：dashboard_to_sheet.sheet_id (应指向被包含的 worksheet 视图 ID)
  - 业务影响：前端在展示该 Dashboard 时，无法渲染其内部的子视图布局，用户看到的是
             一个空白仪表板。
  - 根因推测：Tableau Metadata API 在同步时可能未正确解析 Dashboard 的 containedSheets
             属性，或者该 Dashboard 在 Tableau 中确实为空。
```

**示例：资产描述缺失**
```
问题：资产描述缺失
缺失内容详解：
  - 缺失的字段：fields.description 或 tables.description 为 NULL 或空字符串
  - 缺失的数据：业务含义说明、计算口径、数据来源、更新频率等元数据
  - 业务影响：用户在浏览字段列表或详情抽屉时，无法理解字段的业务含义，只能看到
             技术名称 (如 [Measure1])，严重阻碍自助分析。
```

**示例：逻辑重复定义**
```
问题：逻辑重复定义
缺失内容详解：
  - 缺失的设计：统一的公共计算字段库 (Shared Calculated Field Library)
  - 冗余的数据：多个字段 (field_id_1, field_id_2, ...) 存储了完全相同的 formula 字符串
  - 业务影响：公式逻辑分散在多处，一旦需要修改口径，必须逐个定位和修改，容易遗漏，
             导致数据口径不一致。
```

### 2.4 前端布局位置对照表

| 验证模块/问题类型 | 对应前端页面                 | 对应组件/元素                                             |
| :---------------- | :--------------------------- | :-------------------------------------------------------- |
| 全局统计对账      | 侧边栏 (AppLayout)           | `databases`, `tables`, `fields`, `metrics` 等计数         |
| 治理问题计数      | Overview 仪表板              | `issues.missing_description`, `issues.duplicate_formulas` |
| 重复公式分析      | 指标库页面 (MetricsPage)     | 重复指标 Tab 列表                                         |
| 幽灵字段          | 侧边栏 / 字段列表            | `stats.orphanedFields`                                    |
| 空容器仪表板      | 视图列表 (ViewsPage)         | 类型为 Dashboard 但无 Sheet 的视图                        |
| 非认证数据源      | 数据源列表 (DatasourcesPage) | `is_certified` 标签                                       |
| 资产描述缺失      | 详情抽屉 (DetailDrawer)      | `description` 字段                                        |

---

## 3. 报告生成规则

1.  **一行对应一个问题**：报告中的问题明细部分必须与 `系统设计验证清单.csv` 行数匹配。
2.  **概要只写结论**：概要部分仅列出通过/失败的统计和关键发现，不重复明细。
3.  **详细记录限5条**：如果某个问题发现了超过5条异常记录，只列出前5条，并注明"更多..."。
4.  **强制关联前端**：每个问题必须标注其对前端的影响位置，即使是"无直接前端展示"也要说明。

---

## 4. 执行命令

```bash
# 执行 SQL 验证
sqlite3 metadata.db < docs/测试验证/系统设计验证.sql

# 执行 API 验证
./docs/测试验证/系统设计验证API.sh
```

---

**版本**: v1.0
**最后更新**: 2025-12-23
