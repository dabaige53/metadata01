# Claude 任务指南：元数据验证 JSON 生成与监控

**目标**: 协助用户生成全量模块的验证 JSON 文件，并监控自动化验证脚本的执行质量。
**核心参考文档**:
- [设计规范](./metadata_validation_json_spec.md)
- [生成策略](./metadata_validation_strategy.md)
- [实施计划](../../implementation_plan.md)

## 1. 待生成模块清单 (Task Checklist)

请按照依赖顺序，逐个生成以下模块的验证 JSON。每完成一个，请打钩。

### 基础元数据层
- [ ] **数据库 (Databases)**
    - 重点: 来源于 `databases` 表，基础枚举分布。
- [ ] **物理表 (Physical Tables)**
    - 重点: 1:1 关联数据库，M:N 关联数据源，去重检查。
- [ ] **数据列 (Columns)**
    - 重点: 依附于物理表，字段类型分布。

### 数据源层
- [ ] **数据源 (Datasources)**
    - 重点: 区分 `发布式`、`嵌入式(穿透)`、`嵌入式(独立)`。
    - 难点: 下游连接工作簿，上游连接物理表（多路径）。
- [ ] **连接关系 (Table relationships)**
    - 重点: 逻辑表与物理表的 Join 关系验证。

### 应用层 (Tableau)
- [ ] **工作簿 (Workbooks)**
    - 重点: 包含视图、仪表板，关联数据源。穿透到数据库的血缘最复杂。
- [ ] **视图 (Views)**
    - 重点: 属于工作簿，被字段引用。
- [ ] **仪表板 (Dashboards)**
    - 重点: 包含视图的集合。
- [ ] **应用项目 (Projects)**
    - 重点: 文件夹层级结构。

### 细粒度字段层
- [ ] **原始字段 (Fields)**
    - 重点: 来源于数据源，被视图引用。需区分 `维度` 和 `度量`。
- [ ] **计算字段 (Calculated Fields)**
    - 重点: 公式解析，字段依赖关系（`field_dependencies`）。

---

## 2. 标准 JSON 生成 Prompt 模板

当需要生成某个模块（例如“数据源”）的 JSON 时，请复制以下 Prompt 给 AI：

```markdown
请根据《元数据验证 JSON 设计规范》，为 **[模块名称]** 生成验证 JSON。

**要求：**
1. **任务描述**: 每个节点必须包含 `任务描述`。
2. **结构**: 包含 `核心属性验证`、`血缘质量检测`、`关联元素`（数组）、`前端元素对齐`、`逻辑闭环验证`。
3. **空值填入**: 所有 `SQL实际结果` 和 `API实际结果` 字段留空字符串 `""`。
4. **路径描述**: 关联方式使用 `A > B > C (说明)` 格式。
5. **特殊逻辑**:
   - [在此处补充该模块特有的关联逻辑，如数据源的嵌入式区分...]

**参考 SQL (Base)**:
SELECT * FROM [表名] ...
```

---

## 3. 任务执行与监控指南

在 AI 生成 JSON 或执行验证脚本时，请进行以下监控：

### 3.1 生成质量自检 (Pre-Check)
- [ ] **格式检查**: 是否符合 JSON 语法？所有键名是否中文？
- [ ] **闭环完整性**: 是否包含了 `逻辑闭环验证` 模块？
- [ ] **SQL 可执行性**: 抽检 1-2 条 SQL，确认表名和字段名在 `metadata.db` 中存在。
- [ ] **API 路径**: 确认 `/api/...` 路径在 `api_list.md` 中存在。

### 3.2 执行过程监控 (Running)
如果执行脚本报错，请按以下分类处理：

| 错误类型         | 现象                                  | 处理方案                                                                         |
| :--------------- | :------------------------------------ | :------------------------------------------------------------------------------- |
| **SQL 语法错误** | `OperationalError: no such column...` | 检查 JSON 中的 SQL 字段名，修正后重新运行。                                      |
| **API 连接拒绝** | `ConnectionRefusedError`              | 确认后端服务是否在 `localhost:8101` 启动。                                       |
| **数据不匹配**   | 闭环验证 `FAIL`                       | 1. 检查 SQL 是否过滤了 `is_embedded`。<br>2. 检查 API 是否有默认分页或过滤逻辑。 |

### 3.3 结果验收 (Review)
- 确保所有 `API实际结果` 和 `SQL实际结果` 都有值（不为空）。
- 查看 `血缘质量检测` 是否有非零的告警项。
- 确认 `逻辑闭环验证` 的状态为 `PASS`。

---

## 4. 常用调试命令

```bash
# 重启后端服务
python3 run_backend.py

# 运行单模块验证 (需脚本支持)
python3 verify_module.py --module workbooks

# 检查 SQLite 表结构
sqlite3 metadata.db ".schema tables"
```
