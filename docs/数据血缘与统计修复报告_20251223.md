# 数据血缘与统计修复报告 (2025-12-23)

## 1. 问题背景
在进行元数据系统验证时，发现了严重的血缘断裂和统计不一致问题：
*   **孤立工作簿**: 33 个工作簿（如 OAG 系列）没有任何数据源关联。
*   **无效字段引用**: 4,634 个字段指向不存在的数据源 ID。
*   **统计虚高**: 字段总数达 20,234，存在大量重复副本。

## 2. 根因分析
经排查，这些“孤立”工作簿实际上使用的是**直连数据库**的嵌入式数据源（Local / Direct Connection）。
之前的同步逻辑（v2.0）为了避免重复统计，采取了“一刀切”的策略，只保留“已发布数据源”，将所有嵌入式数据源都视为冗余数据而丢弃。这导致了没有上游发布式映射的直连嵌入源也被误删，从而产生了孤岛。

## 3. 修复方案实施 (混合模式)

我们实施了全新的混合同步策略，核心逻辑如下：

### 3.1 智能识别嵌入式数据源
在 `tableau_sync.py` 中重构了 `sync_workbooks` 和 `fetch_fields` 逻辑：
*   **穿透型嵌入源**: 如果嵌入式数据源引用了已发布的 `upstreamDatasources`，则继续执行去重逻辑，将字段直接挂载到上游发布式数据源。
*   **独立直连型嵌入源**: 如果嵌入式数据源没有上游发布式引用（即直连数据库），则将其识别为独立实体。

### 3.2 保留独立直连源
*   对于识别出的 47 个独立直连源，在 `datasources` 表中创建记录，并标记 `is_embedded=1`。
*   建立 `工作簿 -> 嵌入源 -> 数据库表` 的完整血缘链路。

### 3.3 前端展示优化
*   后端接口 `get_datasources` 增加了 `isEmbedded` 字段返回。
*   前端数据源卡片增加了紫色 **“直连嵌入”** 徽章，以便用户清晰区分发布式数据源和嵌入式直连源。

## 4. 修复结果验证

| 指标               | 修复前 | 修复后     | 结论                   |
| :----------------- | :----- | :--------- | :--------------------- |
| **孤立工作簿**     | 33     | **0**      | ✅ 问题彻底解决         |
| **无效数据源引用** | 4,634  | **0**      | ✅ 所有字段均有归属     |
| **数据源总数**     | 57     | **104**    | ✅ 新增 47 个直连嵌入源 |
| **字段总数**       | 20,234 | **12,768** | ✅ 成功去重 ~40%        |

此修复确保了 Tableau 环境中所有类型的数据连接（发布式 Extract/Live、嵌入式直连）都能被准确捕获和统计，由于去重逻辑的优化，字段统计也更加真实。
