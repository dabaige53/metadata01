# Docker éƒ¨ç½²è¯¦ç»†æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†ä½¿ç”¨ Docker å’Œ Docker Compose éƒ¨ç½² Tableau å…ƒæ•°æ®æ²»ç†å¹³å°çš„é…ç½®è¯´æ˜ã€ç½‘ç»œä¼˜åŒ–åŠå¸¸è§é—®é¢˜å¤„ç†ã€‚

---

## ğŸ³ æœåŠ¡æ¶æ„

é¡¹ç›®é‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œé€šè¿‡ `docker-compose` è¿›è¡Œç¼–æ’ï¼š

| æœåŠ¡åç§°            | é•œåƒåŸºç¡€           | è¯´æ˜                                   | å¤–éƒ¨ç«¯å£ | å†…éƒ¨ç«¯å£ |
| :------------------ | :----------------- | :------------------------------------- | :------- | :------- |
| `metadata-backend`  | `python:3.11-slim` | Flask API æœåŠ¡ï¼Œè´Ÿè´£æ•°æ®åŒæ­¥ä¸ä¸šåŠ¡é€»è¾‘ | **8202** | 8201     |
| `metadata-frontend` | `node:20-alpine`   | Next.js ç”Ÿäº§æ„å»ºï¼Œè´Ÿè´£ UI å±•ç¤º         | **3201** | 3200     |

---

## âš™ï¸ ç¯å¢ƒé…ç½® (`.env`)

åœ¨å¯åŠ¨å‰ï¼Œè¯·ç¡®ä¿æ ¹ç›®å½•ä¸‹çš„ `.env` æ–‡ä»¶å·²æ­£ç¡®é…ç½®ä»¥ä¸‹å˜é‡ï¼š

```bash
# Tableau Server é…ç½®
TABLEAU_BASE_URL=https://your-tableau-server.com
TABLEAU_PAT_NAME=your_token_name
TABLEAU_PAT_SECRET=your_token_secret

# å…¶ä»–å¯é€‰é…ç½®
# FLASK_ENV=production
# DEBUG=false
```

---

## ğŸš€ éƒ¨ç½²å‘½ä»¤

### åŸºç¡€æ“ä½œ

```bash
# ä»¥åå°æ¨¡å¼å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# é‡å¯ç‰¹å®šæœåŠ¡
docker-compose restart backend

# åœæ­¢å¹¶ç§»é™¤å®¹å™¨ã€ç½‘ç»œ
docker-compose down
```

### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs -f

# ä»…æŸ¥çœ‹åç«¯æ—¥å¿—
docker-compose logs -f backend
```

---

## ğŸŒ©ï¸ ç½‘ç»œä¸æ€§èƒ½ä¼˜åŒ–

æˆ‘ä»¬çš„ `docker-compose.yml` åŒ…å«äº†é’ˆå¯¹å¤æ‚ç½‘ç»œç¯å¢ƒï¼ˆå¦‚ VPNã€è™šæ‹ŸåŒ–ç¯å¢ƒï¼‰çš„ä¼˜åŒ–ï¼š

1.  **MTU ä¼˜åŒ–**: ç½‘ç»œé©±åŠ¨é…ç½®äº† `com.docker.network.driver.mtu: 1400`ï¼Œæœ‰æ•ˆé˜²æ­¢å¤§åŒ…åˆ†ç‰‡å¯¼è‡´çš„è¿æ¥è¶…æ—¶ã€‚
2.  **DNS æ˜¾å¼é…ç½®**: å®¹å™¨é…ç½®äº† Google (`8.8.8.8`) å’Œ Cloudflare (`1.1.1.1`) çš„ DNSï¼Œç¡®ä¿ Tableau Server åŸŸåè§£æç¨³å®šã€‚
3.  **ç¦ç”¨ IPv6**: åœ¨æ¡¥æ¥ç½‘ç»œä¸­æ˜¾å¼ç¦ç”¨äº† IPv6ï¼Œå¯å‡å°‘éƒ¨åˆ†ç¯å¢ƒä¸‹ 4-5 ç§’çš„ DNS è§£æå»¶è¿Ÿã€‚

---

## ğŸ’¾ æ•°æ®æŒä¹…åŒ–

Docker é…ç½®äº†ä»¥ä¸‹å·ï¼ˆVolumesï¼‰ä»¥ä¿è¯æ•°æ®æŒä¹…åŒ–ï¼š

-   `./data:/app/data`: å­˜å‚¨ SQLite æ•°æ®åº“æ–‡ä»¶ (`metadata.db`)ã€‚
-   `./logs:/app/logs`: å­˜å‚¨åç«¯è¿è¡Œæ—¥å¿—ã€‚

> [!IMPORTANT]
> å³ä½¿åˆ é™¤å®¹å™¨ï¼Œåªè¦ä¸åˆ é™¤æœ¬åœ° `data/` ç›®å½•ï¼ŒåŒæ­¥åçš„å…ƒæ•°æ®ä¿¡æ¯å°±ä¸ä¼šä¸¢å¤±ã€‚

---

## âœ… å¥åº·æ£€æŸ¥

æ¯ä¸ªå®¹å™¨éƒ½å†…ç½®äº†å¥åº·æ£€æŸ¥é€»è¾‘ï¼š

-   **åç«¯**: æ£€æŸ¥ `http://localhost:8201/api/stats` æ˜¯å¦è¿”å› 200ã€‚
-   **å‰ç«¯**: æ£€æŸ¥ `http://localhost:3200/` æ˜¯å¦å¯è®¿é—®ã€‚

å‰ç«¯æœåŠ¡é…ç½®äº† `depends_on` ç­–ç•¥ï¼Œåªæœ‰å½“åç«¯è¿›å…¥ `healthy` çŠ¶æ€åï¼Œå‰ç«¯æ‰ä¼šå¯åŠ¨ï¼Œç¡®ä¿ä¾èµ–é“¾æ¡æ­£ç¡®ã€‚

---

## âŒ å¸¸è§é—®é¢˜ (Troubleshooting)

### 1. åç«¯æ— æ³•è¿æ¥åˆ° Tableau Server
-   æ£€æŸ¥å®¹å™¨ DNSï¼šæ‰§è¡Œ `docker exec metadata-backend curl -v https://your-tableau.com`ã€‚
-   ç¡®è®¤ API ä»¤ç‰Œ (PAT) æ˜¯å¦æœ‰æƒè®¿é—® Metadata APIã€‚

### 2. ç«¯å£å†²çª
-   å¦‚æœå®¿ä¸»æœºçš„ `8202` æˆ– `3201` å·²è¢«å ç”¨ï¼Œè¯·ä¿®æ”¹ `docker-compose.yml` ä¸­çš„ `ports` æ˜ å°„éƒ¨åˆ†ã€‚

### 3. æ•°æ®åŒæ­¥è§¦å‘
-   è¿›å…¥å®¹å™¨æ‰‹åŠ¨è§¦å‘ï¼š`docker exec -it metadata-backend python backend/tableau_sync.py`ã€‚
