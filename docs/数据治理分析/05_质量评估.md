# 05 数据质量评估

> 从五个维度评估元数据质量，识别治理短板。

---

## 质量评估模型

```
                    ┌─────────────┐
                    │  健康度得分  │
                    │   (0-100)   │
                    └──────┬──────┘
           ┌───────────────┼───────────────┐
           │               │               │
     ┌─────▼─────┐   ┌─────▼─────┐   ┌─────▼─────┐
     │  完整性   │   │  一致性   │   │  规范性   │
     │   25%    │   │   20%    │   │   20%    │
     └───────────┘   └───────────┘   └───────────┘
           │               │               │
     ┌─────▼─────┐   ┌─────▼─────┐
     │  有效性   │   │  时效性   │
     │   15%    │   │   20%    │
     └───────────┘   └───────────┘
```

---

## 五维质量评估

### 维度1: 完整性（Completeness）- 权重25%

> 评估元数据描述的完备程度

**分析SQL**:

```sql
-- 字段描述覆盖率
SELECT 
    COUNT(*) as total,
    SUM(CASE WHEN description IS NOT NULL AND description != '' THEN 1 ELSE 0 END) as with_desc,
    ROUND(SUM(CASE WHEN description IS NOT NULL AND description != '' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as coverage_pct
FROM fields;

-- 表描述覆盖率
SELECT 
    COUNT(*) as total,
    SUM(CASE WHEN description IS NOT NULL AND description != '' THEN 1 ELSE 0 END) as with_desc,
    ROUND(SUM(CASE WHEN description IS NOT NULL AND description != '' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as coverage_pct
FROM tables;

-- 数据源描述覆盖率
SELECT 
    COUNT(*) as total,
    SUM(CASE WHEN description IS NOT NULL AND description != '' THEN 1 ELSE 0 END) as with_desc,
    ROUND(SUM(CASE WHEN description IS NOT NULL AND description != '' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as coverage_pct
FROM datasources;
```

**当前状态**:

| 资产类型 | 总数 | 有描述 | 覆盖率 | 评级 |
|---------|------|-------|-------|------|
| 字段 | 8,314 | 3 | 0.04% | 🔴 |
| 表 | 450 | - | - | 🔴 |
| 数据源 | 53 | - | - | - |

---

### 维度2: 一致性（Consistency）- 权重20%

> 评估命名规范和公式重复情况

**分析SQL**:

```sql
-- 重复公式检测
SELECT formula, COUNT(*) as duplicate_count
FROM calculated_fields
WHERE formula IS NOT NULL AND formula != ''
GROUP BY formula
HAVING COUNT(*) > 1
ORDER BY duplicate_count DESC LIMIT 10;

-- 重复公式数量统计
SELECT COUNT(*) as duplicate_formula_instances
FROM (
    SELECT formula, COUNT(*) as cnt
    FROM calculated_fields
    WHERE formula IS NOT NULL
    GROUP BY formula
    HAVING cnt > 1
);

-- 命名规范检查（含特殊字符的字段名）
SELECT name FROM fields
WHERE name GLOB '*[!a-zA-Z0-9_\u4e00-\u9fa5 ]*'
LIMIT 20;
```

**当前状态**:

| 指标 | 值 | 评级 |
|-----|---|------|
| 重复公式数 | 123 | 🟠 |
| 唯一公式数 | 1,676 | - |
| 重复率 | 6.8% | 🟠 |

---

### 维度3: 规范性（Standardization）- 权重20%

> 评估资产认证和标准化程度

**分析SQL**:

```sql
-- 数据源认证率
SELECT 
    SUM(CASE WHEN is_certified = 1 THEN 1 ELSE 0 END) as certified,
    COUNT(*) as total,
    ROUND(SUM(CASE WHEN is_certified = 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as cert_rate
FROM datasources;

-- 表认证率
SELECT 
    SUM(CASE WHEN is_certified = 1 THEN 1 ELSE 0 END) as certified,
    COUNT(*) as total,
    ROUND(SUM(CASE WHEN is_certified = 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as cert_rate
FROM tables;

-- 术语表覆盖
SELECT COUNT(*) as glossary_terms FROM glossary;
```

**当前状态**:

| 指标 | 值 | 目标 | 评级 |
|-----|---|-----|------|
| 数据源认证率 | 0% | >50% | 🔴 |
| 表认证率 | 0% | >30% | 🔴 |
| 术语表条目 | 39 | >100 | 🟡 |

---

### 维度4: 有效性（Validity）- 权重15%

> 评估孤立资产和无效关联

**分析SQL**:

```sql
-- 孤立表比例
SELECT 
    (SELECT COUNT(*) FROM tables t 
     LEFT JOIN table_to_datasource td ON t.id = td.table_id 
     WHERE td.datasource_id IS NULL) as orphan_tables,
    (SELECT COUNT(*) FROM tables) as total_tables;

-- 孤立字段比例
SELECT 
    (SELECT COUNT(*) FROM fields f 
     LEFT JOIN field_to_view fv ON f.id = fv.field_id 
     WHERE fv.view_id IS NULL) as orphan_fields,
    (SELECT COUNT(*) FROM fields) as total_fields;

-- 孤立数据源比例
SELECT 
    (SELECT COUNT(*) FROM datasources ds 
     LEFT JOIN datasource_to_workbook dw ON ds.id = dw.datasource_id 
     WHERE dw.workbook_id IS NULL) as orphan_ds,
    (SELECT COUNT(*) FROM datasources) as total_ds;
```

**当前状态**:

| 资产类型 | 孤立数 | 总数 | 孤立率 | 评级 |
|---------|-------|-----|-------|------|
| 表 | 388 | 450 | 86.2% | 🔴 |
| 字段 | 6,341 | 8,314 | 76.3% | 🔴 |
| 数据源 | 27 | 53 | 50.9% | 🔴 |

---

### 维度5: 时效性（Timeliness）- 权重20%

> 评估数据刷新和更新频率

**分析SQL**:

```sql
-- 过期抽取数据源（超过30天未刷新）
SELECT 
    SUM(CASE WHEN julianday('now') - julianday(extract_last_refresh_time) > 30 THEN 1 ELSE 0 END) as stale,
    SUM(CASE WHEN julianday('now') - julianday(extract_last_refresh_time) > 90 THEN 1 ELSE 0 END) as dead,
    COUNT(*) as total
FROM datasources
WHERE has_extract = 1;

-- 长期未更新资产
SELECT name, updated_at,
       julianday('now') - julianday(updated_at) as days_ago
FROM datasources
WHERE updated_at IS NOT NULL
ORDER BY updated_at
LIMIT 10;
```

---

## 综合健康度计算

**计算公式**:

```
健康度 = 完整性×25% + 一致性×20% + 规范性×20% + 有效性×15% + 时效性×20%
```

**当前评分**:

| 维度 | 得分 | 权重 | 加权得分 |
|-----|-----|-----|---------|
| 完整性 | 0 | 25% | 0 |
| 一致性 | 93.2 | 20% | 18.6 |
| 规范性 | 0 | 20% | 0 |
| 有效性 | 22.6 | 15% | 3.4 |
| 时效性 | - | 20% | - |
| **综合** | - | 100% | **~22** |

---

## 输出物

1. **五维雷达图** - 各维度得分可视化
2. **问题清单** - 按严重程度排序的问题列表
3. **基线报告** - 当前质量状态快照
4. **改进路线图** - 分阶段提升计划

---

## 治理建议

| 维度 | 当前状态 | 改进建议 | 优先级 |
|-----|---------|---------|-------|
| 完整性 | 0.04% | 批量补充字段描述 | P0 |
| 规范性 | 0% | 建立认证流程 | P1 |
| 有效性 | ~24% | 清理孤立资产 | P1 |
| 一致性 | 93% | 统一重复公式 | P2 |
| 时效性 | - | 检查刷新调度 | P2 |
