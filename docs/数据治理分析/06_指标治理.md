# 06 指标治理分析

> 深度分析计算字段/指标，发现重复、评估复杂度、追踪依赖。

---

## 分析目标

1. 检测重复指标（相同公式不同命名）
2. 评估指标复杂度
3. 追踪指标依赖链
4. 发现语义相似指标
5. 建立标准化指标库

---

## 指标概览

| 指标 | 数量 | 说明 |
|-----|------|------|
| 总计算字段 | 4,778 | `is_calculated = true` 的字段 |
| 唯一公式 | 1,676 | 去重后的公式数 |
| 重复公式 | 123 | 相同公式出现多次 |
| 字段依赖关系 | 9,432 | 计算字段间依赖 |

---

## 分析步骤

### Step 1: 重复指标检测

**分析SQL**:

```sql
-- 重复公式 Top 20（相同公式不同命名）
SELECT 
    formula,
    COUNT(*) as usage_count,
    GROUP_CONCAT(name, ' | ') as field_names
FROM calculated_fields
WHERE formula IS NOT NULL AND formula != ''
GROUP BY formula
HAVING COUNT(*) > 1
ORDER BY usage_count DESC
LIMIT 20;

-- 重复公式统计
SELECT 
    CASE 
        WHEN cnt = 1 THEN '唯一公式'
        WHEN cnt <= 3 THEN '少量重复(2-3)'
        WHEN cnt <= 10 THEN '中度重复(4-10)'
        ELSE '严重重复(>10)'
    END as dup_level,
    COUNT(*) as formula_count,
    SUM(cnt) as total_fields
FROM (
    SELECT formula, COUNT(*) as cnt
    FROM calculated_fields
    WHERE formula IS NOT NULL
    GROUP BY formula
) sub
GROUP BY dup_level;
```

**重复指标示例**:

| 公式 | 出现次数 | 指标名（示例） |
|-----|---------|--------------|
| `SUM([销售额])` | 44次 | 销售额、总销售额、Sales... |
| `[利润]/[销售额]` | 25次 | 利润率、Profit Margin... |

---

### Step 2: 复杂度评估

**复杂度评分规则**:

| 分数 | 等级 | 判断标准 |
|-----|-----|---------|
| 0-3 | 低 | 简单聚合/引用 |
| 4-7 | 中 | 含条件/多字段 |
| 8-10 | 高 | 嵌套函数/复杂逻辑 |

**分析SQL**:

```sql
-- 复杂度分布
SELECT 
    CASE 
        WHEN complexity_score <= 3 THEN '低复杂度'
        WHEN complexity_score <= 7 THEN '中复杂度'
        ELSE '高复杂度'
    END as level,
    COUNT(*) as count
FROM calculated_fields
GROUP BY level;

-- 高复杂度指标 Top 10
SELECT cf.name, cf.formula, cf.complexity_score
FROM calculated_fields cf
ORDER BY cf.complexity_score DESC
LIMIT 10;
```

**当前分布**:

| 复杂度 | 数量 | 占比 |
|-------|-----|------|
| 低 | 4,778 | 100% |
| 中 | 0 | 0% |
| 高 | 0 | 0% |

> ⚠️ 注意：复杂度评分需重新计算

---

### Step 3: 依赖链分析

**分析SQL**:

```sql
-- 指标依赖的基础字段
SELECT 
    cf.name as metric_name,
    fd.dependency_name as depends_on,
    fd.dependency_type
FROM calculated_fields cf
JOIN field_dependencies fd ON cf.field_id = fd.source_field_id
ORDER BY cf.name
LIMIT 50;

-- 被依赖最多的字段（核心字段）
SELECT 
    fd.dependency_name,
    COUNT(*) as dependents_count
FROM field_dependencies fd
GROUP BY fd.dependency_name
ORDER BY dependents_count DESC
LIMIT 20;

-- 依赖深度（依赖其他计算字段的指标）
SELECT cf.name, cf2.name as depends_on_metric
FROM calculated_fields cf
JOIN field_dependencies fd ON cf.field_id = fd.source_field_id
JOIN calculated_fields cf2 ON fd.dependency_field_id = cf2.field_id
LIMIT 20;
```

**依赖图谱示例**:

```
利润率
  ├── 利润 (计算字段)
  │     ├── 销售额 (基础字段)
  │     └── 成本 (基础字段)
  └── 销售额 (基础字段)
```

---

### Step 4: 指标引用热度

**分析SQL**:

```sql
-- 指标被视图引用次数
SELECT cf.name, cf.reference_count, f.usage_count
FROM calculated_fields cf
JOIN fields f ON cf.field_id = f.id
ORDER BY cf.reference_count DESC
LIMIT 20;

-- 未被使用的指标
SELECT cf.name, cf.formula
FROM calculated_fields cf
JOIN fields f ON cf.field_id = f.id
LEFT JOIN field_to_view fv ON f.id = fv.field_id
WHERE fv.view_id IS NULL
LIMIT 50;
```

---

### Step 5: 指标分类（按类型）

**指标类型分类**:

| 类型 | 识别规则 | 示例 |
|-----|---------|------|
| KPI | 核心业务指标 | 销售额、利润率 |
| 比率 | 含除法运算 | 占比、增长率 |
| 聚合 | SUM/AVG/COUNT | 总数、平均值 |
| 条件 | IF/CASE | 分类标签 |
| 时间 | 日期函数 | 年同比、月环比 |

**分析SQL**:

```sql
-- 按公式特征分类
SELECT 
    CASE 
        WHEN formula LIKE '%/%' THEN '比率类'
        WHEN formula LIKE '%SUM%' OR formula LIKE '%AVG%' THEN '聚合类'
        WHEN formula LIKE '%IF%' OR formula LIKE '%CASE%' THEN '条件类'
        WHEN formula LIKE '%YEAR%' OR formula LIKE '%MONTH%' THEN '时间类'
        ELSE '其他'
    END as metric_type,
    COUNT(*) as count
FROM calculated_fields
WHERE formula IS NOT NULL
GROUP BY metric_type;
```

---

### Step 6: 标准化建议

**分析SQL**:

```sql
-- 同名不同公式（需统一）
SELECT name, COUNT(DISTINCT formula) as formula_variants
FROM calculated_fields
GROUP BY name
HAVING formula_variants > 1
ORDER BY formula_variants DESC;

-- 相似名称（可能重复）
SELECT cf1.name, cf2.name
FROM calculated_fields cf1
JOIN calculated_fields cf2 ON cf1.name != cf2.name
WHERE cf1.name LIKE '%' || cf2.name || '%'
   OR cf2.name LIKE '%' || cf1.name || '%'
LIMIT 20;
```

---

## 输出物

1. **重复指标清单** - 相同公式的指标对照表
2. **复杂度分布图** - 指标复杂度分级
3. **依赖关系图** - 指标间依赖可视化
4. **标准化建议** - 统一命名/公式建议

---

## 治理建议

| 问题 | 数量 | 建议 | 优先级 |
|-----|-----|-----|-------|
| 相同公式重复44次 | 1 | 建立标准指标库 | P1 |
| 总重复公式 | 123 | 统一为官方版本 | P1 |
| 复杂度未计算 | - | 实现复杂度算法 | P2 |
| 未使用指标 | - | 定期清理 | P3 |
