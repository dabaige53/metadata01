# 03 使用分析

> 分析数据资产的使用热度，识别核心资产与冷门资产。

---

## 分析目标

1. 识别高价值热门资产（优先保障）
2. 发现冷门/僵尸资产（清理候选）
3. 分析用户使用行为模式
4. 评估资产复用程度

---

## 热度分级标准

| 级别 | 图标 | 定义 | 治理策略 |
|-----|-----|------|---------|
| 热门 | 🔥 | 访问量 Top 10% | 优先维护、重点监控 |
| 活跃 | ✅ | 近30天有访问 | 常规维护 |
| 冷门 | ⚠️ | 超60天未访问 | 关注警告 |
| 僵尸 | ❄️ | 超180天未访问 | 清理候选 |

---

## 分析步骤

### Step 1: 视图访问热度排名

**分析SQL**:

```sql
-- 视图访问量 Top 20
SELECT v.name, 
       v.total_view_count,
       w.name as workbook,
       v.view_type
FROM views v
JOIN workbooks w ON v.workbook_id = w.id
ORDER BY v.total_view_count DESC
LIMIT 20;

-- 热度分布统计
SELECT 
    CASE 
        WHEN total_view_count = 0 THEN '零访问'
        WHEN total_view_count < 10 THEN '低访问(<10)'
        WHEN total_view_count < 100 THEN '中访问(10-100)'
        ELSE '高访问(>100)'
    END as tier,
    COUNT(*) as view_count
FROM views
GROUP BY tier;
```

---

### Step 2: 工作簿规模分析

**分析SQL**:

```sql
-- 工作簿按视图数量排名
SELECT w.name, 
       COUNT(v.id) as view_count,
       w.owner,
       w.project_name
FROM workbooks w
LEFT JOIN views v ON w.id = v.workbook_id
GROUP BY w.id
ORDER BY view_count DESC LIMIT 10;
```

**预期输出**:

| 工作簿 | 视图数 | 所有者 |
|-------|-------|-------|
| 销售航段_新 | 119 | - |
| 销售数据分析平台 | 117 | - |
| 销售分析 | 97 | - |
| 销售数据分析-国际平台 | 76 | - |
| OD-TT | 75 | - |

---

### Step 3: 数据源复用分析

**分析SQL**:

```sql
-- 数据源被多少工作簿引用
SELECT ds.name,
       COUNT(DISTINCT dw.workbook_id) as workbook_count,
       ds.field_count,
       ds.is_certified
FROM datasources ds
LEFT JOIN datasource_to_workbook dw ON ds.id = dw.datasource_id
GROUP BY ds.id
ORDER BY workbook_count DESC LIMIT 10;

-- 单一引用 vs 多次复用
SELECT 
    CASE 
        WHEN wb_count = 0 THEN '未使用'
        WHEN wb_count = 1 THEN '单一使用'
        ELSE '多次复用'
    END as usage_type,
    COUNT(*) as ds_count
FROM (
    SELECT ds.id, COUNT(dw.workbook_id) as wb_count
    FROM datasources ds
    LEFT JOIN datasource_to_workbook dw ON ds.id = dw.datasource_id
    GROUP BY ds.id
) sub
GROUP BY usage_type;
```

---

### Step 4: 字段引用热度

**分析SQL**:

```sql
-- 字段被视图引用次数 Top 20
SELECT f.name,
       f.usage_count,
       f.role,
       f.is_calculated,
       ds.name as datasource
FROM fields f
LEFT JOIN datasources ds ON f.datasource_id = ds.id
ORDER BY f.usage_count DESC
LIMIT 20;

-- 字段使用分布
SELECT 
    CASE 
        WHEN usage_count = 0 THEN '从未使用'
        WHEN usage_count < 5 THEN '低频使用(1-5)'
        WHEN usage_count < 20 THEN '中频使用(5-20)'
        ELSE '高频使用(>20)'
    END as tier,
    COUNT(*) as field_count
FROM fields
GROUP BY tier;
```

---

### Step 5: 冷门资产识别

**分析SQL**:

```sql
-- 零访问视图
SELECT v.name, w.name as workbook, v.created_at
FROM views v
JOIN workbooks w ON v.workbook_id = w.id
WHERE v.total_view_count = 0
ORDER BY v.created_at;

-- 未使用字段（从未被视图引用）
SELECT f.name, ds.name as datasource
FROM fields f
LEFT JOIN field_to_view fv ON f.id = fv.field_id
LEFT JOIN datasources ds ON f.datasource_id = ds.id
WHERE fv.view_id IS NULL
LIMIT 50;

-- 未使用数据源
SELECT ds.name, ds.owner, ds.created_at
FROM datasources ds
LEFT JOIN datasource_to_workbook dw ON ds.id = dw.datasource_id
WHERE dw.workbook_id IS NULL;
```

**当前冷门资产**:

| 类型 | 冷门数量 | 占比 |
|-----|---------|------|
| 未使用字段 | 6,341 | 76.3% |
| 孤立数据源 | 27 | 50.9% |

---

### Step 6: 用户活跃度分析

**分析SQL**:

```sql
-- 按所有者统计资产创建量
SELECT owner,
       COUNT(*) as ds_count,
       SUM(field_count) as total_fields
FROM datasources
WHERE owner IS NOT NULL
GROUP BY owner
ORDER BY ds_count DESC;

-- Tableau用户列表
SELECT name, display_name, site_role
FROM tableau_users;
```

---

### Step 7: 复用效率评估

**关键指标**:

| 指标 | 计算方式 | 当前值 | 目标 |
|-----|---------|-------|------|
| 数据源复用率 | 被≥2工作簿使用的数据源占比 | - | >50% |
| 字段使用率 | 被≥1视图使用的字段占比 | 23.7% | >60% |
| 报表活跃率 | 近30天有访问的视图占比 | - | >40% |

---

## 输出物

1. **热度排名表** - 视图/字段/数据源访问量排名
2. **冷门资产清单** - 待清理的僵尸资产列表
3. **复用分析报告** - 资产复用效率评估
4. **用户行为报告** - 创建/使用行为分析

---

## 治理建议

| 发现 | 建议 |
|-----|-----|
| 76%字段从未使用 | 评估业务必要性，考虑隐藏或清理 |
| 51%数据源未被工作簿引用 | 建立生命周期管理，定期清理 |
| Top 5工作簿包含484视图 | 考虑拆分为更细粒度工作簿 |
| 2个所有者创建所有数据源 | 关注人员变动风险 |
