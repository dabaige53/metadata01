# 02 æ•°æ®è¡€ç¼˜åˆ†æ

> è¿½è¸ªæ•°æ®ä»æºå¤´åˆ°å±•ç¤ºçš„å®Œæ•´é“¾è·¯ï¼Œæ”¯æŒå½±å“åˆ†æå’Œå˜æ›´è¯„ä¼°ã€‚

---

## åˆ†æç›®æ ‡

1. æ„å»ºç«¯åˆ°ç«¯æ•°æ®è¡€ç¼˜å›¾è°±
2. è¯†åˆ«å…³é”®èŠ‚ç‚¹å’Œä¾èµ–è·¯å¾„
3. è¯„ä¼°å˜æ›´å½±å“èŒƒå›´
4. å‘ç°è¡€ç¼˜æ–­é“¾ï¼ˆå­¤ç«‹èµ„äº§ï¼‰

---

## è¡€ç¼˜å±‚æ¬¡æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®è¡€ç¼˜å…¨æ™¯                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ã€æºå¤´å±‚ã€‘      ã€åŠ å·¥å±‚ã€‘      ã€è¯­ä¹‰å±‚ã€‘      ã€å±•ç¤ºå±‚ã€‘        â”‚
â”‚                                                                  â”‚
â”‚  Database â”€â”€â–º Table â”€â”€â–º Datasource â”€â”€â–º Workbook â”€â”€â–º View        â”‚
â”‚     6          450         53            79         1564         â”‚
â”‚     â”‚           â”‚           â”‚             â”‚           â”‚          â”‚
â”‚     â””â”€â”€ Column  â”‚           â””â”€â”€ Field â”€â”€â”€â”€â”´â”€â”€ Metric  â”‚          â”‚
â”‚         4720    â”‚               8314          4778    â”‚          â”‚
â”‚                 â”‚                                     â”‚          â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ table_to_datasource â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                           (81 æ¡å…³è”)                             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åˆ†ææ­¥éª¤

### Step 1: è¡€ç¼˜å…³ç³»ç»Ÿè®¡

**åˆ†æSQL**:

```sql
-- å„ç±»è¡€ç¼˜å…³ç³»æ•°é‡
SELECT 'table â†’ datasource' as relation, COUNT(*) FROM table_to_datasource
UNION ALL SELECT 'datasource â†’ workbook', COUNT(*) FROM datasource_to_workbook
UNION ALL SELECT 'field â†’ view', COUNT(*) FROM field_to_view
UNION ALL SELECT 'field â†’ field (ä¾èµ–)', COUNT(*) FROM field_dependencies;
```

**é¢„æœŸè¾“å‡º**:

| è¡€ç¼˜å…³ç³» | æ•°é‡ | è¯´æ˜ |
|---------|-----|------|
| è¡¨â†’æ•°æ®æº | 81 | è¡¨è¢«æ•°æ®æºå¼•ç”¨ |
| æ•°æ®æºâ†’å·¥ä½œç°¿ | 59 | æ•°æ®æºè¢«å·¥ä½œç°¿ä½¿ç”¨ |
| å­—æ®µâ†’è§†å›¾ | 185,082 | å­—æ®µåœ¨è§†å›¾ä¸­ä½¿ç”¨ |
| å­—æ®µä¾èµ– | 9,432 | è®¡ç®—å­—æ®µé—´ä¾èµ– |

---

### Step 2: ä¸Šæ¸¸è¿½è¸ªï¼ˆåå‘è¡€ç¼˜ï¼‰

> åœºæ™¯ï¼šæŸä¸ªè§†å›¾/æŠ¥è¡¨ä¾èµ–å“ªäº›æ•°æ®è¡¨ï¼Ÿ

**åˆ†æSQL**:

```sql
-- è§†å›¾çš„ä¸Šæ¸¸æ•°æ®è¡¨
SELECT v.name as view_name, 
       w.name as workbook,
       ds.name as datasource,
       t.name as source_table,
       db.name as database
FROM views v
JOIN workbooks w ON v.workbook_id = w.id
JOIN datasource_to_workbook dw ON w.id = dw.workbook_id
JOIN datasources ds ON dw.datasource_id = ds.id
JOIN table_to_datasource td ON ds.id = td.datasource_id
JOIN tables t ON td.table_id = t.id
LEFT JOIN databases db ON t.database_id = db.id
WHERE v.name = 'ç›®æ ‡è§†å›¾å'
ORDER BY view_name;
```

**ç¤ºä¾‹è¡€ç¼˜é“¾**:

```
é”€å”®è¶‹åŠ¿ä»ªè¡¨æ¿
  â”œâ”€â”€ ä¸Šæ¸¸å·¥ä½œç°¿: é”€å”®åˆ†æ
  â”‚     â””â”€â”€ ä¸Šæ¸¸æ•°æ®æº: é”€å”®æ•°æ®æº
  â”‚           â””â”€â”€ ä¸Šæ¸¸è¡¨: orders, customers
  â”‚                 â””â”€â”€ ä¸Šæ¸¸æ•°æ®åº“: sales_db
  â””â”€â”€ ä½¿ç”¨å­—æ®µ: é”€å”®é¢, æ—¥æœŸ, åŒºåŸŸ
```

---

### Step 3: ä¸‹æ¸¸å½±å“ï¼ˆæ­£å‘è¡€ç¼˜ï¼‰

> åœºæ™¯ï¼šä¿®æ”¹æŸä¸ªè¡¨ä¼šå½±å“å“ªäº›æŠ¥è¡¨ï¼Ÿ

**åˆ†æSQL**:

```sql
-- è¡¨çš„ä¸‹æ¸¸å½±å“èŒƒå›´
SELECT t.name as table_name,
       COUNT(DISTINCT ds.id) as datasource_count,
       COUNT(DISTINCT w.id) as workbook_count,
       COUNT(DISTINCT v.id) as view_count
FROM tables t
JOIN table_to_datasource td ON t.id = td.table_id
JOIN datasources ds ON td.datasource_id = ds.id
JOIN datasource_to_workbook dw ON ds.id = dw.datasource_id
JOIN workbooks w ON dw.workbook_id = w.id
JOIN views v ON w.id = v.workbook_id
GROUP BY t.id
ORDER BY view_count DESC LIMIT 10;
```

**å½±å“åˆ†æç¤ºä¾‹**:

```
ä¿®æ”¹è¡¨: orders
  â””â”€â”€ å½±å“æ•°æ®æº: 3 ä¸ª
       â””â”€â”€ å½±å“å·¥ä½œç°¿: 5 ä¸ª
            â””â”€â”€ å½±å“è§†å›¾: 47 ä¸ª
                 â””â”€â”€ å¯èƒ½å—å½±å“ç”¨æˆ·: N äºº
```

---

### Step 4: å­—æ®µçº§è¡€ç¼˜

**åˆ†æSQL**:

```sql
-- å­—æ®µè¢«å“ªäº›è§†å›¾ä½¿ç”¨
SELECT f.name as field_name,
       COUNT(DISTINCT fv.view_id) as used_in_views,
       GROUP_CONCAT(DISTINCT v.name) as view_names
FROM fields f
JOIN field_to_view fv ON f.id = fv.field_id
JOIN views v ON fv.view_id = v.id
GROUP BY f.id
ORDER BY used_in_views DESC LIMIT 20;
```

---

### Step 5: è®¡ç®—å­—æ®µä¾èµ–é“¾

**åˆ†æSQL**:

```sql
-- è®¡ç®—å­—æ®µçš„ä¾èµ–å…³ç³»
SELECT cf.name as metric_name,
       fd.dependency_name as depends_on,
       fd.dependency_type
FROM calculated_fields cf
JOIN field_dependencies fd ON cf.field_id = fd.source_field_id
ORDER BY cf.name;

-- ä¾èµ–æ·±åº¦åˆ†æï¼ˆè¢«å¤šå°‘æŒ‡æ ‡å¼•ç”¨ï¼‰
SELECT fd.dependency_name,
       COUNT(*) as referenced_by_count
FROM field_dependencies fd
GROUP BY fd.dependency_name
ORDER BY referenced_by_count DESC LIMIT 10;
```

---

### Step 6: å­¤å²›æ£€æµ‹ï¼ˆè¡€ç¼˜æ–­é“¾ï¼‰

**åˆ†æSQL**:

```sql
-- å­¤ç«‹è¡¨ï¼ˆæœªè¢«ä»»ä½•æ•°æ®æºå¼•ç”¨ï¼‰
SELECT t.name, t.schema, t.database_id
FROM tables t
LEFT JOIN table_to_datasource td ON t.id = td.table_id
WHERE td.datasource_id IS NULL;

-- å­¤ç«‹æ•°æ®æºï¼ˆæœªè¢«ä»»ä½•å·¥ä½œç°¿ä½¿ç”¨ï¼‰
SELECT ds.name, ds.owner, ds.project_name
FROM datasources ds
LEFT JOIN datasource_to_workbook dw ON ds.id = dw.datasource_id
WHERE dw.workbook_id IS NULL;

-- å­¤ç«‹å­—æ®µï¼ˆæœªè¢«ä»»ä½•è§†å›¾ä½¿ç”¨ï¼‰
SELECT f.name, f.datasource_id, f.is_calculated
FROM fields f
LEFT JOIN field_to_view fv ON f.id = fv.field_id
WHERE fv.view_id IS NULL;
```

**å½“å‰å­¤ç«‹èµ„äº§**:

| ç±»å‹ | å­¤ç«‹æ•°é‡ | å æ¯” |
|-----|---------|------|
| å­¤ç«‹è¡¨ | 388 | 86% |
| å­¤ç«‹æ•°æ®æº | 27 | 51% |
| å­¤ç«‹å­—æ®µ | 6,341 | 76% |

---

### Step 7: å…³é”®èŠ‚ç‚¹è¯†åˆ«

**åˆ†æSQL**:

```sql
-- é«˜æ‰‡å‡ºèŠ‚ç‚¹ï¼ˆè¢«å¤§é‡ä¸‹æ¸¸ä¾èµ–ï¼‰
SELECT ds.name, 
       COUNT(DISTINCT dw.workbook_id) as workbook_fanout,
       (SELECT COUNT(*) FROM fields f WHERE f.datasource_id = ds.id) as field_count
FROM datasources ds
JOIN datasource_to_workbook dw ON ds.id = dw.datasource_id
GROUP BY ds.id
ORDER BY workbook_fanout DESC LIMIT 10;
```

---

## è¾“å‡ºç‰©

1. **è¡€ç¼˜å…³ç³»å›¾** - å¯è§†åŒ–èµ„äº§é—´çš„ä¾èµ–å…³ç³»
2. **å½±å“åˆ†ææŠ¥å‘Š** - å˜æ›´å½±å“èŒƒå›´è¯„ä¼°
3. **å­¤å²›èµ„äº§æ¸…å•** - å¾…å¤„ç†çš„æ–­é“¾èµ„äº§åˆ—è¡¨
4. **å…³é”®èŠ‚ç‚¹æ¸…å•** - é«˜ä»·å€¼/é«˜é£é™©èµ„äº§æ ‡è¯†

---

## æ²»ç†å»ºè®®

| å‘ç° | é£é™©ç­‰çº§ | å»ºè®® |
|-----|---------|-----|
| 86%è¡¨å­¤ç«‹ | ğŸ”´ é«˜ | è¯„ä¼°æ˜¯å¦åºŸå¼ƒæˆ–å»ºç«‹å…³è” |
| 51%æ•°æ®æºå­¤ç«‹ | ğŸŸ  ä¸­ | æ¸…ç†æˆ–å…³è”å·¥ä½œç°¿ |
| 76%å­—æ®µå­¤ç«‹ | ğŸŸ  ä¸­ | ç¡®è®¤ä¸šåŠ¡å¿…è¦æ€§ |
| 9432æ¡ä¾èµ–å…³ç³» | - | å®šæœŸåˆ·æ–°ä¾èµ–å›¾è°± |
