# 字段采集、去重与血缘关联流程

> 本文档从产品视角描述字段从 Tableau 采集到最终展示的完整流程。

---

## 一、字段数据量变化全景

```
┌──────────────────────────────────────────────────────────────────┐
│                    Tableau 服务器原始数据                         │
├──────────────────────────────────────────────────────────────────┤
│  原始字段实例: 约 20,000+ 个                                      │
│                                                                    │
│  其中包含大量"重复"：                                              │
│  - 同一字段在多个工作簿中被引用                                    │
│  - 同一字段被嵌入数据源"复制"了一份副本                            │
└──────────────────────────────────────────────────────────────────┘
                                 ↓
                          智能去重
                                 ↓
┌──────────────────────────────────────────────────────────────────┐
│                        系统最终入库                               │
├──────────────────────────────────────────────────────────────────┤
│  去重后入库: 12,768 个独立字段                                    │
│                                                                    │
│  按来源分布:                                                       │
│  ├── 来自已发布数据源: 8,134 个 (63.7%)                           │
│  └── 来自嵌入式数据源: 4,634 个 (36.3%)                           │
│                                                                    │
│  按类型分布:                                                       │
│  ├── 原始字段 (直接对应数据库列): 7,839 个 (61.4%)                │
│  └── 计算字段 (公式计算生成):     4,929 个 (38.6%)                │
└──────────────────────────────────────────────────────────────────┘
```

---

## 二、采集阶段：从 Tableau 获取字段数据

### 2.1 采集范围

系统会从 **两类数据源** 中采集字段：

| 数据源类型       | 数量   | 说明                                                 |
| ---------------- | ------ | ---------------------------------------------------- |
| **已发布数据源** | 57 个  | 独立发布到 Tableau Server 上，可被多个工作簿共享复用 |
| **嵌入式数据源** | 115 个 | 直接嵌在工作簿内部，随工作簿一起保存                 |

### 2.2 采集的字段信息

对于每个字段，系统会获取以下信息：

| 信息类别     | 具体内容                           | 用途         |
| ------------ | ---------------------------------- | ------------ |
| **基本信息** | 字段名、描述、数据类型             | 展示给用户   |
| **角色信息** | 维度/度量、是否隐藏                | 字段分类     |
| **计算公式** | 计算字段的公式内容                 | 字段依赖分析 |
| **来源信息** | 所属数据源、上游数据列、上游数据表 | 血缘追溯     |

### 2.3 采集过程中的"穿透"处理

**业务场景**：
用户在工作簿中"连接"一个已发布数据源时，Tableau 会自动创建一个嵌入式数据源作为"本地副本"。这个副本中的字段，本质上是对已发布数据源字段的引用。

**系统处理**：
系统会识别这种引用关系，将嵌入式数据源中的字段 **穿透归属** 到其所引用的已发布数据源。

```
用户操作: 在工作簿中连接"销售数据"发布数据源
     ↓
Tableau 自动生成: "销售数据"的嵌入副本
     ↓
系统穿透处理: 嵌入副本中的字段 → 归属到"销售数据"发布数据源
     ↓
最终效果: 无论从哪个入口查询，都能追溯到同一个字段定义
```

---

## 三、去重阶段：消除重复字段

### 3.1 为什么需要去重？

**重复产生的原因**：

1. **工作簿引用导致副本**：每个工作簿引用发布数据源时，都会产生一份嵌入副本
2. **字段名相同但 ID 不同**：同一个逻辑字段，在不同副本中有不同的技术 ID

**举例说明**：

```
已发布数据源"销售数据"包含字段: 订单编号、订单金额、客户名称
     ↓
工作簿 A 引用 → 产生嵌入副本，含: 订单编号(A)、订单金额(A)、客户名称(A)
工作簿 B 引用 → 产生嵌入副本，含: 订单编号(B)、订单金额(B)、客户名称(B)
     ↓
原始采集到: 9 个字段实例 (3 + 3 + 3)
     ↓
去重后: 3 个独立字段 (基于"数据源 + 字段名"判断为同一字段)
```

### 3.2 去重规则

系统按 **"数据源 + 字段名"** 组合判断是否为同一字段：

1. **先处理已发布数据源的字段**，建立基准
2. **再处理嵌入式数据源的字段**：
   - 如果穿透后的"数据源 + 字段名"已存在 → 跳过（重复）
   - 如果不存在 → 保留（工作簿特有的新字段，如临时计算字段）

### 3.3 去重效果

```
采集原始数据: 约 20,000+ 字段实例
去重跳过:     约  7,000+ 重复实例
最终入库:     12,768 个独立字段
```

---

## 四、血缘关联阶段：建立追溯链路

### 4.1 血缘追溯的目标

让用户能够回答以下问题：
- 这个字段来自哪张数据表？哪个数据库？
- 这个字段的原始列名是什么？
- 这个字段被哪些报表使用？

### 4.2 不同类型字段的追溯情况

#### 类型 A：完整追溯到物理层 (1,367 个, 10.7%)

**特征**：字段直接对应数据库中的真实物理列

**追溯链路**：
```
字段"订单编号"
    ↓
物理列 ORDER_ID (数据库原始列名)
    ↓
物理表 ORDERS (数据库真实表)
    ↓
数据库 SALES_DB
```

**产品价值**：可以完整追溯到数据来源，支持数据血缘分析

---

#### 类型 B：追溯到物理表，但列对应缺失 (1,707 个, 13.4%)

**特征**：知道来自哪张表，但无法精确到具体哪一列

**追溯链路**：
```
字段"航班班次"
    ↓
物理列 ??? (列信息缺失)
    ↓
物理表 vm_flight_history (数据库视图)
    ↓
数据库 FLIGHT_DB
```

**产生原因**：
- 数据来自 **数据库视图**（View）而非基础表
- 系统只同步基础表的列信息，不同步视图的列信息
- 因此字段的"上游列 ID"在系统中找不到对应记录

**产品影响**：知道数据来自哪张表，但无法展示原始列名

---

#### 类型 C：停留在嵌入表层面 (4,753 个, 37.2%)

**特征**：字段来自嵌入表（如 Excel 导入、自定义 SQL），无法追溯到真正的物理表

**追溯链路**：
```
字段"临时计算指标"
    ↓
嵌入表列 (虚拟定义)
    ↓
嵌入表 CustomSQL_临时查询 ← 停在这里，无法继续追溯
    ↓
??? (没有物理表信息)
```

**产生原因**：

| 嵌入表类型     | 能否追溯 | 说明                                 |
| -------------- | -------- | ------------------------------------ |
| Excel/CSV 导入 | ❌        | 文件就是数据源头，没有物理数据库     |
| 简单自定义 SQL | ⚠️ 部分   | Tableau 能解析的会提供上游表信息     |
| 复杂自定义 SQL | ❌        | Tableau 无法解析动态表名、存储过程等 |
| 虚拟连接       | ❌        | Tableau 设计上不暴露底层物理表       |

**产品影响**：只能展示嵌入表名称，无法追溯到真正的数据来源

---

#### 类型 D：无物理来源 (4,941 个, 38.7%)

**特征**：这类字段本身就没有物理数据来源

**组成分析**：

| 字段类型 | 数据源类型 | 数量  | 说明                                       |
| -------- | ---------- | ----- | ------------------------------------------ |
| 计算字段 | 发布数据源 | 3,334 | 纯公式计算生成，例如"销售额 = 数量 × 单价" |
| 普通字段 | 嵌入数据源 | 616   | 可能来自 Excel/CSV 直接导入                |
| 普通字段 | 发布数据源 | 517   | 特殊系统字段或参数                         |
| 计算字段 | 嵌入数据源 | 474   | 工作簿内的临时计算字段                     |

**追溯链路**：
```
计算字段"销售增长率"
    ↓
公式: ([本月销售] - [上月销售]) / [上月销售]
    ↓
依赖字段: 本月销售、上月销售 ← 可以追溯这些依赖字段的来源
    ↓
无直接物理表来源 (字段是计算生成的)
```

**产品影响**：可以展示公式内容和依赖的其他字段，但没有直接的物理表来源

---

## 五、血缘完整性总结

```
┌────────────────────────────────────────────────────────────────┐
│                    字段血缘完整性分布                           │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░  10.7% A类 完整追溯  │
│  ██████████████░░░░░░░░░░░░░░░░░░░░░░░░░░  13.4% B类 表级追溯  │
│  ████████████████████████████████████████  37.2% C类 嵌入层    │
│  ██████████████████████████████████████░░  38.7% D类 无来源    │
│                                                                │
└────────────────────────────────────────────────────────────────┘

解读：
- 24.1% 的字段 (A+B) 可以追溯到物理数据库表
- 37.2% 的字段 (C) 停留在嵌入表层面（受限于 Tableau 设计）
- 38.7% 的字段 (D) 本身就没有物理来源（如计算字段）
```

---

## 六、各类字段的产品展示建议

| 类型           | 可展示信息                           | 建议标记     |
| -------------- | ------------------------------------ | ------------ |
| **A类**        | 字段名、原始列名、物理表名、数据库名 | ✅ 血缘完整   |
| **B类**        | 字段名、物理表名、数据库名           | ⚠️ 列信息缺失 |
| **C类**        | 字段名、嵌入表名                     | ⚠️ 来源不完整 |
| **D类 (计算)** | 字段名、公式、依赖字段               | ℹ️ 计算字段   |
| **D类 (其他)** | 字段名、所属数据源                   | ➖ 无物理来源 |
