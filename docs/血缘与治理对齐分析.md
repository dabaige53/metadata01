# 血缘与治理对齐分析（基于 `docs/tableau_metadata_concepts.md`）

## 1. 文档定义的血缘模型（基线）

`docs/tableau_metadata_concepts.md` 中对“血缘关系”的核心约定是：血缘主要通过 3 张关联表维护：

- `table_to_datasource`：表 → 数据源
- `datasource_to_workbook`：数据源 → 工作簿
- `field_to_view`：字段 → 视图

结合实体自身的外键/包含关系（如 `database -> tables`、`workbook -> views`），可以形成主干链路：

`Database -> Table -> Datasource -> Workbook -> View`，以及细粒度使用链路：`Field -> View`。

> 备注：文档中 DBColumn/UpstreamColumns 属于更细粒度的列级追溯能力，属于“可选增强”能力，是否具备取决于同步是否写入列与映射信息。

---

## 2. 当前产品：血缘是否按文档建立（结论）

### 2.1 数据模型层（✅ 基本对齐）

后端 ORM 模型中已按文档落地 3 张关联表：

- `backend/models.py` 中存在 `table_to_datasource`、`datasource_to_workbook`、`field_to_view` 定义
- 业务实体关系也已建立：`Database`↔`DBTable`、`Workbook`↔`View`、`Datasource`↔`DBTable/Workbook`、`Field`↔`View` 等

### 2.2 数据同步层（✅ 有实现，但列级存在空洞）

同步逻辑中包含对关联表写入的实现（同步函数名与意图清晰），但从当前 `metadata.db` 的数据现状看：

- `table_to_datasource / datasource_to_workbook / field_to_view` 均有数据（主干血缘可用）
- `db_columns`（DBColumn）为空，且字段的 `upstream_column_name / upstream_column_id` 为空
  - 这意味着：**列级追溯（Field -> DBColumn）在当前数据集上不可用**

### 2.3 接口与前端展示层（✅ 已补齐并限制 2 层）

此前血缘图接口只覆盖少数类型（field/metric/datasource），且前端对所有核心资产都开放了“血缘图”Tab，会导致部分资产点击“加载血缘图”返回空/不完整。

已做对齐增强（见第 4 节“对齐落地”）：

- 血缘图支持 `database/table/datasource/workbook/view/field/metric`
- 上下游展开深度 **最多 2 层**

---

## 3. 当前产品：数据治理能力覆盖情况（对照文档）

文档中的治理场景主要包括：

1) **数据质量监控**（描述覆盖率、认证率、刷新新鲜度）

- 已具备：描述覆盖率（字段/表/数据源/工作簿等）、数据源认证率等质量概览接口与页面展示
- 可能不足：新鲜度（extract 刷新相关字段）在数据侧是否完整取决于同步数据质量

2) **影响分析**（表 → 数据源 → 工作簿 → 视图）

- 已具备：数据模型层具备链路，列表/详情接口中有基于关联表的统计与关联展示
- 本次补齐：血缘图按主干链路最多 2 层展示，便于快速影响分析

3) **指标一致性**（重复指标/相似指标）

- 已具备：重复指标识别能力（同公式分组）、指标详情中展示下游使用等
- 需要注意：当前“指标”主要基于 `CalculatedField + Field` 的实现路径，独立 `metrics` 表数据在现有库中为空

4) **安全合规**（自定义 SQL、活动警告等）

- 已具备：数据源/工作簿模型字段有 `contains_unsupported_custom_sql`、`has_active_warning` 等承载位
- 是否可用：取决于同步是否写入这些字段（数据侧）

---

## 4. 对齐落地：展示规则（上游进概览/下游进 Tab，上下最多 2 层）

### 4.1 详情页信息放置规则（✅ 已落地）

规则：

- **上游且只有一个**：放到「概览」里（减少 Tab 噪音）
- **下游**：放到 Tab 页

落地示例：

- 表（Table）：上游数据库（1 个）→ 概览
- 字段/指标（Field/Metric）：上游数据源、上游数据表（各 1 个）→ 概览；依赖字段若仅 1 个也 → 概览
- 数据源（Datasource）：上游表若仅 1 个 → 概览；多个上游表 → Tab
- 工作簿（Workbook）：上游数据源若仅 1 个 → 概览；多个上游数据源 → Tab
- 视图（View）：所属工作簿（1 个）→ 概览

### 4.2 血缘图深度限制（✅ 已落地）

- 血缘图上游/下游各最多展开 2 层（默认每层最多 10 个，可通过 `limit1/limit2` 调整但有硬上限）

---

## 5. 代码与接口变更点（便于回溯）

- 后端血缘图接口：`backend/routes/api.py` → `/api/lineage/graph/<item_type>/<item_id>`
- 前端详情抽屉：`frontend/src/components/DetailDrawer.tsx`
  - 单一上游信息移入概览
  - 对应 Tab 精简

---

## 6. 仍需确认/后续建议

1) 若要完全对齐文档中的“列级血缘追溯”：

- 需要确保同步阶段写入 `db_columns` 以及 `fields.upstream_column_*`，否则概览/血缘图只能到表级。

2) 若希望在前端直接渲染血缘图（而非仅展示 Mermaid 文本）：

- 可引入 Mermaid 渲染组件（或服务端转 SVG），并基于“最多 2 层”的限制保证性能。

