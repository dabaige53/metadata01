# Tableau 元数据治理平台 - 问题与优化行动计划

> 基于代码分析，识别当前平台存在的问题和优化点，制定行动步骤。

---

## 问题概览

| 类别 | 问题数 | 优先级 |
|------|--------|--------|
| 🔴 模型字段缺失 | 6 | P0 - 紧急 |
| 🟠 概念混淆 | 3 | P0 - 紧急 |
| 🟡 血缘关系不完整 | 4 | P1 - 重要 |
| 🔵 数据质量分析 | 3 | P1 - 重要 |
| 🟣 前端展示优化 | 5 | P2 - 一般 |
| ⚪ 测试覆盖 | 2 | P2 - 一般 |

---

## 🔴 P0: 模型字段缺失

### 问题分析

当前 `Field` 模型缺少 Tableau Metadata API 中的关键字段：

| 缺失字段 | 说明 | 数据治理用途 |
|----------|------|-------------|
| `fully_qualified_name` | 完全限定名 | 唯一标识符，血缘追溯锚点 |
| `upstream_column_name` | 原始列名 | 追溯到数据库原始字段 |
| `caption` | 显示标题 | 用户看到的名称 |
| `semantic_role` | 语义角色 | 更细分的字段分类 |
| `default_format` | 默认格式 | 数据展示格式 |
| `upstream_column_id` | 上游列ID | 关联到 DBColumn |

### 行动步骤

- [ ] **1.1** 更新 `Field` 模型，添加缺失字段
- [ ] **1.2** 更新 `tableau_sync.py` 同步逻辑，抓取新字段
- [ ] **1.3** 更新 `Field.to_dict()` 返回新字段
- [ ] **1.4** 迁移数据库 schema（新增列）
- [ ] **1.5** 更新 API 文档

---

## 🟠 P0: 概念混淆 - 字段与指标

### 问题分析

当前系统存在**字段 (Field)** 与**指标 (Metric)** 概念混淆：

1. **指标库实际是计算字段**：`/api/metrics` 返回的是 `CalculatedField`，不是独立的 `Metric` 实体
2. **Metric 表未正确使用**：`Metric` 模型存在但与 `CalculatedField` 关系不明
3. **前端展示混乱**：指标库显示所有计算字段，未区分业务指标和技术计算

### 行动步骤

- [ ] **2.1** 明确 Metric 定义：仅 `role='measure'` 且 `is_calculated=true` 的字段
- [ ] **2.2** 重构 `/api/metrics` 端点，使用正确的筛选条件
- [ ] **2.3** 前端指标库增加"业务指标"和"计算字段"分类
- [ ] **2.4** 更新文档说明两者区别

---

## 🟡 P1: 血缘关系不完整

### 问题分析

1. **Field → Column 关系缺失**：无法从 Tableau 字段追溯到数据库原始列
2. **upstreamColumns 未存储**：Metadata API 提供此字段但未同步
3. **血缘可视化缺失**：无血缘图谱功能

### 行动步骤

- [ ] **3.1** 添加 `field_to_column` 关联表
- [ ] **3.2** 同步 `upstreamColumns` 数据
- [ ] **3.3** 实现 `/api/lineage/field/{id}` 完整血缘 API
- [ ] **3.4** 前端添加血缘可视化组件（Mermaid/D3）

---

## 🔵 P1: 数据质量分析增强

### 问题分析

1. **描述覆盖率计算不准确**：未区分字段类型权重
2. **认证状态分析缺失**：Database/Table/Field 认证率未统计
3. **数据新鲜度监控不足**：仅检测 30 天未刷新的数据源

### 行动步骤

- [ ] **4.1** 增强描述覆盖率计算，按实体类型分别统计
- [ ] **4.2** 添加认证率统计 API `/api/quality/certification`
- [ ] **4.3** 增加数据新鲜度多级阈值（7天/14天/30天/90天）
- [ ] **4.4** 前端概览页添加"认证状态"卡片

---

## 🟣 P2: 前端展示优化

### 问题分析

1. **字段表格缺少原始列名显示**
2. **度量/维度图标不够直观**
3. **指标筛选器功能有限**
4. **血缘路径不可点击跳转**
5. **Column 模块未在导航中展示**

### 行动步骤

- [ ] **5.1** 字段详情页添加"原始列名"和"完全限定名"字段
- [ ] **5.2** 度量/维度使用更明显的 Badge 样式（而非小圆点）
- [ ] **5.3** 指标库添加"复杂度"和"类型"筛选器
- [ ] **5.4** 血缘路径支持点击跳转到详情
- [ ] **5.5** 导航菜单添加"数据列 (Column)" 入口

---

## ⚪ P2: 测试覆盖

### 问题分析

当前测试文件：

- `test_calc_fields.py` - 计算字段测试
- `test_tableau_metadata_api.py` - API 测试

缺少：

- 模型单元测试
- 血缘关系测试
- 数据质量计算测试

### 行动步骤

- [ ] **6.1** 添加模型 `to_dict()` 单元测试
- [ ] **6.2** 添加血缘 API 集成测试
- [ ] **6.3** 添加数据质量计算测试

---

## 同步逻辑优化

### 问题分析

`tableau_sync.py` 可能未完整同步所有 Metadata API 字段

### 行动步骤

- [ ] **7.1** 审查 GraphQL 查询，确保包含新增字段
- [ ] **7.2** 添加增量同步支持（基于 updatedAt）
- [ ] **7.3** 添加同步日志详情（各实体同步数量）

---

## API 规范化

### 问题分析

1. 部分 API 返回格式不一致
2. 缺少分页的 API（如 /databases, /tables）

### 行动步骤

- [ ] **8.1** 统一列表 API 返回格式为 `{items, total, page, page_size, total_pages}`
- [ ] **8.2** 所有列表 API 支持分页参数
- [ ] **8.3** 添加 OpenAPI/Swagger 文档

---

## 数据模型关系补全

### 问题分析

缺少以下关系：

- Field → DBColumn (upstreamColumn)
- Metric → Field (依赖字段)

### 行动步骤

- [ ] **9.1** 添加 `field_upstream_column` 关联表
- [ ] **9.2** 添加 `metric_field_dependency` 关联表
- [ ] **9.3** 同步时建立这些关系

---

## 验证计划

### 自动化测试

| 测试项 | 命令 | 说明 |
|--------|------|------|
| 现有测试 | `python -m pytest test_tableau_metadata_api.py` | 验证 API 基本功能 |
| 计算字段测试 | `python -m pytest test_calc_fields.py` | 验证计算字段逻辑 |

### 手动验证

1. **模型字段验证**：启动服务后调用 `/api/fields` 检查新字段是否返回
2. **血缘验证**：调用 `/api/lineage/field/{id}` 检查是否包含 upstreamColumn
3. **前端验证**：访问 `http://localhost:8001` 检查界面显示

---

## 行动优先级排序

| 优先级 | 行动项 | 预计工作量 |
|--------|--------|-----------|
| **P0** | 1.1-1.5 模型字段补全 | 2 天 |
| **P0** | 2.1-2.4 概念区分 | 1 天 |
| **P1** | 3.1-3.4 血缘关系 | 2 天 |
| **P1** | 4.1-4.4 数据质量 | 1 天 |
| **P2** | 5.1-5.5 前端优化 | 2 天 |
| **P2** | 6.1-6.3 测试覆盖 | 1 天 |
| **P2** | 7.1-7.3 同步优化 | 1 天 |
| **P2** | 8.1-8.3 API 规范 | 1 天 |
| **P2** | 9.1-9.3 关系补全 | 1 天 |

**总计：约 12 天工作量**

---

## 用户审核要求

> [!IMPORTANT]
> 请审核以上行动计划，确认优先级排序和行动步骤是否符合预期。如需调整或补充，请反馈。
